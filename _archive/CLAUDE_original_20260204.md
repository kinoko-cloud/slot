# Slot Recommendation Site - CLAUDE.md

## 🔄 セッション引き継ぎ

**「続き」や作業指示があったら：**
1. このファイル (`CLAUDE.md`) を読む
2. `memory/` の最新日付ファイルを読む（作業ログ）
3. `git log --oneline -5` で直近の変更を確認
4. `git remote -v` でリモート構成を確認
5. `.git/config` でアカウント設定を確認
6. `~/.openclaw/workspace/memory/` でWhatsApp側の作業ログを確認

**重要**: memoryファイルには一部しか記録されない。git設定やプロジェクト構成も必ず確認すること。

**作業終了時：**
- 重要な変更は `memory/YYYY-MM-DD.md` に書き出す
- 新しいルールや仕様はこのファイルに追記

---

## 📋 プロジェクト概要

スロット台のおすすめ表示サイト（静的HTML生成）

- **ディレクトリ**: `/home/riichi/works/slot`
- **ビルド**: `python3 scripts/generate_static.py`
- **出力**: `docs/index.html` 等
- **デプロイ**: GitHub Pages（push で自動）

---

## ⚠️ 絶対ルール

### 1. 「設定X」は使わない
- ❌ 「設定6」「設定1」等の表記は禁止
- ✅ 代わりに「機械割125.5%」「機械割97%」等を使う
- 理由: 設定は確認不可能、機械割は確率から推定可能

### 2. 確率は整数表示
- ❌ `1/227.818` 
- ✅ `1/227`
- テンプレートでは `|int` フィルタ、Pythonでは `int()` を使う

### 3. 連チャン表示は最後の行
- 「X連」は連チャンの**最後の当たり**（chain_pos == chain_len）に表示
- 降順表示（上が最新）なので、連チャン結果が上に見える

### 4. 好調/不調は確率ベース
- `consecutive_bad`（確率ベース）を使う
- `consecutive_minus`（差枚ベース）は「連続不調」判定に使わない
- 差枚がマイナスでも確率が良ければ「好調」

### 5. データの整合性
- art_count, rensa, diff_medals は同じソースから取得
- 古いデータ（stale）と新しいデータを混ぜない

---

## 🏗️ アーキテクチャ

```
analysis/
  recommender.py    # 推薦ロジック（recommend_units）
  analyzer.py       # 分析関数群
  
scripts/
  generate_static.py  # 静的HTML生成（メイン）
  post_build_check.py # ビルド後検証
  enrich_rec.py       # rec補完処理

web/templates/
  index.html         # メインページ
  verify.html        # 答え合わせページ
  recommend.html     # 店舗別ページ

data/
  daily/             # 日次スナップショット
  history/           # 蓄積履歴データ
```

---

## 🌐 環境構成

### GitHubアカウント（2つ）
| リモート | SSHエイリアス | 用途 |
|---------|--------------|------|
| origin | `github.com` | メイン（デプロイ） |
| secondary | `github-twiakaid` | 分散用（GitHub Actions無料枠分散） |

### SSHキー構成
| キーファイル | 対象アカウント | 用途 |
|-------------|---------------|------|
| `~/.ssh/id_ed25519` | origin（メイン） | `git@github.com` |
| `~/.ssh/id_ed25519_twiakaid` | secondary（twiakaid-hash） | `git@github-twiakaid` |

設定ファイル: `~/.ssh/config`

### CI/CD構成
- **GitHub Actions (origin)**: デプロイ、静的サイト生成
- **GitHub Actions (secondary)**: 軽いスクレイピング
- **Circle CI (secondary)**: Playwright重い処理（fetch-availability, daily-collect）

Circle CI設定: `.circleci/config.yml`
- `hourly-fetch`: 1時間ごと（10:00-23:00 JST）
- `daily-collection`: 毎日23:00 JST

### OpenClaw連携
- ワークスペース: `~/.openclaw/workspace/`
- slotリンク: `~/.openclaw/workspace/slot` → `/home/riichi/works/slot`
- WhatsApp作業ログ: `~/.openclaw/workspace/memory/YYYY-MM-DD.md`

---

## 🔧 よく使うコマンド

```bash
# ビルド
cd /home/riichi/works/slot
python3 scripts/generate_static.py

# テスト（特定店舗）
python3 -c "
import sys, os; sys.path.insert(0,'.'); os.environ['SLOT_BASE_DIR'] = os.getcwd()
from analysis.recommender import recommend_units
recs = recommend_units('shinjuku_espass_hokuto')
for r in sorted(recs, key=lambda x: -x.get('final_score',0))[:5]:
    print(r)
"

# コミット＆プッシュ
git add -A && git commit -m "説明" && git push
```

---

## 🎰 機種仕様

### SBJ（スマスロ北斗の拳）
- 天井: 999G+α（通常時）
- RBではゲーム数天井がリセットされない
- リセット時天井短縮: 666G+α
- 好調閾値: 1/130以下

### 北斗の拳 転生2
- あべし天井システム（G数≠あべし、G数ベース天井判定は参考値）
- モードA天井: 1536あべし
- モードB天井: 896あべし  
- モードC天井: 576あべし
- 天国天井: 128あべし
- 天撃失敗後は絶対にやめない（モード移行の可能性）
- 好調閾値: 1/120以下

---

## 📝 memory/ ファイル

日次の作業ログ。OpenClaw workspace側（`~/.openclaw/workspace/memory/`）にも保存。

---

*最終更新: 2026-02-02*

## 台変動の概念

### 台移動
- 機種の台番号が変わる → 過去データ紐づけ不可（シャッフル）
- 店の傾向・機種のクセは同じだが、台個別データは仕切り直し

### 減台
- 一部が歯抜けになる。残った台は継続
- なくなった台は他機種になる → その新機種を追加しないと意味がない

### 増台
- 取得対象が増える
- 台移動とセットの場合あり → 実質シャッフル

### 撤去
- 機種自体が全部なくなる → 取得先消滅

### 検出ロジック
- `scripts/verify_units.py` で実装済み
- configにある台番号だがデータが取れない → 減台・撤去の可能性
- configにない台番号でデータが取れた → 増台の可能性
- 全台のデータが取れない → 機種撤去 or サイト障害
- **検出後のRSさんへの通知が未実装**（要対応）

## オンデマンド取得（ページ閲覧時のリアルタイムデータ取得）

### 仕組み（実装済み）
```
閲覧者がページ開く
  → realtime.js が PythonAnywhere API を呼ぶ
  → /api/scrape/<store_key> でバックグラウンドスクレイピング開始
  → recommend.html でプログレスバー表示（「データ取得中」）
  → /api/scrape_status/<store_key> でポーリング（1秒間隔）
  → 完了 → 最新データでUI更新 or location.reload()
  → 以後 3-5分間隔で自動更新
```

### 関連ファイル
- `web/static/realtime.js` - クライアント側リアルタイム取得
- `web/app.py` - Flask APIサーバー（/api/scrape, /api/scrape_status）
- `scrapers/availability_checker.py` - データ取得ロジック

### 動作確認
- PythonAnywhere API: https://autogmail.pythonanywhere.com
- 確認コマンド: `curl "https://autogmail.pythonanywhere.com/api/scrape_status/shibuya_espass_sbj"`

### 注意
- WSLが停止していてもPythonAnywhereで動作する
- ただし蓄積データ（history）は別途GitHub Actionsで更新が必要

## UI/レイアウト変更の仕様

### 1. マクロ/テンプレート化
- 表記方法の指摘があった場合、同じ形態で記述されている箇所は**全体をマクロ化**する
- 1箇所変更で全部直るようにする
- 例: `unit_store_label()` マクロ

### 2. CSS最適化
- レイアウト変更時に**古いCSSが残らないようにする**
- 同じ見せ方のものは最適化して統一
- 目先の修正で前のが残ってレイアウト崩れが起きないよう注意

### 3. バックアップ
- **数バージョン前のレイアウトは残す**（戻しやすいように）
- CSSの古いクラスは `_archive/css/` に退避
- テンプレートの古いバージョンは `_archive/templates/` に退避
- git履歴でも追えるが、明示的なバックアップも用意

### 4. 変更時のチェックリスト
1. 同じパターンが他にないか検索
2. あればマクロ化
3. 古いCSS/クラスを整理
4. 必要に応じてバックアップ作成
5. 全ページで表示確認

### 5. CSS整理のタイミング
- ページの表記指摘→修正を繰り返す間は整理しない
- **ページが確定した時点**でCSS整理を行う
- 整理内容: 重複削除、未使用削除、セクション分け

## データソース異常時の対策

### 背景
- 2026/1/30-2/1: 渋谷エスパス新館のDAIDATAが更新停止
- これが原因でpost_build_checkが失敗 → Actions全体が停止

### 対策
1. **店舗単位でスキップ**: 1店舗が古くても他は処理続行
2. **異常検知アラート**: 3日以上更新なし → WhatsApp通知
3. **UI警告表示**: 古いデータの店舗に「⚠️ データ更新停止中」表示
4. **post_build_check**: 警告のみ（exit(1)しない）← 修正済み

## データ欠損時の仕様

### アラート（WhatsApp通知）
- 3日以上更新なしで通知
- **原因を切り分けて伝える**:
  - データソース元の問題（DAIDATA/PAPIMOが更新停止）
  - システムの問題（GitHub Actions/PythonAnywhere失敗）

### おすすめ/予測の扱い
| データ状況 | 対応 |
|------------|------|
| 当日データあり | 通常通りおすすめ表示 |
| 当日なし・前日あり | 「⚠️ 本日データ未取得」注記付きで表示 |
| **前日も当日もなし** | **おすすめから除外**（根拠がないため） |

### サイト表示
- 除外された店舗/台には「データ取得停止中」表示
- 最終更新日を明記
- ランキングからも除外

### 検証ページ
- データ欠損期間の予測は検証対象から除外
- 「データ欠損のため検証スキップ」と記録

## 台番号変更・減台時の対応

### 発生パターン
- 台番号が変わる（移設、配置変更）
- 減台（撤去）
- 増台（新設）

### 対応方針
1. **古いデータ**: 履歴として保持（削除しない）
2. **新しい台番号**: 新規として追跡開始
3. **同一台追跡**: しない（物理的な同一台かどうかは判断不可）

### 見失った時の探索
```bash
# PAPIMO: 一覧ページから現在の台番号を自動取得
python scrapers/papimo.py discover
```

### 更新履歴
- 2026-02-02: Island秋葉原 北斗
  - 旧: 0731-0738, 0750-0757（16台）
  - 新: 0811-0818, 0820-0825（14台、2台減）

### 「データが取れない」時の確認順序
1. **台構成が変わった？** ← 最初に疑う
2. データソースの問題？
3. システムの問題？

### 表記の区別
| 状況 | 表記 | 意味 |
|------|------|------|
| 台番号変更 | 「⚠️ 台番号変更のため予測精度低」 | 既存台が移動/配置変更 |
| 新規台 | 「🆕 新規台」 | 店に新しく導入された台 |

### 古いデータの活用
- 古い台番号のデータは**削除しない**
- **店の傾向分析**に使用（店のクセは台番号が変わっても継続）

## 実装前チェックリスト

### 表記/UI変更時
- [ ] 同じ表記が他にないか検索したか？
- [ ] マクロ化すべきか？
- [ ] CSSクラスは既存を使えるか？

### データ取得エラー時
- [ ] まず台構成（台番号変更/減台）を疑ったか？
- [ ] データソース元の問題か確認したか？
- [ ] システムの問題か確認したか？

### 新機能追加時
- [ ] 既存パターンと統一すべきか？
- [ ] 仕様として記録したか？
- [ ] 他ページへの影響は？

### コミット前
- [ ] 今日決めた仕様を適用したか？
- [ ] 言われる前に自分で気づくべきことはなかったか？

### 運用ルール
1. **実装開始時**: チェックリストを読み、RSさんに報告
2. **報告内容**: 「📋 チェックリスト確認しました」+ 該当項目と対応
3. **該当なし**: 「該当項目なし」と報告
4. **引っかかった項目**: 何をどう対応するか明記

## 日付表記の仕様

### ルール
| 時間帯 | 表記 | 表示する予測 |
|--------|------|-------------|
| 22:50〜23:59 | 「明日の予想」 | 翌営業日 |
| 0:00〜9:59 | 「本日の予想」 | 当日（=前日23時台と同じ日） |
| 10:00〜22:49 | 「本日の予想」 | 当日 |

### 重要
- 日付が変わっても**同じ営業日の予測**が継続表示される
- 表記（明日→本日）だけが変わる
- これはシステムとして実装する（手動修正ではない）

## 答え合わせの仕様

### ルール
- **データが揃っていない場合はスキップ**
- 全店舗のデータが取得できていることを確認してから実行
- 不完全なデータで答え合わせを出さない
