# CLAUDE.md（最適化版）

> 📦 **完全版バックアップ**: `_archive/CLAUDE_original_20260204.md`
> トラブル時や情報が足りない場合は、上記の完全版を参照してください。

> 📚 **関連ドキュメント**:
> - `ARCHITECTURE.md` - コードベース全体マップ
> - `WORKFLOW.md` - 開発フロー、コマンド集

このファイルには、**Claudeが推測できない情報**のみを記載します。

---

## 🔄 セッション引き継ぎ

**「続き」や作業指示があったら：**
1. このファイル (`CLAUDE.md`) を読む
2. `memory/` の最新日付ファイルを読む（作業ログ）
3. `git log --oneline -5` で直近の変更を確認
4. `ARCHITECTURE.md` でコードベース全体を確認（必要に応じて）
5. `WORKFLOW.md` でコマンド・フローを確認（必要に応じて）

**作業終了時：**
- 重要な変更は `memory/YYYY-MM-DD.md` に書き出す
- 新しいルールや仕様はこのファイルに追記

---

## ⚠️ 絶対ルール（推測不可能な情報）

### 1. 「設定X」は使わない
- ❌ 「設定6」「設定1」等の表記は禁止
- ✅ 代わりに「機械割125.5%」「機械割97%」等を使う
- 理由: 設定は確認不可能、機械割は確率から推定可能

### 2. 確率は整数表示
- ❌ `1/227.818`
- ✅ `1/227`
- テンプレートでは `|int` フィルタ、Pythonでは `int()` を使う

### 3. 連チャン表示は最後の行
- 「X連」は連チャンの**最後の当たり**（chain_pos == chain_len）に表示
- 降順表示（上が最新）なので、連チャン結果が上に見える

### 4. 好調/不調は確率ベース
- `consecutive_bad`（確率ベース）を使う
- `consecutive_minus`（差枚ベース）は「連続不調」判定に使わない
- 差枚がマイナスでも確率が良ければ「好調」

### 5. データの整合性
- art_count, rensa, diff_medals は同じソースから取得
- 古いデータ（stale）と新しいデータを混ぜない

---

## 🎰 機種仕様（推測不可能）

### SBJ（スマスロ北斗の拳）
- 天井: 999G+α（通常時）
- RBではゲーム数天井がリセットされない
- リセット時天井短縮: 666G+α
- 好調閾値: 1/130以下

### 北斗の拳 転生2
- あべし天井システム（G数≠あべし、G数ベース天井判定は参考値）
- モードA天井: 1536あべし
- モードB天井: 896あべし
- モードC天井: 576あべし
- 天国天井: 128あべし
- 天撃失敗後は絶対にやめない（モード移行の可能性）
- 好調閾値: 1/120以下

---

## 🔧 台変動の概念（推測不可能）

### 台移動
- 機種の台番号が変わる → 過去データ紐づけ不可（シャッフル）
- 店の傾向・機種のクセは同じだが、台個別データは仕切り直し

### 減台
- 一部が歯抜けになる。残った台は継続
- なくなった台は他機種になる

### 増台
- 取得対象が増える
- 台移動とセットの場合あり → 実質シャッフル

### 撤去
- 機種自体が全部なくなる → 取得先消滅

### 検出ロジック
- `scripts/verify_units.py` で実装済み
- configにある台番号だがデータが取れない → 減台・撤去の可能性
- configにない台番号でデータが取れた → 増台の可能性

### 対応方針
1. **古いデータ**: 履歴として保持（削除しない）
2. **新しい台番号**: 新規として追跡開始
3. **同一台追跡**: しない（物理的な同一台かどうかは判断不可）

### 「データが取れない」時の確認順序
1. **台構成が変わった？** ← 最初に疑う
2. データソースの問題？
3. システムの問題？

---

## ⏰ 時間帯別の表示モード（推測不可能）

| 時間帯 | モード | 動作 |
|--------|--------|------|
| 10:00〜22:49 | 営業中 | リアルタイム予測（PythonAnywhere） |
| 22:50〜22:59 | 集計中 | 「集計中」メッセージ表示 |
| 23:00〜翌9:59 | 結果 | 静的HTML（Cloudflare Pages） |

### 日付表記の仕様
| 時間帯 | 表記 | 表示する予測 |
|--------|------|-------------|
| 22:50〜23:59 | 「明日の予想」 | 翌営業日 |
| 0:00〜9:59 | 「本日の予想」 | 当日（=前日23時台と同じ日） |
| 10:00〜22:49 | 「本日の予想」 | 当日 |

**重要**: 日付が変わっても同じ営業日の予測が継続表示される。これはシステムとして実装する。

---

## 🛡️ データソース異常時の対策（推測不可能）

### おすすめ/予測の扱い
| データ状況 | 対応 |
|------------|------|
| 当日データあり | 通常通りおすすめ表示 |
| 当日なし・前日あり | 「⚠️ 本日データ未取得」注記付きで表示 |
| **前日も当日もなし** | **おすすめから除外**（根拠がないため） |

### アラート（WhatsApp通知）
- 3日以上更新なしで通知
- 原因を切り分けて伝える:
  - データソース元の問題
  - システムの問題

---

## 🎨 UI/レイアウト変更の仕様（推測不可能）

### 1. マクロ/テンプレート化
- 表記方法の指摘があった場合、同じ形態で記述されている箇所は**全体をマクロ化**する
- 1箇所変更で全部直るようにする

### 2. CSS最適化
- レイアウト変更時に**古いCSSが残らないようにする**
- 同じ見せ方のものは最適化して統一

### 3. バックアップ
- **数バージョン前のレイアウトは残す**（戻しやすいように）
- CSSの古いクラスは `_archive/css/` に退避
- テンプレートの古いバージョンは `_archive/templates/` に退避

### 4. CSS整理のタイミング
- ページの表記指摘→修正を繰り返す間は整理しない
- **ページが確定した時点**でCSS整理を行う

---

## 📋 実装前チェックリスト（推測不可能）

### 表記/UI変更時
- [ ] 同じ表記が他にないか検索したか？
- [ ] マクロ化すべきか？
- [ ] CSSクラスは既存を使えるか？

### データ取得エラー時
- [ ] まず台構成（台番号変更/減台）を疑ったか？
- [ ] データソース元の問題か確認したか？
- [ ] システムの問題か確認したか？

### 新機能追加時
- [ ] 既存パターンと統一すべきか？
- [ ] 仕様として記録したか？
- [ ] 他ページへの影響は？

### コミット前
- [ ] 今日決めた仕様を適用したか？
- [ ] 言われる前に自分で気づくべきことはなかったか？

### 運用ルール
1. **実装開始時**: チェックリストを読み、RSさんに報告
2. **報告内容**: 「📋 チェックリスト確認しました」+ 該当項目と対応
3. **該当なし**: 「該当項目なし」と報告
4. **引っかかった項目**: 何をどう対応するか明記

---

## 🧪 テスト・検証（推測不可能）

### 自己チェックの方法

作業後、Claudeは以下で自己検証すること：

```bash
# 全テスト実行
bash tests/run_all_tests.sh
```

**期待される出力**: `tests/expected_outputs/` のサンプルを参照

### 答え合わせの仕様
- **データが揃っていない場合はスキップ**
- 全店舗のデータが取得できていることを確認してから実行
- 不完全なデータで答え合わせを出さない

---

**最終更新:** 2026-02-04
