# プロジェクト情報

## 自動デプロイ
- GitHub Actionsで `main` ブランチにpushすると自動でPythonAnywhereにデプロイ
- URL: https://autogmail.pythonanywhere.com/

## 利用可能な環境

| 環境 | 種類 | 主な用途 |
|------|------|----------|
| ValueDomain レンタルサーバー | 共用サーバー | PHP、MySQL、静的サイト |
| Google Apps Script (GAS) | サーバーレス | スプレッドシート連携、自動化 |
| PythonAnywhere（無料） | PaaS | Python Webアプリ、スクリプト実行 |
| GitHub Pages | 静的ホスティング | 静的サイト（候補） |
| Vercel / Netlify | サーバーレス | 静的サイト＋API（候補） |

## WSL環境
- パスワード: WSLセットアップ時に設定済み（sudoコマンドで使用）

## プロジェクト概要
- プロジェクト名: slot
- 目的: パチスロデータ収集・分析による良台予想ツール

## 対象
- パチスロのみ（パチンコは対象外）

## 収集データ
- 店舗名、機種名、日付、台番号
- BB、RB、AT、ART回数
- 累計スタート数（総回転数/総プレイ数）
- 各あたりのログ（ハマり回数）
- 差枚（出玉差）
- 最大メダル数（最大持ちコイン）
- 攻略サイトから設定ごとの確率
- 天井情報

## 良台判定基準（SBJの場合）
- 毎日のART回数が多い台 → 高設定の可能性
- 総スタート数（稼働量）
- 差枚プラス
- 最大メダル数

## 分析したい傾向
- 店舗ごとの設定投入傾向（どの日に入れるか）
- 機種ごとの扱い（力を入れている機種か）
- 特定台番号の傾向（角台、末尾など）

## 練習対象（3店舗・1機種）
| 店舗 | 備考 |
|------|------|
| 渋谷エスパス新館 | SBJ 3台のみ |
| 新宿エスパス（複数店舗） | |
| 秋葉原アイランド | |

### 練習機種: スーパーブラックジャック（SBJ）
- ARTとARTの間の回転数 = スタート数（試行回数）
- BB/RBはカウントしない
- 天井: 999+α

### SBJ詳細仕様

#### 天井システム
| 天井種類 | 条件 | 恩恵 |
|----------|------|------|
| ゲーム数天井 | 999G+α消化 | BIG濃厚 |
| RBスルー天井 | BB間でRB4回成立（5回目） | BIG濃厚 |
| スイカ天井 | 斜めスイカ規定回数到達（10～100回） | ストックタイム直撃 |

#### 天井リセット条件
| 条件 | ゲーム数天井 | RBスルー天井 | スイカ天井 |
|------|--------------|--------------|------------|
| RB当選 | **リセットされない** | カウント+1 | リセットされない |
| BB当選 | リセット | リセット | リセットされない |
| ST当選 | - | リセット | 有利区間リセット時のみ |

※**重要**: RBではゲーム数天井がリセットされない（BB間で引き継ぐ）

#### リセット（設定変更）時の恩恵
- ゲーム数天井: 999G+α → **666G+α**に短縮
- スイカ天井: 規定回数が優遇（約30%で30回以下、約60%で40回以内）
- 電源OFF/ON（据え置き）: 天井引き継ぎ（恩恵なし）

#### 設定差
| 項目 | 設定1 | 設定6 |
|------|-------|-------|
| 機械割 | 97.8% | 112.7% |
| ボーナス初当り | 1/241.7 | 1/181.3 |
| 斜めスイカ確率 | 1/99.9 | 1/83.9 |
| スイカからST直撃 | 0.4% | 1.6% |
| ボーナス高確移行率 | 1/114.7 | 1/90.3 |

---

### 北斗の拳 転生の章2（北斗転生2）詳細仕様

#### 天井システム（あべし天井）
| モード | 天井あべし | ゲーム換算目安 |
|--------|------------|----------------|
| モードA | 1536あべし | 約750G |
| モードB | 896あべし | 約450G |
| モードC | 576あべし | 約290G |
| 天国 | 128あべし | 約65G |

※リセット時: 最大1280あべしに短縮

#### ゾーン期待度
- **193～256あべし**: 全モード共通チャンスゾーン
- **513～576あべし**: モードC天井
- **833～896あべし**: モードB天井

#### 設定差
| 項目 | 設定1 | 設定6 |
|------|-------|-------|
| 機械割 | 97.6% | 114.9% |
| AT初当り | 1/366.0 | 1/273.1 |
| 天破の刻突入率 | 1/100.2 | 1/81.3 |
| 弱チェリー→高確移行 | 0.8% | 4.7% |
| スイカ→高確移行 | 1.6% | 7.8% |

#### やめどき（重要）
- **天撃失敗後は絶対にやめない**: 次回天国モード濃厚（128あべしまでフォロー）
- **あべしUI赤色**: 天国モード濃厚なので即やめ厳禁

## データソース

### 台データオンライン (daidata.goraggio.com)
| 店舗 | hall_id | SBJ台数 | URL |
|------|---------|---------|-----|
| 渋谷エスパス新館 | 100860 | 3台 | https://daidata.goraggio.com/100860 |
| 新宿エスパス歌舞伎町 | 100949 | 4台 | https://daidata.goraggio.com/100949 |
| 秋葉原エスパス駅前 | 100928 | 4台 | https://daidata.goraggio.com/100928 |
| マルハン新宿東宝ビル | 203505 | 5台 | https://daidata.goraggio.com/203505 |
| 楽園渋谷駅前 | 203478 | 2台 | https://daidata.goraggio.com/203478 |
| 渋谷エスパス本館 | 100930 | - | https://daidata.goraggio.com/100930 |
| 高田馬場エスパス本店 | 100915 | - | https://daidata.goraggio.com/100915 |
| 西武新宿駅前エスパス | 100950 | - | https://daidata.goraggio.com/100950 |

- データ: 7日分、スタート数、確率、グラフ
- 特徴: ホールコンピュータ直結、最も詳細
- 課題: API無し、スライド切替・広告ポップアップあり
- スクレイピング: Selenium/Playwright必要

### スロレポ (slorepo.com)
- 渋谷エスパス新館: https://www.slorepo.com/hole/e382a8e382b9e38391e382b9e697a5e68b93e6b88be8b0b7e9a785e5898de696b0e9a4a8code/
- 秋葉原アイランド: https://www.slorepo.com/hole/e382a2e382a4e383a9e383b3e38389e7a78be89189e58e9fe5ba97code/
- SBJランキング: https://www.slorepo.com/ranking/kishu/?kishu=スマスロ+スーパーブラックジャック
- データ: 累計差枚、平均G数、勝率、機種別・台番別集計
- 特徴: 静的HTML、スクレイピングしやすい

### アナスロ (ana-slo.com)
- マルハン新宿東宝データあり
- 例: https://ana-slo.com/2026-01-25-%e3%83%9e%e3%83%ab%e3%83%8f%e3%83%b3%e6%96%b0%e5%ae%bf%e6%9d%b1%e5%ae%9d%e3%83%93%e3%83%ab%e5%ba%97-data/
- ※403エラーになることあり

### デルタネット (d-deltanet.com)
- 楽園渋谷道玄坂: https://www.d-deltanet.com/pc/D0301.do?pmc=22021014&clc=03&urt=2173&pan=1
- 楽園渋谷駅前: https://www.d-deltanet.com/pc/D2301.do?pmc=22021029&clc=03&urt=2173&mdc=120343&bn=1

### 攻略サイト（機種情報）
- P-WORLD: https://www.p-world.co.jp/machine/database/10174
- 設定別確率、天井情報など

### データ遡り期間
- 台データオンライン: 7日
- スロレポ: 約1ヶ月（累計）

## 開発進捗

### 完了
- [x] スロレポスクレイパー作成（scrapers/slorepo.py）
- [x] 月間データ・日別データの取得に成功
- [x] JSONファイルへの保存機能
- [x] 台データオンラインスクレイパー作成（scrapers/daidata_detail_history.py）
  - 渋谷エスパス新館のSBJ 3台（3011, 3012, 3013）対応
  - 7日分の詳細履歴取得（各当たりの回転数、時間、獲得メダル）
  - 規約同意ページ、広告除去対応済み
- [x] papimo.jpスクレイパー作成（scrapers/papimo.py）
  - 秋葉原アイランドのSBJ 14台対応
  - 14日分の詳細履歴取得
  - 日付セレクター操作による過去データ取得
- [x] 良台分析システム作成（analysis/analyzer.py）
  - 評価指標: ART確率、稼働量、初当たり時間、閉店時間、飛び飛び稼働
  - 稼働不足でもART確率が良ければ救済するロジック
  - 総合評価（A/B/C/Dランク）
- [x] リアルタイム台選びWebアプリ作成（web/app.py）
  - iPhoneからアクセス可能なモバイル対応UI
  - 過去データ（静的ランキング）+ 当日リアルタイムデータで推奨
  - プログレスバー付きローディング画面
  - ngrok経由で外部アクセス可能

### データ取得状況（2026/1/26時点）
| 店舗 | 台数 | 今月累計 | 詳細データ | 状態 |
|------|------|----------|------------|------|
| 秋葉原アイランド | 14台 | +106,330枚 | ✓ 14日分 | ✓ |
| 渋谷エスパス新館 | 3台 | +1,932枚 | ✓ 7日分 | ✓ |
| 新宿エスパス歌舞伎町 | 4台 | -10,640枚 | - | △ |

### SBJ台番号
| 店舗 | 台番号 |
|------|--------|
| 渋谷エスパス新館 | 3011, 3012, 3013 |
| 新宿エスパス歌舞伎町 | 682, 683, 684, 685 |
| 秋葉原アイランド | 1015, 1016, 1017, 1018, 1020, 1021, 1022, 1023, 1025, 1026, 1027, 1028, 1030, 1031 |

### 北斗転生2 台番号
| 店舗 | 台数 | 台番号 | データソース |
|------|------|--------|--------------|
| 渋谷エスパス新館 | 30台 | 2046-2067, 2233-2240 | daidata |
| 新宿エスパス歌舞伎町 | 41台 | 1-37, 125-128 | daidata |
| 秋葉原エスパス駅前 | 22台 | 2011-2019, 2056-2068 | daidata |
| アイランド秋葉原 | 14台 | 0731-0738, 0750-0757 | papimo |
| マルハン新宿東宝ビル | 35台 | 要取得 | ana-slo |
| 楽園渋谷駅前 | 21台 | 要取得 | d-deltanet |

### 分析結果（2026/1/26時点）
| 順位 | 台 | 店舗 | 評価 | 平均スコア | 7日ART合計 | 7日G数 |
|------|-----|------|------|------------|------------|--------|
| 1 | 1023 | アイランド秋葉原 | A | 80.7 | 497回 | 46,779G |
| 2 | 1030 | アイランド秋葉原 | A | 77.9 | 416回 | 48,106G |
| 3 | 1025 | アイランド秋葉原 | A | 77.1 | 388回 | 44,368G |
| 4 | 1017 | アイランド秋葉原 | A | 75.0 | 488回 | 46,309G |
| ... | ... | ... | ... | ... | ... | ... |
| 13 | 3012 | 渋谷エスパス新館 | A | 70.0 | 208回 | 17,112G |
| 14 | 3011 | 渋谷エスパス新館 | A | 69.3 | 198回 | 14,999G |
| 17 | 3013 | 渋谷エスパス新館 | B | 62.1 | 192回 | 16,459G |

### 店舗別サマリー
| 店舗 | 平均稼働 | 平均スコア | 台数 | 推奨 |
|------|----------|------------|------|------|
| アイランド秋葉原 | 5,944G/日 | 73.9 | 14台 | ★ |
| 渋谷エスパス新館 | 2,313G/日 | 67.1 | 3台 | |

### 使い方

```bash
# 仮想環境を有効化
source .venv/bin/activate

# --- デイリーバッチ（前日までのデータ取得）---
# 渋谷エスパスのデータ取得
python scrapers/daidata_detail_history.py

# 秋葉原アイランドのデータ取得
python scrapers/papimo.py

# 全店舗の比較分析
python analysis/compare_all.py

# --- リアルタイム予測（営業中の台選び）---
# 当日データ取得 + 予測
python scrapers/realtime_scraper.py

# 予測のみ（既存データ使用）
python analysis/realtime_predictor.py

# --- Webアプリ（iPhoneからアクセス）---
# サーバー起動
python web/app.py

# 別ターミナルでngrokトンネル作成
ngrok http 5000

# iPhoneでngrokのURLにアクセス
# → 店舗選択 → 「最新取得」ボタンでリアルタイムデータ取得
```

### リアルタイム予測システム

営業中の台選びをサポート:
1. **過去データ**: 台の実力評価（過去7-14日の平均）
2. **当日稼働**: 未稼働・低稼働台の発見
3. **当たり時間**: 朝から稼働 = 誰かが狙っている可能性
4. **隠れ高設定**: 低稼働だがART確率良好な台

### データ蓄積ワークフロー

```bash
# 毎日実行（閉店後）- 当日データを収集
python scripts/daily_collect.py

# 週次など - 過去データを統合して長期分析用データ作成
python scripts/daily_collect.py --merge
```

データ保存先:
- `data/daily/` - 日別収集データ
- `data/merged/` - 統合データ（長期分析用）
- `data/raw/` - 一時データ

### 未完了
- [ ] 新宿エスパス、秋葉原エスパス、新宿マルハン、渋谷楽園の追加（離席時に対応）
- [ ] 攻略サイトから設定確率・天井情報取得
- [ ] 定期実行の自動化（cron or PythonAnywhere）
- [ ] SBJリセット時の短縮天井情報の組み込み

## 評価ロジック詳細（改良版）

### 最重要指標: 軽い当たり率（200G以下でATに当たる割合）
| 軽い当たり率 | 評価 | 加点 |
|-------------|------|------|
| 95%以上 | ★★★ 高設定濃厚 | +30 |
| 90%以上 | ★★ 高設定可能性高 | +20 |
| 85%以上 | ★ まずまず | +10 |
| 70%未満 | 低設定の可能性 | -15 |

### 平均G数（AT間）
| 平均G数 | 評価 | 加点 |
|---------|------|------|
| 40G以下 | ★★ 非常に軽い | +20 |
| 60G以下 | ★ 軽い | +10 |
| 120G以上 | 重い | -10 |

### 天井到達（999G以上）
| 天井率 | 評価 | 加点 |
|--------|------|------|
| 0回 | 理想 | +10 |
| 全AT中1%未満 | 高設定でもありえる | +5 |
| 1-3% | やや注意 | -5 |
| 3%以上 | 問題あり | -15 |

※高設定でも天井1回程度はありえる。繰り返しが問題。

### 深ハマ率（500G以上）
| 深ハマ率 | 評価 | 加点 |
|----------|------|------|
| 2%以下 | 優良 | +5 |
| 5%以上 | 注意 | -10 |

### 稼働量（データ信頼性）
- 30,000G以上: +5（信頼度高）
- 10,000G未満: -10（データ少）

### 総合評価
- S (95+): 高設定濃厚
- A (80+): 高設定の可能性高い
- B (65+): まずまず
- C (50+): 普通
- D (<50): 低設定の可能性

## メモ
- スロレポは静的HTMLでスクレイピング容易
- 台データオンラインはJS動的でPlaywright必要
- papimo.jpは日付セレクターをPlaywrightで操作
- Playwright依存: libnspr4, libnss3, etc.

---

## リアルタイムデータ取得機能（2026/1/26完成）

### 概要
営業中にリアルタイムでART回数・空席を確認する機能。

### アーキテクチャ
```
[GitHub Actions] → [data/availability.json] → [PythonAnywhere App]
      ↓                       ↓
  Playwright          GitHub raw URL
  (10分ごと)           (無料プラン対応)
```

### PythonAnywhere無料プランの制限と対策
**問題**: 無料プランではホワイトリスト外のサイト（daidata.goraggio.com）に直接アクセス不可（403 Forbidden）

**解決策**: GitHub Actions経由でデータ取得
1. GitHub Actions (ubuntu-latest) でPlaywrightを実行
2. `data/availability.json`にコミット
3. PythonAnywhereはGitHub raw URLからJSONを読み込み

### データソース別の方式
| データソース | 方式 | ファイル |
|-------------|------|----------|
| papimo.jp (アイランド秋葉原) | GAS経由 | `scrapers/availability_checker.py` |
| daidata (エスパス系) | GitHub Actions → JSON | `scripts/fetch_daidata_availability.py` |

### GitHub Actions設定
- ワークフロー: `.github/workflows/fetch-availability.yml`
- 実行頻度: 10分ごと（10:00-23:00 JST）
- 手動実行: `gh workflow run "Fetch Availability"` または GitHub UI

### 取得データ
| フィールド | 説明 |
|-----------|------|
| `art` | ART回数 |
| `bb` | BB回数 |
| `rb` | RB回数 |
| `total_start` | 累計スタート |
| `availability` | 空き/遊技中 |

### 対象店舗・台番号（daidata）
| 店舗 | hall_id | 台番号 |
|------|---------|--------|
| 渋谷エスパス新館 | 100860 | 3011, 3012, 3013 |
| 新宿エスパス歌舞伎町 | 100949 | 682, 683, 684, 685 |
| 秋葉原エスパス駅前 | 100928 | 2158, 2159, 2160, 2161 |
| 西武新宿駅前エスパス | 100950 | 3185, 3186, 3187, 4109, 4118, 4125, 4168 |

### ローカルでのテスト
```bash
# データ取得（Playwright必要）
python scripts/fetch_daidata_availability.py

# 確認
cat data/availability.json | python -m json.tool
```

### WSLクラッシュ対策（2026/1/26実施）

#### 問題
`Wsl/Service/E_UNEXPECTED` エラーで頻繁にクラッシュ

#### 対策1: WSL設定ファイル作成
場所: `/mnt/c/Users/rs/.wslconfig`
```ini
[wsl2]
memory=6GB
processors=2
swap=4GB
localhostForwarding=true

[experimental]
autoMemoryReclaim=gradual
sparseVhd=true
```

#### 対策2: Playwrightの軽量化
`scripts/fetch_daidata_availability.py` に以下を追加:
- `--disable-gpu`, `--disable-dev-shm-usage` 等のブラウザオプション
- 画像・フォント・広告のリソースブロック

#### WSL再起動コマンド
```powershell
wsl --shutdown
```

### 完了済み（2026/1/26）
- [x] GitHub Actions定期実行設定
- [x] Webアプリへの空き状況表示統合
- [x] リアルタイムART回数の取得・表示
- [x] PythonAnywhere無料プラン対応
- [x] GitHub Actionsリトライ機能（失敗時3回まで再試行）
- [x] 時間帯別表示モード（営業中/閉店後）
- [x] 最大持ち玉（max_medals）の取得修正

---

## 時間帯別表示モード（2026/1/26追加）

### 概要
時間帯によってWebアプリの表示内容を自動で切り替え。

### モード切替
| 時間帯 | モード | 表示内容 |
|--------|--------|----------|
| 10:00〜22:59 | `realtime` | いま狙い目TOP5、空き状況、当日データ |
| 23:00〜09:59 | `result` | ○月○日の結果、本日の好調台、ランキング |

### 実装
- `app.py`: `get_display_mode()`, `get_result_date()` 関数追加
- `index.html`: モードに応じてヘッダー・セクションタイトルを変更
- `style.css`: `.mode-badge` スタイル追加

### 表示切替の詳細
- **営業中（realtime）**: 空き状況バッジ表示、「いま狙い目」タイトル
- **閉店後（result）**: 空き状況非表示、「○月○日の結果」タイトル、「本日の好調台」

---

## GitHub Actions リトライ機能

### 実装
`.github/workflows/fetch-availability.yml` にリトライロジック追加:
- 最大3回まで再試行
- 失敗時30秒待機
- 全店舗分のデータ取得を完了するまで継続
