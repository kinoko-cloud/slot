# TASK.md — 現在の作業指示

最終更新: 2026-01-29 06:40 JST

## 優先度: 高

### 1. バックアップ機能の実装
- `data/history/` の日次バックアップを実装
- データは資産。飛んだり書き換えられたら台無し
- サイトによっては古いデータが取れなくなる → 蓄積に価値がある
- 案: `data/backup/YYYY-MM-DD/` にhistory全体をコピー、または別ブランチにpush

### 2. 台変動通知の連携
- `scripts/verify_units.py` は実装済みだが、アラートがRSさんに届いてない
- daily_collect.py実行後にverify_units.pyを実行し、アラートがあればWhatsAppで通知
- 毎日のチェック項目:
  - その機種が何台あるか？
  - 機種名は合っているか？
  - 台番号は移動してないか？
  - 減ってないか？増えてないか？

### 3. 挙動DB分離（機種共通 vs 店舗固有）
- **機種の挙動データ**: SBJの設定別挙動はどの店でも同じ → 全店のサンプルを統合して永続利用
  - 例: SBJ設定6の初当たり確率分布、連チャン率、出玉パターン
  - `data/machine_behavior/{machine_key}.json` のような形式
- **店舗の傾向データ**: 設定投入方針・島への好み → 店舗固有、他店には関係ない
  - 例: アイランドの曜日別好調率、据え置きパターン
  - `data/store_patterns/{store_key}.json`（既存のstore_pattern.pyを拡張）

### 4. verify的中率の修正
- generate_verify.pyの蓄積DBフィルタが不完全
  - `history_accumulator.load_unit_history`をmonkeypatchしたが効いてない可能性
  - backtest.pyでは65.4%だがverifyでは46.3%になる
  - recommend_units()内の`from analysis.history_accumulator import load_unit_history`が
    monkeypatch後の関数を取得できてるか確認

### 5. 北斗のS/A過多問題
- 北斗のS/A予測が多すぎる（秋葉原50%、渋谷50%、歌舞伎37%）
- 品質チェックのハマリ閾値を5回に緩めた影響
- S/A台数の上限制限（島内で上限N台、相対評価）が必要

## 優先度: 中

### GitHub Actionsの修復
- daily_collect.ymlの実行状況を確認
- git pushコンフリクトが原因で失敗してる可能性
- ローカルcronは設定済みだがActions側も復旧が望ましい

## イレギュラーケース仕様（重要 — RSさん確認済み）

### 台移動
- 機種の台番号が変わる → 過去データ紐づけ不可（シャッフル）
- 店の傾向・機種のクセは同じだが、台個別データは仕切り直し

### 減台（番号変更なし）
- 一部が歯抜けになる。残った台は継続
- なくなった台は他機種になる → その新機種を追加しないと意味がない

### 減台＋台移動（同時発生）
- シャッフルと同じ扱い

### 増台
- 取得対象が増える。台移動とセットの場合あり → 実質シャッフル

### 撤去
- 機種自体が全部なくなる → 取得先消滅

### 検出ロジック（実装済み: scripts/verify_units.py）
- configにある台番号だがデータが取れない → 減台・撤去の可能性
- configにない台番号でデータが取れた → 増台の可能性
- 全台のデータが取れない → 機種撤去 or サイト障害
- **→ 検出後のRSさんへの通知が未実装**

### ポリシー文書: docs/UNIT_CHANGE_POLICY.md

## データアーキテクチャ

### データソースの優先順位
1. **papimo** → アイランドのメインデータ（当たり履歴・G数・ART数）
2. **台データオンライン** → エスパス各店のメインデータ
3. **site777** → papimoがダメな時のフォールバック（日別サマリ・max_medals補完）

### 蓄積DB
- `data/history/{store_key}_{machine_key}/{unit_id}.json`
- 全店・全台の7〜13日分のデータ
- `analysis/history_accumulator.py` で蓄積ロジック実装済み
- `load_all_daily_data()`（backtest.py）で読み込み対応済み

### 品質チェック閾値（機種別）
- **SBJ**: ハマリ500G超 3回以上で好調除外、max_medals < 300で除外
- **北斗**: ハマリ500G超 5回以上で好調除外、max_medalsチェックなし

## 核心的な設計思想（RSさんの言葉）

### 機種の挙動 vs 店舗の傾向
- **SBJの設定6の挙動はアイランドでもエスパスでも同じ** → 全店サンプル統合
- **アイランドの設定投入方針はエスパスとは無関係** → 店舗固有データ
- この2つは明確に分離すること
