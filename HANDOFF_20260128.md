# ハンドオフメモ 2026-01-28

RSさんからの全指示と議論内容。Claude Code側で作業する際の参照用。

---

## 1. 予測精度の根本的な考え方（RSさんの整理）

### 前日予想と営業中モードは別物
- **前日予想** = 店舗の設定投入方針のトレース。台の挙動は関係ない（まだ動いてない）
- **営業中モード** = 店舗方針 × 今日の台の挙動。両方必要

### 店は島単位で利益管理
- 台単位で「この台出しすぎたから回収」みたいな発想はしない
- 島全体（SBJ島、北斗島）で「今日は何台高設定にするか」を決める
- 店舗全体で「今日はどの島に力を入れるか」を決める

### 設定は1-6段階
- 好調/不調の二値判定は粗い
- 設定4でもそこそこ出る、店は6を入れずに4-5で済ませることもある
- 「この店は6を使うか」「4-5を分散させるか」も店の癖

### 的中率とカバー率
- **的中率** = ユーザーの正義。S/A予測が当たった率
- **カバー率** = 運営側の課題。好調台のうちS/Aで拾えた率
- 店舗パターンが正しくトレースできれば両方同時に上がる

---

## 2. 店舗パターンで見るべき要素（RSさん指示）

### 設定移動パターン
- 据え置き率（前日好調→翌日も好調）
- 不調→投入率（前日不調→翌日好調）
- **不調放置日数**（何日連続不調で設定変更するか。3日連続下げはさすがにない、等）
- **好調連続上限**（何日連続好調したら下げるか）
- 島全体の波（前日絞り→翌日増やす傾向）

### 日程パターン
- 曜日傾向（データ駆動で）
- **特定日**:
  - 「3のつく日」= 3,13,23,30,31
  - 「6のつく日」= 6,16,26
  - 「7のつく日」= 7,17,27
  - 「5の倍数」= 5,10,15,20,25,30
  - 「ゾロ目」= 11,22
- 月初・月末傾向

### 台番パターン
- 末尾傾向
- 位置（角台等）

### 設定段階分析
- 6域/5域/4域の分布
- 店の設定スタイル（目玉1台型 vs 4-5を分散型 vs 渋い型）

---

## 3. 分析結果（データから判明）

### 店舗ごとの据え置き率・投入率
| 店舗 | 機種 | 据え置き率 | 不調→投入率 |
|---|---|---|---|
| アイランド秋葉原 | 北斗 | **20%**（毎日入替） | **9%**（放置） |
| エスパス渋谷新館 | 北斗 | 39%（下げ多い） | 59% |
| エスパス歌舞伎町 | 北斗 | 50% | 40% |
| エスパス秋葉原 | 北斗 | **67%**（据え置き傾向） | 57% |
| アイランド秋葉原 | SBJ | **71%**（据え置き傾向） | 100% |
| エスパス西武新宿 | SBJ | **83%**（据え置き傾向） | - |
| エスパス渋谷新館 | SBJ | 67% | 100% |
| エスパス歌舞伎町 | SBJ | 50% | 100% |

### 北斗のスコア分布問題
- 74台中63台がスコア50-65に集中 → 差がつかない
- S/A/B/C/Dの分布が偏りすぎ

### 的中率の実態
- 爆発TOP20中 予測S/Aに入ってたのは9/20（45%）
- 好調46台中S/A予測は13台（28%）— カバー率が低い

---

## 4. 対応済みの作業

### analysis/store_pattern.py（新規作成済み）
- analyze_store_patterns(): 設定移動、日程、台番、設定段階のパターン分析
- calculate_pattern_bonus(): -15〜+15のスコアボーナス
- confidence重み付け（サンプル少ない→重み下げ）
- recommender.pyのraw_scoreにpattern_bonus追加済み

### 答え合わせページ修正
- テーブル崩れ: CSS `thead th:nth-child(4) { display:none }` 削除
- CSSキャッシュバスト: style.css?v=タイムスタンプ
- 的中率定義変更: S/A台限定 → 全台ベース（S/A→好調 + B以下→不調 = 的中）
- 差枚データ: availability.jsonのhistoryからdiff_medals_estimatorで計算
- store_key不一致修正: akiba↔akihabara エイリアス
- verify結果再生成: 歌舞伎町のunit_id混入修正、西武新宿追加

### トピック改善
- 「予想外の爆発」「予測全滅」「予想外の好調」削除 → 的中系のみ
- **大的中**（S/A予測 × 確率1/100以下）→ スコア200+で最優先
- **的中**（S/A予測 × 差枚+5,000以上）→ 大的中に含まれない台
- カラー表示: 機種名=青、ART=オレンジ、確率=赤太字、差枚=緑/赤

---

## 5. 未対応・今後の課題

1. **store_pattern.pyの効果検証** — バックテストで的中率・カバー率がどう変わったか
2. **スコア分散の改善** — 北斗の50-65集中を解消（store_pattern.pyのpattern_bonusで改善するはず）
3. **データ蓄積** — 7日分では曜日・特定日の統計が弱い。日次収集を続ければ自動改善
4. **据え置き率のスコア反映強化** — 今はpattern_bonusに含まれるが、前日好調台×据え置き率の重み付けが弱い可能性
5. **島全体の視点** — 「今日この島に何台入れるか」の予測

---

## 6. 作業ルール

- コード変更は全てClaude Code（ターミナル側）で実施
- WhatsApp側はRSさんからの指示受付・転送・調査・報告
- recommender.py / generate_static.py / store_pattern.py の変更時は「なぜそうしたか」の背景を記録
