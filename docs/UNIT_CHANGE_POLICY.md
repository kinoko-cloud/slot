# 台変動ポリシー

台番号の変更・増減・撤去が発生した場合の対応方針。

## 原則

- **台番号 = データの紐づけキー**。番号が変われば過去データとの紐づけは不可能。
- **店舗の傾向（曜日パターン・設定投入傾向）は台番号に依存しない** → 引き継ぐ。

## ケース別対応

### 1. 台番号が変わらない（通常）
- 今まで通り。蓄積データ継続。

### 2. 減台（台番号の移動なし）
- 減った台番号をSTORESのunitsから削除。
- 営業中のリアルタイム・推薦からは外れる。
- 過去データ（蓄積DB・ランキング）はそのまま残る。答え合わせ等で参照可能。

### 3. 増台
- 新台番号をSTORESのunitsに追加。
- **新台扱い**。蓄積データはゼロからスタート。
- 過去データがないため、最初の数日は推薦ランクが低くなる。

### 4. 台番号変更（シャッフル）
- 旧番号 → 蓄積データはそのまま残すが、もう推薦には使わない（unitsから削除）。
- 新番号 → 新台扱い。ゼロから蓄積開始。
- **台個別の過去データは引き継がない**。どの台がどこに移動したか特定できないため。

### 5. 増台 ＋ 一部/全台の番号変更
- 番号変更分はシャッフルと同じ扱い（上記4）。
- 増台分は新台扱い（上記3）。

### 6. 機種撤去（全台なくなる）
- STORESから該当store_keyを無効化（unitsを空にするか、`active: false`等）。
- 推薦・リアルタイムからは完全に外れる。
- 過去のランキング・答え合わせデータは残る。

## 引き継ぐもの / リセットするもの

| 項目 | 台番号変更時 | 機種撤去時 |
|------|:---:|:---:|
| 台個別の蓄積データ | ❌ リセット | ❌ 対象なし |
| 台個別のランキング履歴 | 旧番号で残る | 残る |
| 店舗の曜日パターン | ✅ 引き継ぐ | ✅ 引き継ぐ |
| 店舗の設定投入傾向 | ✅ 引き継ぐ | ✅ 引き継ぐ |
| 連続好調/不調カウント | ❌ リセット | ❌ 対象なし |

## 検出と通知

スクレイピング時に自動検出すべきこと：
- **configにある台番号だがデータが取れない** → 減台・撤去の可能性 → RSさんに通知
- **configにない台番号でデータが取れた** → 増台の可能性 → RSさんに通知
- **全台のデータが取れない** → 機種撤去 or サイト障害 → RSさんに通知

通知を受けたら手動でconfigを更新する（将来的に自動化も検討）。

## 実装メモ

- 台番号の変更はconfig/rankings.pyのSTORES[store_key]['units']を編集。
- 蓄積データ（data/history/）は削除しない。旧台番号のファイルはそのまま残す。
- 無効化した台のデータファイルに`"retired": true`フラグを立てることも検討。
