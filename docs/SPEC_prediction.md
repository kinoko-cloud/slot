# 予測・おすすめロジック仕様書（マスター）

**最終更新: 2026-01-30**
**変更履歴は末尾に記録**

---

## 1. 基本原則

### 1.1 データモード

| モード | 時間帯 | データソース | 用途 |
|--------|--------|-------------|------|
| **確定データ** | 閉店後〜開店前 (22:50-9:59) | 蓄積DB（前日までの確定実績） | 翌日の予測・おすすめ台 |
| **リアルタイム** | 営業中 (10:00-22:49) | 蓄積DB + **最新のリアルタイム当たりデータ・回転数** | **今この瞬間の良台予想・チャンス台予測** |

#### 確定データモード
- 前日までの確定実績のみ使用。**同じデータ→同じ結果**（冪等）
- 翌日のおすすめ台を表示（設定変更予測ベース）

#### リアルタイムモード（本サービスの核心）
- **閲覧者がサイトを開いた瞬間に、最新データを反映した予測を表示する**
- 今日の当たり回数・回転数・当たり履歴がリアルタイムで更新される
- そのデータを元に「今この瞬間、どの台が狙い目か」を予測して見せる
- 空き状況だけでなく、**当日の稼働実績（ART回数/確率/G数）から設定推定をリアルタイムで再計算**
- 例: 「午後3時時点で既にART 40回、1/90の確率 → 高設定濃厚 → 今すぐ打つべき」

#### 現状のアーキテクチャ課題
- generate_static.pyによる静的HTML生成（ビルド時点のスナップショット）
- **ビルド時にはリアルタイムだが、閲覧時点では既に古い可能性がある**
- 理想: API化 or 定期リビルド（5-10分間隔）で鮮度を維持
- TODO: リビルド頻度・データ取得間隔の最適化

### 1.2 データソース優先順位

| 優先度 | ソース | 内容 | 信頼度 |
|--------|--------|------|--------|
| 1 | 蓄積DB (`data/history/`) | diff_medals, history, max_rensa, max_medals | ◎ 最高（実データ） |
| 2 | daily JSON (`data/daily/`) | ART, games, history | ○ 高い |
| 3 | availability.json | 空き状況, リアルタイムG数 | △ 鮮度依存 |
| 4 | estimate_diff_medals() | 推定差枚 | ✕ 不正確（フォールバックのみ） |

**絶対ルール**: 蓄積DBにdiff_medalsがあれば推定値は使わない

---

## 2. スコアリング

### 2.1 基本スコア計算

```
final_score = base_score + trend_bonus + historical_bonus + weekday_bonus + penalty
```

| 要素 | 範囲 | 算出元 |
|------|------|--------|
| base_score | 0-100 | 前日のART確率 → 設定推定 |
| trend_bonus | -20〜+20 | 連続好調/不調日数 |
| historical_bonus | -8〜+10 | 好調率（蓄積DB全日ベース） |
| weekday_bonus | -5〜+5 | 曜日別好調率 |
| penalty | -30〜0 | 差枚大幅マイナス等 |

### 2.2 ランク判定

| ランク | スコア帯 | 意味 |
|--------|---------|------|
| S | 85+ | 高設定濃厚 |
| A | 70-84 | 高設定域 |
| B | 55-69 | 中間以上 |
| C | 40-54 | 普通 |
| D | 0-39 | 低設定疑い |

### 2.3 S/A枠制限

- 店舗×機種ごとの好調率に基づき、S/A台数を制限
- S/A率 = 好調率 × 50%（例: 好調率30% → S/A率15%）
- 最低2台〜最大50%

---

## 3. 判定閾値（機種別）

### 3.1 SBJ (スーパーブラックジャック)

| パラメータ | 値 | 用途 |
|-----------|-----|------|
| good_prob | 130 | ART確率1/130以下で好調判定 |
| bad_prob | 150 | ART確率1/150以上で不調判定 |
| very_bad_prob | 200 | 明確に低設定 |
| typical_daily_games | 6,500 | 1日の一般的G数 |
| normal_ceiling | 999 | 通常天井 |
| reset_ceiling | 600 | リセット天井 |

### 3.2 北斗転生2

| パラメータ | 値 | 用途 |
|-----------|-----|------|
| good_prob | 120 | ART確率1/120以下で好調判定 |
| bad_prob | 150 | ART確率1/150以上で不調判定 |
| very_bad_prob | 200 | 明確に低設定 |
| typical_daily_games | 7,000 | 1日の一般的G数 |

### 3.3 定義場所

`config/rankings.py` の `MACHINES` 辞書。**ここが唯一の閾値定義元**。
他のファイルで閾値をハードコードしない。

---

## 4. 好調判定

### 4.1 日別好調判定

```
好調 = (ART確率 ≤ good_prob) AND (品質OK)
```

品質チェック:
- SBJ: 500G超ハマリ3回以上 → 不良
- SBJ: max_medals < 300 → 不良
- 北斗: 500G超ハマリ5回以上 → 不良

### 4.2 連続好調/不調カウント

```
連続好調カウント（consecutive_plus）:
- diff > 0 → プラス
- diff < 0 AND diff > -2,000 AND prob ≤ good_prob → プラス（少額マイナスで確率良好）
- diff ≤ -2,000 → マイナス（確率が良くても大幅マイナスは不調）
- art < 3 AND games < 500 → スキップ（判定不能）
```

---

## 5. データ計算定義

### 5.1 max_medals（最大獲得枚数）

**定義: 1回の連チャン中に獲得した合計枚数の最大値**

- 連チャン = 機種別閾値以内（config/rankings.pyのrenchain_threshold参照）
  - SBJ: ART間100G以内
  - 北斗: ART間50G以内
  - デフォルト: ART間70G以内
- 個別hitの最大ではない
- RBは連チャンカウントに含まない

### 5.2 max_rensa（最大連チャン）

**定義: 1日の中で最も長い連チャン数**

- 連チャン閾値 = 機種別（SBJ:100G / 北斗:50G / デフォルト:70G）
- ART/AT/BIG のみカウント

### 5.3 diff_medals（差枚）

**定義: 1日の獲得枚数 - 投入枚数**

- 蓄積DBのdiff_medalsを最優先
- なければestimate_diff_medals()で推定（**不正確注意**）

---

## 6. おすすめ文（reasons）生成ルール

### 6.1 generate_reasons() の構造

```
reasons = [
    "🔄 連続好調/不調 + 曜日",     # 据え置き/転落
    "📊 好調率/連続記録",            # 統計的根拠
    "⚡ ART確率評価",               # 昨日の設定推定
    "💰 差枚/出玉評価",             # 収支傾向
]
```

### 6.2 禁止事項

- 矛盾する理由を同時出力しない（例: 「5日連続好調」+「不調台」）
- 推定データに基づく断定表現は使わない
- 「吐き出し」→「飲まれる」（用語統一）

---

## 7. 表示データ定義

### 7.1 全ページ共通

| 項目 | 必須 | ソース |
|------|------|--------|
| 台番号 | ◎ | config/rankings.py |
| ART回数 | ◎ | 蓄積DB / daily |
| ART確率 (1/N) | ◎ | 計算値 |
| 差枚 | ◎ | 蓄積DB優先 |
| 最大連チャン | ○ | history計算 |
| 最大獲得枚数 | ○ | history計算（連チャン合計） |
| 差枚推移グラフ | ◎ | history |

### 7.2 おすすめカード追加項目

| 項目 | 必須 | ソース |
|------|------|--------|
| おすすめ理由 | ◎ | generate_reasons() |
| ランクバッジ | ◎ | スコアリング |
| 直近3日データ | ◎ | 蓄積DB |
| 展開詳細（当たり履歴） | ○ | history |

---

## 8. チェック機構

### 8.1 ビルド時（validate_output.py）

- [ ] 全ページにbuild-ver + _common_js
- [ ] TOP10カードに必須項目（理由/直近データ/グラフ/差枚）
- [ ] 直近データに展開詳細
- [ ] モードバッジの存在
- [ ] 的中率の日付

### 8.2 データ収集時（data_integrity_check.py）

- [ ] スクレイピング品質（0台/部分取得/null）
- [ ] 台番号/機種名/台数照合
- [ ] 日付整合性（未来日付/歯抜け）
- [ ] データ品質（異常確率/異常差枚）
- [ ] 開店時データ切替

### 8.3 アルゴリズム整合性（TODO: 新設）

- [ ] 同一入力→同一出力の冪等性テスト
- [ ] 閾値変更時の影響範囲テスト
- [ ] reasonsの矛盾チェック（好調+不調の同時出力）

---

## 変更履歴

| 日付 | 変更内容 | 理由 |
|------|---------|------|
| 2026-01-30 | 初版作成 | RSさん指示：仕様固定・マスター管理 |
| 2026-01-30 | max_medals定義変更 | 1hit最大→連チャン合計 |
| 2026-01-30 | consecutive_plus判定修正 | diff≤-2000は確率良くても不調 |
| 2026-01-30 | diff_medals優先順位明記 | estimate_diff_medalsの不正確さ判明 |

## 表示仕様

### 当たり履歴テーブル
- **時間軸**: 降順（上が最新=夜、下が古い=朝）
- **連チャン表示**: 
  - chain_pos==1（連チャン開始=最古=下）: 「X連」と表示
  - chain_pos>1（連チャン継続=上方向）: 「↑」と表示
  - 連チャンでない: 「-」
- **RB**: 連チャンに含めない。AT間G数は累積継続。
- **G数**: 前回当たりからの開始G数（accumulated_gamesではない）

### トップページ
- 営業中は本日データ0でも0と表示（ART 0、累計0G）
- 本日データが stale（availability日付≠今日）の場合、today関連を0リセット
