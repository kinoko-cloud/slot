# 分析ロジック進化設計書

## 目標
データ蓄積に応じて自動的に分析精度を上げ、1ヶ月後に的中率100%に近づく

## データ蓄積戦略

### 現状
- daidata: 外部から直近7日分（スクレイピング時）
- papimo: 外部から直近14日分（スクレイピング時）
- daily JSON: 1日分のスナップショット

### 改善: ローカル蓄積DB
- `data/history/`に台番号ごとの全日履歴を蓄積
- 毎日のdaily JSONから抽出→追記（重複排除）
- 構造: `data/history/{store_key}/{unit_id}.json`

```json
{
  "store_key": "island_akihabara_sbj",
  "unit_id": "1023",
  "days": [
    {
      "date": "2026-01-20",
      "art": 52, "rb": 3, "games": 8232,
      "prob": 158.3,
      "is_good": false,
      "history": [...]  // 当たり履歴（あれば）
    },
    ...
  ]
}
```

## 日数別ロジック進化

### Phase 1: 1-7日（現在）
- 直近7日の好調率
- 連続好調/不調カウント
- 曜日レーティング
- 前日ART確率による設定推測

### Phase 2: 8-14日（+1週間）
- **週間パターン検出**: 同じ曜日の好調率
- **設定変更周期**: 何日下げたら次上がるか？の統計
  - 例: 「2日不調→3日目は80%好調」「3日不調→4日目は90%好調」
- **交互パターン**: 好調→不調→好調→... の傾向スコア
- 7日 vs 14日の好調率比較（上昇中/下降中）

### Phase 3: 15-21日（+2週間）
- **2週比較**: 先週 vs 今週の好調率変化
- **設定変更日の推定**: 特定曜日に設定が動く傾向
- **据え置きパターン**: 好調→翌日も好調が何%か（大量サンプル）
- **天井→翌日リセット**: 天井到達後の翌日確率

### Phase 4: 22-30日（1ヶ月）
- **月間トレンド**: 月初/月中/月末の傾向
- **確信度付き予測**: サンプル数に応じた信頼区間
- **設定変更サイクル完全把握**: N日ごとのパターン
- **回帰分析**: 各特徴量の重み付けを実績で最適化
- **好調パターンDB**: 過去にこの状況→翌日好調だった類似ケース検索

### Phase 5: 31日+（長期）
- **月別・曜日別の完全統計**
- **イベント日検出**: 特定の日付（ゾロ目、月初、給料日後）の傾向
- **台番号ごとのクセ**: 特定台は特定曜日に強い等
- **クロス分析**: 同じ店の他の台が好調→この台も？

## 自動進化メカニズム

### accumulate_history()
毎日のデータ収集後に呼ばれる:
1. daily JSONから各台の結果を抽出
2. `data/history/{store_key}/{unit_id}.json`に追記
3. 重複日付は上書き

### get_analysis_phase(unit_history)
蓄積日数に応じたフェーズを返す:
```python
days = len(unit_history['days'])
if days >= 31: return 5
if days >= 22: return 4
if days >= 15: return 3
if days >= 8:  return 2
return 1
```

### calculate_adaptive_score(unit_history, phase)
フェーズに応じて使う分析を切り替え:
- Phase 1: 基本分析のみ
- Phase 2: + 設定変更周期分析
- Phase 3: + 週間パターン
- Phase 4: + 月間トレンド + 回帰
- Phase 5: + 全データ活用

### 設定変更周期分析（Phase 2+）
```
不調N日後の好調確率:
  1日不調→翌日好調: X/Y回 (Z%)
  2日連続不調→翌日好調: X/Y回 (Z%)
  3日連続不調→翌日好調: X/Y回 (Z%)
  ...
好調N日後の好調確率:
  1日好調→翌日も好調: X/Y回 (Z%)
  2日連続好調→翌日も好調: X/Y回 (Z%)
  ...
```

### 交互パターンスコア（Phase 2+）
```
直近14日で好不調が交互に変わった回数 / 変わるべきタイミング数
→ 交互率が高いなら、前日の逆を予測
```

## おすすめ理由の進化表示

Phase 1: 📊 7日間中7日好調（好調率100%）
Phase 2: 📊 14日間中12日好調（好調率86%） / 不調後2日目→好調率85%
Phase 3: 📊 21日間中16日好調 / 水曜好調率90% / 据え置き率78%
Phase 4: 📊 30日間好調率80% / 設定変更周期: 3日 / 的中率予測92%
Phase 5: 📊 総合的中率95% / この台の水曜は過去5回中5回好調

## 実装優先度

1. ✅ data/history/ への日次蓄積（accumulate_history）
2. ✅ 設定変更周期分析（不調N日→好調確率）
3. ✅ 交互パターンスコア
4. ✅ get_analysis_phase + calculate_adaptive_score
5. □ 理由文のフェーズ別表示
6. □ 週間パターン検出
7. □ 回帰分析による重み最適化
