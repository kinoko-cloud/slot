version: 2.1

# Circle CI 設定 - PAPIMO（アイランド秋葉原）専用
# GitHub Actionsと分散して負荷軽減

jobs:
  fetch-papimo:
    docker:
      - image: mcr.microsoft.com/playwright/python:v1.40.0-jammy
    resource_class: medium
    steps:
      - checkout

      - run:
          name: Install Python dependencies
          command: |
            pip install playwright flask jinja2 requests
            playwright install chromium

      - run:
          name: Fetch PAPIMO (Island Akihabara) data
          command: |
            python scripts/fetch_papimo_emergency.py
          no_output_timeout: 20m

      - run:
          name: Regenerate static site
          command: |
            python scripts/generate_static.py || true

      - run:
          name: Commit and push
          command: |
            git config user.name "CircleCI"
            git config user.email "circleci@users.noreply.github.com"
            git add data/ docs/

            if git diff --staged --quiet; then
              echo "No changes to commit"
              exit 0
            fi

            TIMESTAMP=$(TZ='Asia/Tokyo' date +'%Y-%m-%d %H:%M')
            git commit -m "auto: PAPIMO更新 ${TIMESTAMP} (CircleCI)"

            for i in 1 2 3 4 5; do
              git pull --rebase origin main || true
              if git push origin main; then
                echo "Push succeeded (attempt $i)"
                exit 0
              fi
              echo "Push failed (attempt $i/5), retrying..."
              sleep 5
            done
            echo "Push failed after 5 attempts"
            exit 1

workflows:
  # PAPIMO日次更新（毎日23:30 JST）
  daily-papimo:
    triggers:
      - schedule:
          cron: "30 14 * * *"  # UTC 14:30 = JST 23:30
          filters:
            branches:
              only:
                - main
    jobs:
      - fetch-papimo

  # 手動実行用
  manual:
    jobs:
      - fetch-papimo:
          filters:
            branches:
              only:
                - main
