{# ==================== å…±é€šãƒã‚¯ãƒ­é›† ==================== #}

{# === ãƒ‡ãƒ¼ã‚¿çŠ¶æ³ãƒãƒƒã‚¸ï¼ˆçµ±ä¸€å½¢å¼ï¼‰ === #}
{# status: 'unit_renumbered' | 'new_unit' | 'data_missing' | 'data_stopped' #}
{% macro data_status_badge(status, detail='') %}
{% if status == 'unit_renumbered' %}
<span class="data-status-badge renumbered">âš ï¸ å°ç•ªå·å¤‰æ›´ã®ãŸã‚äºˆæ¸¬ç²¾åº¦ä½{% if detail %}ï¼ˆ{{ detail }}ï¼‰{% endif %}</span>
{% elif status == 'new_unit' %}
<span class="data-status-badge new-unit">ğŸ†• æ–°è¦å°{% if detail %}ï¼ˆ{{ detail }}ï¼‰{% endif %}</span>
{% elif status == 'data_missing' %}
<span class="data-status-badge missing">âš ï¸ æœ¬æ—¥ãƒ‡ãƒ¼ã‚¿æœªå–å¾—</span>
{% elif status == 'data_stopped' %}
<span class="data-status-badge stopped">âš ï¸ ãƒ‡ãƒ¼ã‚¿å–å¾—åœæ­¢ä¸­{% if detail %}ï¼ˆæœ€çµ‚: {{ detail }}ï¼‰{% endif %}</span>
{% endif %}
{% endmacro %}

{# === å°ç•ªå·+åº—åãƒ©ãƒ™ãƒ«ï¼ˆçµ±ä¸€å½¢å¼ï¼‰ === #}
{# é †åº: å°ç•ªå· â†’ åº—åï¼ˆå°ç•ªå·ãŒ4æ¡å›ºå®šã§æƒã†ãŸã‚ï¼‰ #}
{% macro unit_store_label(unit_id, store_name, size='normal') %}
{% if size == 'large' %}
<span class="unit-id-sub"><span class="unit-id-num-lg">{{ unit_id|pad_id }}</span><span class="unit-id-ban">ç•ªå°</span></span>
<span class="store-link-right">{{ store_name }}</span>
{% elif size == 'small' %}
<span class="unit-id-sm">{{ unit_id|pad_id }}ç•ªå°</span>
<span class="store-name-sm">{{ store_name }}</span>
{% else %}
<span class="unit-id-sub"><span class="unit-id-num">{{ unit_id|pad_id }}</span><span class="unit-id-ban">ç•ªå°</span></span>
<span class="store-link">{{ store_name }}</span>
{% endif %}
{% endmacro %}

{# === å½“ãŸã‚Šå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³/å±•é–‹å¯èƒ½ï¼‰ === #}
{% macro hit_table(processed_hist, summary=none, inline=false) %}
{% if processed_hist %}
<div class="hit-detail-panel{% if not inline %}" style="display:none;{% endif %}">
    {% if summary %}
    <div class="hit-summary-row">
        <span>{{ summary.total_hits or 0 }}å½“ãŸã‚Š</span>
        <span>æœ€å¤§{{ summary.max_chain or 0 }}é€£</span>
        <span>å¹³å‡{{ summary.avg_valley or 0 }}G</span>
        {% if summary.tenjou_count %}<span class="deep">å¤©äº•{{ summary.tenjou_count }}å›</span>{% endif %}
    </div>
    {% endif %}
    <table class="hit-detail-table">
        <thead><tr><th>#</th><th>æ™‚åˆ»</th><th>Gæ•°</th><th>ç¨®é¡</th><th>é€£</th><th>æšæ•°</th></tr></thead>
        <tbody>
        {% for hit in processed_hist %}
        <tr class="{% if hit.is_tenjou %}tenjou{% elif hit.is_hot_chain %}hot-chain{% elif hit.is_deep %}deep{% endif %}">
            <td>{{ hit.index }}</td>
            <td>{{ hit.time or '-' }}</td>
            <td class="{% if hit.is_tenjou is defined and hit.is_tenjou %}tenjou{% elif hit.is_deep %}deep{% endif %}{% if hit.is_shallow %} shallow{% endif %}">{{ hit.start }}G{% if hit.accumulated_games is defined and hit.accumulated_games != hit.start and hit.accumulated_games > 0 %}<br><small class="acc-games">ï¼ˆç´¯è¨ˆ{{ hit.accumulated_games }}Gï¼‰</small>{% endif %}</td>
            <td class="{{ hit.type|lower }}">{{ hit.type }}</td>
            <td class="{% if hit.is_hot_chain %}hot{% endif %}">{% if hit.chain_pos is defined and hit.chain_len is defined and hit.chain_len > 1 %}{% if hit.chain_pos == hit.chain_len %}{{ hit.chain_len }}é€£{% else %}â†‘{% endif %}{% else %}-{% endif %}</td>
            <td>{% if hit.medals > 0 %}{{ '{:,}'.format(hit.medals) }}{% else %}-{% endif %}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% endmacro %}

{# === ç›´è¿‘æ—¥ãƒ‡ãƒ¼ã‚¿è¡Œï¼ˆå±•é–‹å¯èƒ½ï¼‰ === #}
{% macro day_row(art, prob, date_str, label, diff_medals, max_rensa, max_medals, history) %}
{% if art > 0 %}
<div class="recent-day" {% if history and history|length > 0 %}onclick="this.classList.toggle('expanded')"{% endif %}>
    <span class="recent-day-date">{{ date_str if date_str else label }}</span>
    <span class="recent-day-art">ART <span class="num">{{ art }}</span></span>
    {% if prob > 0 %}
    <span class="recent-day-prob {% if prob <= 100 %}excellent{% elif prob <= 130 %}good{% elif prob >= 200 %}bad{% endif %}">1/{{ prob|int }}</span>
    {% endif %}
    {% if diff_medals and diff_medals != 0 %}
    <span class="diff-medals-sm {% if diff_medals > 0 %}plus{% else %}minus{% endif %}">{{ '{:+,}'.format(diff_medals) }}æš</span>
    {% endif %}
    {% if max_rensa and max_rensa >= 3 %}
    <span class="rensa-sm">{{ max_rensa }}é€£</span>
    {% endif %}
    {% if max_medals and max_medals >= 500 %}
    <span class="max-medals-sm">{{ '{:,}'.format(max_medals) }}æš</span>
    {% endif %}
    {% if history and history|length > 0 %}
    <span class="expand-icon">â–¼</span>
    {% endif %}
</div>
{% if history and history|length > 0 %}
<div class="recent-day-detail">
    {{ hit_table(history, none, true) }}
</div>
{% endif %}
{% else %}
<div class="recent-day no-data">
    <span class="recent-day-date">{{ date_str if date_str else label }}</span>
    <span class="no-data-text">ãƒ‡ãƒ¼ã‚¿ãªã—</span>
</div>
{% endif %}
{% endmacro %}

{# === æ¨å¥¨ç†ç”±ãƒªã‚¹ãƒˆï¼ˆçµµæ–‡å­—ã§ã‚¹ã‚¿ã‚¤ãƒ«åˆ†ã‘ï¼‰ === #}
{% macro reasons_list(reasons, max_display=none) %}
{% if reasons %}
{% set display_reasons = reasons[:max_display] if max_display else reasons %}
{% for reason in display_reasons %}
{% if 'ğŸ“Š' in reason %}
<div class="reason-line-top reason-rank">{{ reason }}</div>
{% elif 'ğŸ“ˆ' in reason %}
<div class="reason-line-top reason-stats">{{ reason }}</div>
{% elif 'ğŸ”' in reason %}
<div class="reason-line-top reason-cycle">{{ reason }}</div>
{% elif 'ğŸ”„' in reason %}
<div class="reason-line-top reason-pattern">{{ reason }}</div>
{% elif 'ğŸ’¡' in reason %}
<div class="reason-line-top reason-today">{{ reason }}</div>
{% elif 'ğŸ“…' in reason %}
<div class="reason-line-top reason-weekday">{{ reason }}</div>
{% elif 'âš ' in reason %}
<div class="reason-line-top reason-warn">{{ reason }}</div>
{% else %}
<div class="reason-line-top">{{ reason }}</div>
{% endif %}
{% endfor %}
{% else %}
<div class="reason-line-top">ğŸ’¡ éå»ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ããŠã™ã™ã‚å°</div>
{% endif %}
{% endmacro %}

{# === ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ç”¨ å°ã‚«ãƒ¼ãƒ‰ï¼ˆãƒ•ãƒ«è¡¨ç¤ºï¼‰ === #}
{% macro unit_card_top(rec, loop_index, show_sparkline=true, show_history_detail=false, is_realtime=false) %}
<a href="{{ url_for('recommend', store_key=rec.store_key) }}" class="unit-card rank-{{ rec.final_rank|lower }}" style="text-decoration: none; color: inherit;">
    {# ãƒ˜ãƒƒãƒ€ãƒ¼ #}
    <div class="unit-header">
        <span class="ranking-num">#{{ loop_index }}</span>
        <span class="machine-icon">{{ rec.machine_icon }}</span>
        <span class="machine-name-top">{{ rec.machine_name }}</span>
        <span class="rank-badge" style="background-color: {{ rank_color(rec.final_rank) }}">{{ rec.final_rank }}</span>
    </div>
    {# åº—èˆ—ãƒ»å°ç•ªå· #}
    <div class="unit-store">
        <span class="unit-id-sub"><span class="unit-id-num-lg">{{ rec.unit_id|pad_id }}</span><span class="unit-id-ban">ç•ª</span></span>
        <span class="store-link-right">{{ rec.store_name }}</span>
    </div>
    {# æ¨å¥¨ç†ç”± #}
    <div class="reasons-full">
        {{ reasons_list(rec.reasons) }}
    </div>
    {# äºˆæ¸¬çµæœãƒãƒƒã‚¸ï¼ˆã‚ã‚Œã°ï¼‰ #}
    {% set pred_good = rec.predicted_rank in ['S', 'A'] %}
    {% set result_good = rec.yesterday_prob is defined and rec.yesterday_prob > 0 and rec.yesterday_prob <= 130 %}
    {% if rec.predicted_rank %}
    <div class="prediction-result">
        {% if pred_good and result_good %}
        <span class="prediction-badge hit">å‰æ—¥äºˆæ¸¬çš„ä¸­</span>
        {% elif pred_good and not result_good %}
        <span class="prediction-badge miss">å‰æ—¥äºˆæ¸¬ãƒã‚ºãƒ¬</span>
        {% elif not pred_good and result_good %}
        <span class="prediction-badge miss">å‰æ—¥äºˆæ¸¬ãƒã‚ºãƒ¬</span>
        {% else %}
        <span class="prediction-badge hit">å‰æ—¥äºˆæ¸¬çš„ä¸­</span>
        {% endif %}
    </div>
    {% endif %}
    {# å·®æšãƒ»æ©Ÿæ¢°å‰² #}
    {% set _dm = rec.yesterday_diff_medals|default(rec.diff_medals|default(0)) %}
    {% if _dm != 0 %}
    <div class="yesterday-diff-line">
        <span class="diff-medals-lg {% if _dm > 0 %}plus{% else %}minus{% endif %}">{{ '{:+,}'.format(_dm) }}æš</span>
        {% if rec.payout_estimate and rec.payout_estimate > 100 %}
        <span class="setting-badge-sm setting-{{ rec.setting_num|default(0) }}"><small class="payout-label">æ©Ÿæ¢°å‰²</small><span class="payout-num">{{ rec.payout_estimate }}%</span></span>
        {% endif %}
    </div>
    {% endif %}
    {# ç›´è¿‘3æ—¥é–“ãƒ‡ãƒ¼ã‚¿ #}
    <div class="recent-days">
        <div class="recent-header">ç›´è¿‘ãƒ‡ãƒ¼ã‚¿</div>
        {% set y_art = rec.yesterday_art or 0 %}
        {% set y_games = rec.yesterday_games or 0 %}
        {% set y_prob = (y_games / y_art)|int if y_art > 0 and y_games > 0 else 0 %}
        {% set db_art = rec.day_before_art or 0 %}
        {% set db_games = rec.day_before_games or 0 %}
        {% set db_prob = (db_games / db_art)|int if db_art > 0 and db_games > 0 else 0 %}
        {% set td_art = rec.three_days_ago_art|default(0) %}
        {% set td_prob = ((rec.three_days_ago_games|default(0)) / td_art)|int if td_art > 0 else 0 %}
        {{ day_row(y_art, y_prob, rec.yesterday_date, 'å‰æ—¥', rec.yesterday_diff_medals|default(0), rec.yesterday_max_rensa|default(0), rec.yesterday_max_medals|default(0), rec.yesterday_history_processed|default(rec.yesterday_history|default([]))) }}
        {{ day_row(db_art, db_prob, rec.day_before_date, 'å‰ã€…æ—¥', rec.day_before_diff_medals|default(0), rec.day_before_max_rensa|default(0), rec.day_before_max_medals|default(0), rec.day_before_history_processed|default(rec.day_before_history|default([]))) }}
        {{ day_row(td_art, td_prob, rec.three_days_ago_date|default(''), '3æ—¥å‰', rec.three_days_ago_diff_medals|default(0), rec.three_days_ago_max_rensa|default(0), rec.three_days_ago_max_medals|default(0), rec.three_days_ago_history_processed|default(rec.three_days_ago_history|default([]))) }}
    </div>
    {# å·®æšæ¨ç§»ã‚°ãƒ©ãƒ• #}
    {% if show_sparkline %}
    {% set _yh = rec.yesterday_history if rec.yesterday_history and rec.yesterday_history|length >= 2 else none %}
    {% set _th = rec.today_history if rec.today_history and rec.today_history|length >= 2 else none %}
    {% set graph_hist = _yh if _yh else _th %}
    {% set graph_date = rec.yesterday_date|default('') if _yh else rec.history_date|default('') %}
    {% if graph_hist %}
    <div class="sparkline-section">
        <div class="sparkline-label">{% if graph_date %}{{ graph_date }}{% endif %} å·®æšæ¨ç§»</div>
        {{ sparkline(graph_hist, width=220, height=45, diff_medals=rec.yesterday_diff_medals|default(rec.diff_medals|default(none)))|safe }}
    </div>
    {% endif %}
    {% endif %}
</a>
{% endmacro %}

{# === çˆ†ç™ºå°ã‚«ãƒ¼ãƒ‰ï¼ˆé–‰åº—å¾Œ/å–¶æ¥­ä¸­å…±é€šï¼‰ === #}
{% macro unit_card_explosion(rec, loop_index, show_today=false) %}
<a href="{{ url_for('recommend', store_key=rec.store_key) }}" class="today-hot-card rank-{{ rec.final_rank|lower }}" style="text-decoration: none; color: inherit;">
    <div class="today-hot-header">
        <span class="today-hot-rank">#{{ loop_index }}</span>
        <span class="machine-icon">{{ rec.machine_icon }}</span>
        <span class="machine-name-sm">{{ rec.machine_name }}</span>
    </div>
    <div class="today-hot-store">
        <span class="unit-id"><span class="unit-id-num">{{ rec.unit_id|pad_id }}</span><span class="unit-id-ban">ç•ª</span></span>
        <span class="store-name-sm">{{ rec.store_name }}</span>
    </div>
    {# å·®æšãƒ»æ©Ÿæ¢°å‰² #}
    {% set _dm = rec.yesterday_diff_medals|default(rec.diff_medals|default(0)) %}
    {% if _dm != 0 %}
    <div class="yesterday-diff-line">
        <span class="diff-medals-lg {% if _dm > 0 %}plus{% else %}minus{% endif %}">{{ '{:+,}'.format(_dm) }}æš</span>
        {% if rec.payout_estimate and rec.payout_estimate > 100 %}
        <span class="setting-badge-sm setting-{{ rec.setting_num|default(0) }}"><small class="payout-label">æ©Ÿæ¢°å‰²</small><span class="payout-num">{{ rec.payout_estimate }}%</span></span>
        {% endif %}
    </div>
    {% endif %}
    {# ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ #}
    <div class="yesterday-stats">
        {% set art = rec.art_count if show_today else rec.yesterday_art %}
        {% set rensa = rec.today_max_rensa if show_today else rec.yesterday_max_rensa %}
        {% set games = rec.total_games if show_today else rec.yesterday_games %}
        {% if art and art > 0 %}
        <span class="art-badge">ART <span class="art-num">{{ art }}</span></span>
        {% endif %}
        {% if rec.first_hit_count is defined and rec.first_hit_count > 0 %}
        <span class="first-hit-count">åˆå½“ãŸã‚Š<span class="num">{{ rec.first_hit_count }}</span>å›</span>
        {% endif %}
        {% if rec.yesterday_rb and rec.yesterday_rb > 0 and not show_today %}
        <span class="rb-badge">RB <span class="rb-num">{{ rec.yesterday_rb }}</span></span>
        {% endif %}
        {% if rensa and rensa >= 2 %}
        <span class="rensa-badge {% if rensa >= 8 %}rensa-8{% elif rensa >= 5 %}rensa-5{% elif rensa >= 3 %}rensa-3{% else %}rensa-2{% endif %}">æœ€å¤§<span class="num">{{ rensa }}</span>é€£</span>
        {% endif %}
        {% if games and games > 0 %}
        <span class="total-games-label">{{ '{:,}'.format(games) }}G</span>
        {% endif %}
        {% if rec.payout_estimate and rec.payout_estimate > 100 %}
        <span class="setting-badge-sm setting-{{ rec.setting_num|default(0) }}"><small class="payout-label">æ©Ÿæ¢°å‰²</small><span class="payout-num">{{ rec.payout_estimate }}%</span></span>
        {% endif %}
    </div>
    {# ç¢ºç‡ #}
    {% set prob = rec.art_prob if show_today else rec.yesterday_prob %}
    {% if prob and prob > 0 %}
    <div class="yesterday-prob-badge">
        <span class="prob-label">ç¢ºç‡</span>
        <span class="prob-value {% if prob <= 100 %}excellent{% elif prob <= 130 %}good{% elif prob >= 200 %}bad{% endif %}">1/{{ prob|int }}</span>
    </div>
    {% endif %}
    {# ç†ç”±ï¼ˆ1ã¤ã ã‘ï¼‰ #}
    {% if rec.reasons %}
    <div class="explosion-reason">{{ rec.reasons[0] }}</div>
    {% endif %}
</a>
{% endmacro %}

{# === å–¶æ¥­ä¸­ SAå€™è£œãƒªã‚¹ãƒˆç”¨ ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã‚«ãƒ¼ãƒ‰ === #}
{% macro unit_card_list(rec, loop_index, store_key='') %}
<div class="unit-card-v2 rank-{{ rec.final_rank|lower }}" onclick="toggleDetails(this)">
    <div class="v2-header">
        <div class="v2-header-row1">
            <span class="v2-rank-num">#{{ loop_index }}</span>
            <a href="{{ url_for('unit_history', store_key=(rec.store_key or store_key), unit_id=rec.unit_id) }}" class="v2-unit-id" onclick="event.stopPropagation()">{{ rec.unit_id|pad_id }}ç•ªå°</a>
            <a href="{{ url_for('recommend', store_key=(rec.store_key or store_key)) }}" class="v2-store" onclick="event.stopPropagation()">{{ rec.store_name }}</a>
            <span class="v2-rank" style="background-color: {{ rank_color(rec.final_rank) }}">{{ rec.final_rank }}</span>
            <span class="expand-icon small">â–¼</span>
        </div>
        {% if rec.machine_name %}
        <div class="v2-header-row2">
            <span class="v2-machine">{{ rec.machine_name }}</span>
        </div>
        {% endif %}
    </div>
    {# å·®æš #}
    {% set _dm = rec.yesterday_diff_medals|default(rec.diff_medals|default(0)) %}
    <div class="yesterday-stats">
        {% if _dm != 0 %}
        <span class="diff-medals {% if _dm > 0 %}plus{% else %}minus{% endif %}">{{ '{:+,}'.format(_dm) }}æš</span>
        {% endif %}
        {% if rec.art_count > 0 %}
        <span class="art-badge">ART <span class="art-num">{{ rec.art_count }}</span></span>
        {% endif %}
        {% if rec.today_max_rensa and rec.today_max_rensa >= 2 %}
        <span class="rensa-badge {% if rec.today_max_rensa >= 8 %}rensa-8{% elif rec.today_max_rensa >= 5 %}rensa-5{% elif rec.today_max_rensa >= 3 %}rensa-3{% else %}rensa-2{% endif %}">æœ€å¤§<span class="num">{{ rec.today_max_rensa }}</span>é€£</span>
        {% endif %}
        {% if rec.total_games and rec.total_games > 0 %}
        <span class="total-games-label">{{ '{:,}'.format(rec.total_games) }}G</span>
        {% endif %}
        {% if rec.payout_estimate and rec.payout_estimate > 100 %}
        <span class="setting-badge-sm setting-{{ rec.setting_num|default(0) }}"><small class="payout-label">æ©Ÿæ¢°å‰²</small><span class="payout-num">{{ rec.payout_estimate }}%</span></span>
        {% endif %}
    </div>
    {# ç†ç”± #}
    {% if rec.reasons %}
    <div class="v2-reason">{{ rec.reasons[0]|safe }}</div>
    {% endif %}
    {# å±•é–‹è©³ç´° #}
    <div class="unit-details hidden">
        <div class="v2-detail-reasons">
            {% for reason in rec.reasons %}
            <div class="reason-item">{{ reason }}</div>
            {% endfor %}
        </div>
        {% if rec.total_games > 0 %}
        <div class="v2-detail-today">
            æœ¬æ—¥: ART {{ rec.art_count }} / RB {{ rec.rb_count }} / {{ '{:,}'.format(rec.total_games) }}G
            {% if rec.art_prob > 0 %} / 1/{{ rec.art_prob|int }}{% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endmacro %}
