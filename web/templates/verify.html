<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
    <meta name="googlebot" content="noindex, nofollow">
    <title>çš„ä¸­çµæœ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{ cache_bust }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="top-bar">
                <a href="{{ url_for('index') }}" class="back-link">&lt; ãƒˆãƒƒãƒ—</a>
                <img src="{{ url_for('static', filename='logo.svg') }}" alt="ã‚¹ãƒ­ãƒ—ãƒ­MAX" class="site-logo">
            </div>
            <h1>çš„ä¸­çµæœ</h1>
            <div class="update-info">
                {% if result_date_str %}
                {{ result_date_str }}ã®çš„ä¸­çµæœ<br>
                {% endif %}
                {% if predict_base %}
                <small>{{ predict_base }}</small>
                {% endif %}
            </div>
        </header>

        <main>
            {% if not verify_data %}
            <section class="no-recommendation">
                <p>æœ¬æ—¥ã®ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
                <p class="sub">å–¶æ¥­ä¸­ã«ãƒ‡ãƒ¼ã‚¿ãŒè“„ç©ã•ã‚Œã‚‹ã¨çš„ä¸­çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
            </section>
            {% else %}

            <!-- çš„ä¸­ç‡ã‚µãƒãƒª -->
            <section class="verify-summary">
                <div class="verify-accuracy">
                    <div class="accuracy-circle {% if accuracy >= 60 %}good{% elif accuracy >= 40 %}ok{% else %}bad{% endif %}">
                        <span class="accuracy-num">{{ accuracy|int }}%</span>
                        <span class="accuracy-label">ç·åˆçš„ä¸­ç‡</span>
                    </div>
                    <div class="accuracy-detail">
                        <div class="accuracy-row">
                            <span class="acc-label">å…¨{{ total_all_units }}å°ä¸­ã®å¥½èª¿å°</span>
                            <span class="acc-value">{{ total_good_all }}å°</span>
                        </div>
                        <div class="accuracy-row">
                            <span class="acc-label">ã€€ã†ã¡S/Aäºˆæ¸¬ â†’ å¥½èª¿</span>
                            <span class="acc-value hit">{{ actual_good }}/{{ predicted_good }}å°</span>
                        </div>
                        <div class="accuracy-row">
                            <span class="acc-label">ã€€ã†ã¡Bä»¥ä¸‹äºˆæ¸¬ â†’ å¥½èª¿</span>
                            <span class="acc-value surprise">{{ surprise_good }}å°ï¼ˆäºˆæƒ³ãƒã‚ºãƒ¬ï¼‰</span>
                        </div>
                    </div>
                </div>

            </section>

            <!-- ğŸ† çš„ä¸­ãƒã‚¤ãƒ©ã‚¤ãƒˆ -->
            {% if perfect_stores %}
            <section class="perfect-highlight">
                <h2>ğŸ† çš„ä¸­ãƒã‚¤ãƒ©ã‚¤ãƒˆ</h2>
                <div class="perfect-list">
                    {% for ps in perfect_stores %}
                    <a class="perfect-card" href="#{{ ps.store_id }}">
                        <span class="perfect-icon">{{ ps.machine_icon }}</span>
                        <div class="perfect-info">
                            <span class="perfect-store">{{ ps.store_name }}</span>
                            <span class="perfect-machine">{{ ps.machine_name }}</span>
                        </div>
                        <span class="perfect-badge">
                            {% if ps.rate >= 100 %}å…¨{{ ps.total_units }}å°çš„ä¸­ï¼
                            {% else %}{{ ps.total_units }}å°ä¸­{{ ps.hit_count }}å°çš„ä¸­ï¼ˆ{{ ps.rate|int }}%ï¼‰
                            {% endif %}
                        </span>
                        <span class="perfect-arrow">â€º</span>
                    </a>
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            <!-- ãƒˆãƒ”ãƒƒã‚¯ -->
            {% if topics %}
            <section class="topics-section">
                <h2>ğŸ“‹ ãƒˆãƒ”ãƒƒã‚¯</h2>
                {% for t in topics %}
                <div class="topic-card topic-{{ t.type }}">
                    <span class="topic-icon">{{ t.icon }}</span>
                    <div class="topic-body">
                        <div class="topic-title">{{ t.title }}</div>
                        <div class="topic-detail"><span class="td-machine">{{ t.machine }}</span> â€” {{ t.detail|safe }}</div>
                    </div>
                </div>
                {% endfor %}
            </section>
            {% endif %}

            <!-- äºˆæ¸¬ vs å®Ÿç¸¾ãƒ†ãƒ¼ãƒ–ãƒ« -->
            {% for machine_name, machine_data in verify_data.items() %}
            <section class="verify-section">
                <h2>{{ machine_data.icon }} {{ machine_data.name }}</h2>

                {% for store in machine_data.stores %}
                <div class="verify-store" id="store-{{ machine_name }}-{{ loop.index0 }}">
                    <div class="verify-store-header">
                        <h3 class="verify-store-name">{{ store.name }}</h3>
                        {% if store.sa_total > 0 %}
                        <span class="store-acc {% if store.sa_rate >= 80 %}good{% elif store.sa_rate >= 50 %}ok{% else %}bad{% endif %}">
                            çš„ä¸­{{ store.sa_rate|int }}% ({{ store.sa_hit }}/{{ store.sa_total }})
                        </span>
                        {% endif %}
                    </div>
                    <div class="verify-table-wrap">
                    <table class="verify-table">
                        <thead>
                            <tr>
                                <th class="vt-unit">å°ç•ª</th>
                                <th class="vt-pred">äºˆ</th>
                                <th class="vt-result">çµ</th>
                                <th class="vt-label">åˆ¤å®š</th>
                                <th class="vt-art">ART</th>
                                <th class="vt-prob">ç¢ºç‡</th>
                                <th class="vt-diff">å·®æš</th>
                                <th class="vt-max">æœ€å¤§</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for unit in store.units %}
                        {% set pred_good = unit.pre_open_rank in ('S', 'A') %}
                        {% set result_good = unit.actual_is_good is defined and unit.actual_is_good %}
                        {% set result_excellent = result_good and unit.actual_prob <= 100 %}
                        {% set pred_excellent = unit.pre_open_rank == 'S' and unit.pre_open_score >= 75 %}
                        {% set result_bad = unit.actual_prob >= 200 %}
                        {% set pred_bad = unit.pre_open_rank in ('C', 'D') %}
                        {% set label_class %}{% if unit.verdict_class == 'nodata' %}nodata{% elif pred_good and result_excellent %}perfect{% elif pred_good and result_good %}hit{% elif pred_good and result_bad %}miss{% elif pred_good %}neutral{% elif pred_bad and result_good %}miss{% elif pred_bad and not result_good %}hit{% else %}neutral{% endif %}{% endset %}
                        <tr class="verify-row verdict-{{ unit.verdict_class }}{% if unit.history %} has-detail{% endif %}" onclick="toggleDetail(this)">
                            <td class="vt-unit">{{ unit.unit_id|pad_id }}</td>
                            <td class="vt-pred">
                                {% if pred_excellent %}<span class="vr-mark excellent">â—</span>
                                {% elif pred_good %}<span class="vr-mark good">â—¯</span>
                                {% elif unit.pre_open_rank == 'B' %}<span class="vr-mark neutral">â–³</span>
                                {% else %}<span class="vr-mark bad">âœ•</span>{% endif %}
                            </td>
                            <td class="vt-result">
                                {% if unit.verdict_class == 'perfect' or (result_good and unit.actual_prob <= 100) %}<span class="vr-mark excellent">â—</span>
                                {% elif result_good %}<span class="vr-mark good">â—¯</span>
                                {% elif unit.actual_prob >= 200 %}<span class="vr-mark bad">âœ•</span>
                                {% elif unit.actual_prob > 0 %}<span class="vr-mark neutral">â–³</span>
                                {% else %}<span class="vr-mark nodata">-</span>{% endif %}
                            </td>
                            <td class="vt-label verdict-label-{{ label_class }}">
                                {% if unit.verdict_class == 'nodata' %}â€”{% elif pred_excellent and result_excellent %}å¤§çš„ä¸­ï¼{% elif pred_good and result_excellent %}çš„ä¸­ï¼{% elif pred_good and result_good %}çš„ä¸­{% elif pred_good and result_bad %}ãƒã‚ºãƒ¬{% elif pred_good %}ãŠã—ã„{% elif pred_bad and result_excellent %}å¤§ãƒã‚ºãƒ¬{% elif pred_bad and result_good %}ãƒã‚ºãƒ¬{% elif pred_bad and result_bad %}çš„ä¸­{% elif pred_bad %}çš„ä¸­{% elif result_good %}ãƒã‚ºãƒ¬{% elif result_bad %}çš„ä¸­{% else %}â€”{% endif %}
                            </td>
                            <td class="vt-art">{{ unit.actual_art if unit.actual_prob > 0 else '-' }}</td>
                            <td class="vt-prob {% if unit.actual_is_good and unit.actual_prob <= 100 %}excellent{% elif unit.actual_is_good %}good{% elif unit.actual_prob >= 200 %}bad{% endif %}">{% if unit.actual_prob > 0 %}1/{{ unit.actual_prob|int }}{% else %}-{% endif %}</td>
                            <td class="vt-diff {% if unit.diff_medals > 0 %}plus{% elif unit.diff_medals < 0 %}minus{% endif %}">{% if unit.diff_medals %}{{ '{:+,}'.format(unit.diff_medals|int) }}{% else %}-{% endif %}</td>
                            <td class="vt-max">{% if unit.max_medals %}{{ '{:,}'.format(unit.max_medals|int) }}{% else %}-{% endif %}</td>
                        </tr>
                            {# å±•é–‹å¯èƒ½ãªå½“ãŸã‚Šå±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ #}
                            {% if unit.history %}
                            <tr class="verify-detail-row hidden"><td colspan="8">
                            <div class="verify-detail-inner">
                                {# ã‚µãƒãƒªçµ±è¨ˆ #}
                                {% if unit.history_summary %}
                                <div class="vd-summary">
                                    <div class="vd-stat-grid">
                                        <div class="vd-stat">
                                            <span class="vd-stat-value">{{ '{:,}'.format(unit.history_summary.total_games) }}</span>
                                            <span class="vd-stat-label">ç·Gæ•°</span>
                                        </div>
                                        <div class="vd-stat">
                                            <span class="vd-stat-value">{{ unit.history_summary.total_hits }}</span>
                                            <span class="vd-stat-label">å½“ãŸã‚Šæ•°</span>
                                        </div>
                                        <div class="vd-stat{% if unit.history_summary.max_chain >= 5 %} hot{% endif %}">
                                            <span class="vd-stat-value">{{ unit.history_summary.max_chain }}é€£</span>
                                            <span class="vd-stat-label">æœ€å¤§é€£</span>
                                        </div>
                                        <div class="vd-stat">
                                            <span class="vd-stat-value">{{ unit.history_summary.avg_valley }}G</span>
                                            <span class="vd-stat-label">å¹³å‡è°·</span>
                                        </div>
                                        {% if unit.history_summary.tenjou_count > 0 %}
                                        <div class="vd-stat warn">
                                            <span class="vd-stat-value">{{ unit.history_summary.tenjou_count }}å›</span>
                                            <span class="vd-stat-label">å¤©äº•</span>
                                        </div>
                                        {% endif %}
                                        <div class="vd-stat{% if unit.history_summary.max_valley >= 500 %} deep{% endif %}">
                                            <span class="vd-stat-value">{{ unit.history_summary.max_valley }}G</span>
                                            <span class="vd-stat-label">æœ€æ·±</span>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                {# å½“ãŸã‚Šå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ« #}
                                <div class="vd-history-table">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>æ™‚åˆ»</th>
                                                <th>Gæ•°</th>
                                                <th>ç¨®é¡</th>
                                                <th>é€£</th>
                                                <th>æšæ•°</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for hit in unit.history %}
                                            <tr class="{% if hit.is_tenjou %}tenjou{% elif hit.is_hot_chain %}hot-chain{% elif hit.is_deep %}deep{% endif %}">
                                                <td class="vd-num">{{ hit.index }}</td>
                                                <td class="vd-time">{{ hit.time or '-' }}</td>
                                                <td class="vd-games {% if hit.is_deep %}deep{% elif hit.is_shallow %}shallow{% endif %}">{{ hit.start }}G</td>
                                                <td class="vd-type {{ hit.type|lower }}">{{ hit.type }}</td>
                                                <td class="vd-chain {% if hit.is_hot_chain %}hot{% endif %}">{% if hit.chain_pos is defined and hit.chain_pos > 1 %}{{ hit.chain_pos }}é€£{% elif hit.chain_len is defined and hit.chain_len == 1 %}-{% else %}-{% endif %}</td>
                                                <td class="vd-medals">{% if hit.medals > 0 %}{{ '{:,}'.format(hit.medals) }}{% else %}-{% endif %}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            </td></tr>
                            {% endif %}
                        {% endfor %}
                        </tbody>
                    </table>
                    </div>
                </div>
                {% endfor %}
            </section>
            {% endfor %}

            <!-- è¦‹æ–¹ -->
            <section class="verify-legend">
                <h3>è¦‹æ–¹</h3>
                <div class="legend-items">
                    <div class="legend-group">
                        <div class="legend-title">äºˆæƒ³</div>
                        <div class="legend-row"><span class="vr-mark excellent">â—</span> é‰„æ¿ï¼ˆSé«˜ã‚¹ã‚³ã‚¢ï¼‰</div>
                        <div class="legend-row"><span class="vr-mark good">â—¯</span> å¥½èª¿äºˆæƒ³ï¼ˆS/Aï¼‰</div>
                        <div class="legend-row"><span class="vr-mark neutral">â–³</span> å¾®å¦™ï¼ˆBï¼‰</div>
                        <div class="legend-row"><span class="vr-mark bad">âœ•</span> ãƒ€ãƒ¡äºˆæƒ³ï¼ˆC/Dï¼‰</div>
                    </div>
                    <div class="legend-group">
                        <div class="legend-title">çµæœ</div>
                        <div class="legend-row"><span class="vr-mark excellent">â—</span> çµ¶å¥½èª¿</div>
                        <div class="legend-row"><span class="vr-mark good">â—¯</span> å¥½èª¿</div>
                        <div class="legend-row"><span class="vr-mark neutral">â–³</span> æ™®é€š</div>
                        <div class="legend-row"><span class="vr-mark bad">âœ•</span> ä¸èª¿</div>
                    </div>
                </div>
            </section>

            {% endif %}
        </main>

        <footer>
            <p><a href="{{ url_for('index') }}" class="api-link">ãƒˆãƒƒãƒ—ã¸</a></p>
        </footer>
    </div>

    <script>
    function toggleDetail(rowEl) {
        var detailRow = rowEl.nextElementSibling;
        if (!detailRow || !detailRow.classList.contains('verify-detail-row')) return;

        var isHidden = detailRow.classList.contains('hidden');
        var table = rowEl.closest('.verify-table');
        if (table) {
            table.querySelectorAll('.verify-detail-row').forEach(function(d) { d.classList.add('hidden'); });
            table.querySelectorAll('.verify-row').forEach(function(r) { r.classList.remove('expanded'); });
        }

        if (isHidden) {
            detailRow.classList.remove('hidden');
            rowEl.classList.add('expanded');
        }
    }
    </script>
</body>
</html>
