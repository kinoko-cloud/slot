<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
    <meta name="googlebot" content="noindex, nofollow">
    <title>ç­”ãˆåˆã‚ã› - äºˆæ¸¬ç²¾åº¦æ¤œè¨¼</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <a href="{{ url_for('index') }}" class="back-link">&lt; ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</a>
            <h1>ç­”ãˆåˆã‚ã›</h1>
            <div class="update-info">
                {{ result_date_str }}ã®å®Ÿç¸¾ã§ç­”ãˆåˆã‚ã›<br>
                <small>äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿: {{ predict_base }}ã¾ã§ã®è“„ç©ãƒ‡ãƒ¼ã‚¿ã§äºˆæ¸¬</small>
            </div>
        </header>

        <main>
            {% if not verify_data %}
            <section class="no-recommendation">
                <p>æœ¬æ—¥ã®ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
                <p class="sub">å–¶æ¥­ä¸­ã«ãƒ‡ãƒ¼ã‚¿ãŒè“„ç©ã•ã‚Œã‚‹ã¨ç­”ãˆåˆã‚ã›ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
            </section>
            {% else %}

            <!-- çš„ä¸­ç‡ã‚µãƒãƒª -->
            <section class="verify-summary">
                <div class="verify-accuracy">
                    <div class="accuracy-circle {% if accuracy >= 60 %}good{% elif accuracy >= 40 %}ok{% else %}bad{% endif %}">
                        <span class="accuracy-num">{{ accuracy|int }}%</span>
                        <span class="accuracy-label">ç·åˆçš„ä¸­ç‡</span>
                    </div>
                    <div class="accuracy-detail">
                        <div class="accuracy-row">
                            <span class="acc-label">å…¨{{ total_all_units }}å°ä¸­ã®å¥½èª¿å°</span>
                            <span class="acc-value">{{ total_good_all }}å°</span>
                        </div>
                        <div class="accuracy-row">
                            <span class="acc-label">ã€€ã†ã¡S/Aäºˆæ¸¬ â†’ å¥½èª¿</span>
                            <span class="acc-value hit">{{ actual_good }}/{{ predicted_good }}å°</span>
                        </div>
                        <div class="accuracy-row">
                            <span class="acc-label">ã€€ã†ã¡Bä»¥ä¸‹äºˆæ¸¬ â†’ å¥½èª¿</span>
                            <span class="acc-value surprise">{{ surprise_good }}å°ï¼ˆäºˆæ¸¬å¤–ï¼‰</span>
                        </div>
                    </div>
                </div>

                <!-- æ©Ÿç¨®åˆ¥ã®çš„ä¸­ç‡ -->
                {% if machine_accuracy %}
                <div class="machine-accuracy-breakdown">
                    {% for ma in machine_accuracy %}
                    <div class="machine-acc-card">
                        <div class="mac-header">
                            <span class="ma-icon">{{ ma.icon }}</span>
                            <span class="ma-name">{{ ma.name }}</span>
                            <span class="ma-rate {% if ma.rate >= 60 %}good{% elif ma.rate >= 40 %}ok{% else %}bad{% endif %}">{{ ma.rate|int }}%</span>
                        </div>
                        <div class="mac-body">
                            <div class="mac-row">å…¨{{ ma.all_units }}å°ä¸­ â†’ å¥½èª¿{{ ma.total_good }}å°</div>
                            <div class="mac-row">S/Aäºˆæ¸¬{{ ma.total }}å°ä¸­ â†’ çš„ä¸­{{ ma.hit }}å°</div>
                            {% if ma.surprise > 0 %}
                            <div class="mac-row mac-miss">Bä»¥ä¸‹{{ ma.all_units - ma.total }}å°ä¸­ â†’ {{ ma.surprise }}å°ãŒå¥½èª¿ï¼ˆè¦‹é€ƒã—ï¼‰</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </section>

            <!-- åˆ†æãƒ»ä»®èª¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            {% if hypotheses %}
            <section class="hypotheses-section">
                <h2>ğŸ” ãªãœå¤–ã—ãŸï¼Ÿåˆ†æã¨ä»®èª¬</h2>
                {% for h in hypotheses %}
                <div class="hypothesis-card">
                    <div class="hyp-title">ğŸ’¡ {{ h.hypothesis }}</div>
                    <div class="hyp-evidence">ğŸ“Š æ ¹æ‹ : {{ h.evidence }}</div>
                    <div class="hyp-action">ğŸ”§ æ”¹å–„æ¡ˆ: {{ h.action }}</div>
                    <div class="hyp-confidence">ä¿¡é ¼åº¦: {{ h.confidence }}</div>
                </div>
                {% endfor %}
            </section>
            {% endif %}

            <!-- äºˆæ¸¬ vs å®Ÿç¸¾ãƒ†ãƒ¼ãƒ–ãƒ« -->
            {% for machine_name, machine_data in verify_data.items() %}
            <section class="verify-section">
                <h2>{{ machine_data.icon }} {{ machine_data.name }}</h2>

                {% for store in machine_data.stores %}
                <div class="verify-store">
                    <div class="verify-store-header">
                        <h3 class="verify-store-name">{{ store.name }}</h3>
                        {% if store.sa_total > 0 %}
                        <span class="store-acc {% if store.sa_rate >= 80 %}good{% elif store.sa_rate >= 50 %}ok{% else %}bad{% endif %}">
                            çš„ä¸­{{ store.sa_rate|int }}% ({{ store.sa_hit }}/{{ store.sa_total }})
                        </span>
                        {% endif %}
                    </div>
                    <div class="verify-table">
                        <div class="verify-header-row">
                            <span class="vh-unit">å°ç•ª</span>
                            <span class="vh-pred">æœäºˆæ¸¬</span>
                            <span class="vh-art">ART</span>
                            <span class="vh-prob">ARTç¢ºç‡</span>
                            <span class="vh-result">åˆ¤å®š</span>
                        </div>
                        {% for unit in store.units %}
                        <div class="verify-row-wrapper">
                            <div class="verify-row verdict-{{ unit.verdict_class }}{% if unit.history %} has-detail{% endif %}" onclick="toggleDetail(this)">
                                <span class="vr-unit">{{ unit.unit_id|pad_id }}</span>
                                <span class="vr-pred">
                                    <span class="rank-badge-xs" style="background-color: {{ rank_color(unit.pre_open_rank) }}">{{ unit.pre_open_rank }}</span>
                                    <span class="vr-score">{{ unit.pre_open_score|int }}pt</span>
                                </span>
                                <span class="vr-art">{{ unit.actual_art }}</span>
                                <span class="vr-prob {% if unit.actual_prob > 0 and unit.actual_prob <= 100 %}excellent{% elif unit.actual_prob > 0 and unit.actual_prob <= 130 %}good{% elif unit.actual_prob >= 200 %}bad{% endif %}">
                                    {% if unit.actual_prob > 0 %}1/{{ unit.actual_prob|int }}{% else %}-{% endif %}
                                </span>
                                <span class="vr-verdict">{{ unit.verdict }}{% if unit.history %}<span class="vr-expand-icon">â–¼</span>{% endif %}</span>
                            </div>

                            {# å±•é–‹å¯èƒ½ãªå½“ãŸã‚Šå±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ #}
                            {% if unit.history %}
                            <div class="verify-detail hidden">
                                {# ã‚µãƒãƒªçµ±è¨ˆ #}
                                {% if unit.history_summary %}
                                <div class="vd-summary">
                                    <div class="vd-stat-grid">
                                        <div class="vd-stat">
                                            <span class="vd-stat-value">{{ '{:,}'.format(unit.history_summary.total_games) }}</span>
                                            <span class="vd-stat-label">ç·Gæ•°</span>
                                        </div>
                                        <div class="vd-stat">
                                            <span class="vd-stat-value">{{ unit.history_summary.total_hits }}</span>
                                            <span class="vd-stat-label">å½“ãŸã‚Šæ•°</span>
                                        </div>
                                        <div class="vd-stat{% if unit.history_summary.max_chain >= 5 %} hot{% endif %}">
                                            <span class="vd-stat-value">{{ unit.history_summary.max_chain }}é€£</span>
                                            <span class="vd-stat-label">æœ€å¤§é€£</span>
                                        </div>
                                        <div class="vd-stat">
                                            <span class="vd-stat-value">{{ unit.history_summary.avg_valley }}G</span>
                                            <span class="vd-stat-label">å¹³å‡è°·</span>
                                        </div>
                                        {% if unit.history_summary.tenjou_count > 0 %}
                                        <div class="vd-stat warn">
                                            <span class="vd-stat-value">{{ unit.history_summary.tenjou_count }}å›</span>
                                            <span class="vd-stat-label">å¤©äº•</span>
                                        </div>
                                        {% endif %}
                                        <div class="vd-stat{% if unit.history_summary.max_valley >= 500 %} deep{% endif %}">
                                            <span class="vd-stat-value">{{ unit.history_summary.max_valley }}G</span>
                                            <span class="vd-stat-label">æœ€æ·±</span>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                {# å½“ãŸã‚Šå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ« #}
                                <div class="vd-history-table">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>æ™‚åˆ»</th>
                                                <th>Gæ•°</th>
                                                <th>ç¨®é¡</th>
                                                <th>é€£</th>
                                                <th>æšæ•°</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for hit in unit.history %}
                                            <tr class="{% if hit.is_tenjou %}tenjou{% elif hit.is_hot_chain %}hot-chain{% elif hit.is_deep %}deep{% endif %}">
                                                <td class="vd-num">{{ hit.index }}</td>
                                                <td class="vd-time">{{ hit.time or '-' }}</td>
                                                <td class="vd-games {% if hit.is_deep %}deep{% elif hit.is_shallow %}shallow{% endif %}">{{ hit.start }}G</td>
                                                <td class="vd-type {{ hit.type|lower }}">{{ hit.type }}</td>
                                                <td class="vd-chain {% if hit.is_hot_chain %}hot{% endif %}">{% if hit.chain_pos is defined and hit.chain_pos > 1 %}{{ hit.chain_pos }}é€£{% elif hit.chain_len is defined and hit.chain_len == 1 %}-{% else %}-{% endif %}</td>
                                                <td class="vd-medals">{% if hit.medals > 0 %}{{ '{:,}'.format(hit.medals) }}{% else %}-{% endif %}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </section>
            {% endfor %}

            <!-- åˆ¤å®šåŸºæº– -->
            <section class="verify-legend">
                <h3>åˆ¤å®šåŸºæº–</h3>
                <div class="legend-items">
                    <div class="legend-row"><span class="verdict-icon">&#x25CE;</span> å®Œç’§: äºˆæ¸¬S/A â†’ å®Ÿéš›ã«åˆæˆ1/100ä»¥ä¸‹</div>
                    <div class="legend-row"><span class="verdict-icon">&#x25CB;</span> çš„ä¸­: äºˆæ¸¬S/A â†’ å®Ÿéš›ã«åˆæˆ1/130ä»¥ä¸‹</div>
                    <div class="legend-row"><span class="verdict-icon">&#x25B3;</span> æ™®é€š: äºˆæ¸¬é€šã‚Šã®å¹³å‡¡ãªçµæœ</div>
                    <div class="legend-row"><span class="verdict-icon">&#x2715;</span> å¤–ã‚Œ: äºˆæ¸¬S/A â†’ å®Ÿéš›ã«åˆæˆ1/200ä»¥ä¸Š</div>
                    <div class="legend-row"><span class="verdict-icon">&#x2605;</span> æƒ³å®šå¤–: äºˆæ¸¬Bä»¥ä¸‹ã ã£ãŸãŒå®Ÿéš›ã¯å¥½èª¿ï¼ˆæƒ³å®šå¤–ã®å¥½å°ï¼‰</div>
                </div>
            </section>

            {% endif %}
        </main>

        <footer>
            <p><a href="{{ url_for('index') }}" class="api-link">ãƒˆãƒƒãƒ—ã¸</a></p>
        </footer>
    </div>

    <script>
    function toggleDetail(rowEl) {
        var wrapper = rowEl.closest('.verify-row-wrapper');
        if (!wrapper) return;
        var detail = wrapper.querySelector('.verify-detail');
        if (!detail) return;

        var isHidden = detail.classList.contains('hidden');
        // Close all others in the same store
        var store = wrapper.closest('.verify-table');
        if (store) {
            store.querySelectorAll('.verify-detail').forEach(function(d) {
                d.classList.add('hidden');
            });
            store.querySelectorAll('.verify-row').forEach(function(r) {
                r.classList.remove('expanded');
            });
        }

        if (isHidden) {
            detail.classList.remove('hidden');
            rowEl.classList.add('expanded');
        }
    }
    </script>
</body>
</html>
