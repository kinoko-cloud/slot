<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
    <meta name="googlebot" content="noindex, nofollow">
    <title>答え合わせ - 予測精度検証</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <a href="{{ url_for('index') }}" class="back-link">&lt; トップに戻る</a>
            <h1>答え合わせ</h1>
            <div class="update-info">開店前の予測（過去データのみ）で当日の好調台を当てられたか？</div>
        </header>

        <main>
            {% if not verify_data %}
            <section class="no-recommendation">
                <p>本日のデータがまだありません</p>
                <p class="sub">営業中にデータが蓄積されると答え合わせが表示されます</p>
            </section>
            {% else %}

            <!-- 的中率サマリ -->
            <section class="verify-summary">
                <div class="verify-accuracy">
                    <div class="accuracy-circle {% if accuracy >= 60 %}good{% elif accuracy >= 40 %}ok{% else %}bad{% endif %}">
                        <span class="accuracy-num">{{ accuracy|int }}%</span>
                        <span class="accuracy-label">総合的中率</span>
                    </div>
                    <div class="accuracy-detail">
                        <div class="accuracy-row">
                            <span class="acc-label">予測S/A台</span>
                            <span class="acc-value">{{ predicted_good }}台</span>
                        </div>
                        <div class="accuracy-row">
                            <span class="acc-label">実際に好調</span>
                            <span class="acc-value hit">{{ actual_good }}台</span>
                        </div>
                        <div class="accuracy-row">
                            <span class="acc-label">予測外の好調</span>
                            <span class="acc-value surprise">{{ surprise_good }}台</span>
                        </div>
                    </div>
                </div>

                <!-- 機種別の的中率 -->
                {% if machine_accuracy %}
                <div class="machine-accuracy-breakdown">
                    {% for ma in machine_accuracy %}
                    <div class="machine-acc-row">
                        <span class="ma-icon">{{ ma.icon }}</span>
                        <span class="ma-name">{{ ma.name }}</span>
                        <span class="ma-rate {% if ma.rate >= 60 %}good{% elif ma.rate >= 40 %}ok{% else %}bad{% endif %}">{{ ma.rate|int }}%</span>
                        <span class="ma-detail">{{ ma.hit }}/{{ ma.total }} 的中</span>
                        {% if ma.surprise > 0 %}
                        <span class="ma-surprise">+{{ ma.surprise }}台発掘</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </section>

            <!-- 予測 vs 実績テーブル -->
            {% for machine_name, machine_data in verify_data.items() %}
            <section class="verify-section">
                <h2>{{ machine_data.icon }} {{ machine_data.name }}</h2>

                {% for store in machine_data.stores %}
                <div class="verify-store">
                    <div class="verify-store-header">
                        <h3 class="verify-store-name">{{ store.name }}</h3>
                        {% if store.sa_total > 0 %}
                        <span class="store-acc {% if store.sa_rate >= 80 %}good{% elif store.sa_rate >= 50 %}ok{% else %}bad{% endif %}">
                            的中{{ store.sa_rate|int }}% ({{ store.sa_hit }}/{{ store.sa_total }})
                        </span>
                        {% endif %}
                    </div>
                    <div class="verify-table">
                        <div class="verify-header-row">
                            <span class="vh-unit">台番</span>
                            <span class="vh-pred">朝予測</span>
                            <span class="vh-art">ART</span>
                            <span class="vh-prob">ART確率</span>
                            <span class="vh-result">判定</span>
                        </div>
                        {% for unit in store.units %}
                        <div class="verify-row-wrapper">
                            <div class="verify-row verdict-{{ unit.verdict_class }}{% if unit.history %} has-detail{% endif %}" onclick="toggleDetail(this)">
                                <span class="vr-unit">{{ unit.unit_id|pad_id }}</span>
                                <span class="vr-pred">
                                    <span class="rank-badge-xs" style="background-color: {{ rank_color(unit.pre_open_rank) }}">{{ unit.pre_open_rank }}</span>
                                    <span class="vr-score">{{ unit.pre_open_score|int }}pt</span>
                                </span>
                                <span class="vr-art">{{ unit.actual_art }}</span>
                                <span class="vr-prob {% if unit.actual_prob > 0 and unit.actual_prob <= 100 %}excellent{% elif unit.actual_prob > 0 and unit.actual_prob <= 130 %}good{% elif unit.actual_prob >= 200 %}bad{% endif %}">
                                    {% if unit.actual_prob > 0 %}1/{{ unit.actual_prob|int }}{% else %}-{% endif %}
                                </span>
                                <span class="vr-verdict">{{ unit.verdict }}{% if unit.history %}<span class="vr-expand-icon">▼</span>{% endif %}</span>
                            </div>

                            {# 展開可能な当たり履歴セクション #}
                            {% if unit.history %}
                            <div class="verify-detail hidden">
                                {# サマリ統計 #}
                                {% if unit.history_summary %}
                                <div class="vd-summary">
                                    <div class="vd-stat-grid">
                                        <div class="vd-stat">
                                            <span class="vd-stat-value">{{ '{:,}'.format(unit.history_summary.total_games) }}</span>
                                            <span class="vd-stat-label">総G数</span>
                                        </div>
                                        <div class="vd-stat">
                                            <span class="vd-stat-value">{{ unit.history_summary.total_hits }}</span>
                                            <span class="vd-stat-label">当たり数</span>
                                        </div>
                                        <div class="vd-stat{% if unit.history_summary.max_chain >= 5 %} hot{% endif %}">
                                            <span class="vd-stat-value">{{ unit.history_summary.max_chain }}連</span>
                                            <span class="vd-stat-label">最大連</span>
                                        </div>
                                        <div class="vd-stat">
                                            <span class="vd-stat-value">{{ unit.history_summary.avg_valley }}G</span>
                                            <span class="vd-stat-label">平均谷</span>
                                        </div>
                                        {% if unit.history_summary.tenjou_count > 0 %}
                                        <div class="vd-stat warn">
                                            <span class="vd-stat-value">{{ unit.history_summary.tenjou_count }}回</span>
                                            <span class="vd-stat-label">天井</span>
                                        </div>
                                        {% endif %}
                                        <div class="vd-stat{% if unit.history_summary.max_valley >= 500 %} deep{% endif %}">
                                            <span class="vd-stat-value">{{ unit.history_summary.max_valley }}G</span>
                                            <span class="vd-stat-label">最深</span>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                {# 当たり履歴テーブル #}
                                <div class="vd-history-table">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>時刻</th>
                                                <th>G数</th>
                                                <th>種類</th>
                                                <th>連</th>
                                                <th>枚数</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for hit in unit.history %}
                                            <tr class="{% if hit.is_tenjou %}tenjou{% elif hit.is_hot_chain %}hot-chain{% elif hit.is_deep %}deep{% endif %}">
                                                <td class="vd-num">{{ hit.index }}</td>
                                                <td class="vd-time">{{ hit.time or '-' }}</td>
                                                <td class="vd-games {% if hit.is_deep %}deep{% elif hit.is_shallow %}shallow{% endif %}">{{ hit.start }}G</td>
                                                <td class="vd-type {{ hit.type|lower }}">{{ hit.type }}</td>
                                                <td class="vd-chain {% if hit.is_hot_chain %}hot{% endif %}">{% if hit.chain_pos is defined and hit.chain_pos > 1 %}{{ hit.chain_pos }}連{% elif hit.chain_len is defined and hit.chain_len == 1 %}-{% else %}-{% endif %}</td>
                                                <td class="vd-medals">{% if hit.medals > 0 %}{{ '{:,}'.format(hit.medals) }}{% else %}-{% endif %}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </section>
            {% endfor %}

            <!-- 判定基準 -->
            <section class="verify-legend">
                <h3>判定基準</h3>
                <div class="legend-items">
                    <div class="legend-row"><span class="verdict-icon">&#x25CE;</span> 完璧: 予測S/A → 実際に合成1/100以下</div>
                    <div class="legend-row"><span class="verdict-icon">&#x25CB;</span> 的中: 予測S/A → 実際に合成1/130以下</div>
                    <div class="legend-row"><span class="verdict-icon">&#x25B3;</span> 普通: 予測通りの平凡な結果</div>
                    <div class="legend-row"><span class="verdict-icon">&#x2715;</span> 外れ: 予測S/A → 実際に合成1/200以上</div>
                    <div class="legend-row"><span class="verdict-icon">&#x2605;</span> 発掘: 予測B以下 → 実際に合成1/130以下（お宝台）</div>
                </div>
            </section>

            {% endif %}
        </main>

        <footer>
            <p><a href="{{ url_for('index') }}" class="api-link">トップへ</a></p>
        </footer>
    </div>

    <script>
    function toggleDetail(rowEl) {
        var wrapper = rowEl.closest('.verify-row-wrapper');
        if (!wrapper) return;
        var detail = wrapper.querySelector('.verify-detail');
        if (!detail) return;

        var isHidden = detail.classList.contains('hidden');
        // Close all others in the same store
        var store = wrapper.closest('.verify-table');
        if (store) {
            store.querySelectorAll('.verify-detail').forEach(function(d) {
                d.classList.add('hidden');
            });
            store.querySelectorAll('.verify-row').forEach(function(r) {
                r.classList.remove('expanded');
            });
        }

        if (isHidden) {
            detail.classList.remove('hidden');
            rowEl.classList.add('expanded');
        }
    }
    </script>
</body>
</html>
