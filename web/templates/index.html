{# === ç›´è¿‘ãƒ‡ãƒ¼ã‚¿å±•é–‹ãƒã‚¯ãƒ­ === #}
{# day_hist: _process_history_for_verify()ã§åŠ å·¥æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ï¼ˆchain_pos, is_hot_chain, is_tenjou, accumulated_gamesç­‰ä»˜ãï¼‰ #}
{# SBJ: RBã§ã¯ã‚²ãƒ¼ãƒ æ•°å¤©äº•ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œãªã„ â†’ accumulated_gamesã§å¤©äº•åˆ¤å®š #}
{% macro recent_day_expandable(day_art, day_prob, day_date, day_label, day_diff, day_rensa, day_max_m, day_hist) %}
{% if day_art > 0 %}
<div class="recent-day-block">
    <div class="recent-day-row {% if day_hist and day_hist|length > 0 %}has-detail{% endif %}" onclick="{% if day_hist and day_hist|length > 0 %}toggleRecentDayDetail(event, this){% endif %}">
        <span class="recent-label">{{ short_date(day_date) or day_label }}</span>
        <span class="recent-art">ART {{ day_art }}</span>
        {% if day_prob > 0 %}<span class="recent-prob {% if day_prob <= 100 %}excellent{% elif day_prob <= 130 %}good{% elif day_prob >= 200 %}bad{% endif %}">1/{{ day_prob }}</span>{% endif %}
        {% if day_diff != 0 %}<span class="diff-medals-sm {% if day_diff > 0 %}plus{% else %}minus{% endif %}">{{ '{:+,}'.format(day_diff) }}æš</span>{% endif %}
        {% if day_rensa >= 3 %}<span class="rensa-sm">{{ day_rensa }}é€£</span>{% endif %}
        {% if day_max_m > 0 %}<span class="max-medals-sm">æœ€å¤§{{ '{:,}'.format(day_max_m) }}æš</span>{% endif %}
        {% if day_hist and day_hist|length > 0 %}<span class="expand-icon small">â–¼</span>{% endif %}
    </div>
    {% if day_hist and day_hist|length > 0 %}
    <div class="recent-day-detail hidden">
        <table class="hit-detail-table compact">
            <thead><tr><th>#</th><th>æ™‚åˆ»</th><th>Gæ•°</th><th>ç¨®é¡</th><th>é€£</th><th>æšæ•°</th></tr></thead>
            <tbody>
            {% for h in day_hist %}
            <tr class="{% if h.is_tenjou is defined and h.is_tenjou %}tenjou{% elif h.is_hot_chain is defined and h.is_hot_chain %}hot-chain{% elif h.is_deep is defined and h.is_deep %}deep{% elif h.start is defined and h.start >= 500 %}deep{% endif %}{% if h.is_shallow is defined and h.is_shallow %} shallow{% elif h.start is defined and h.start <= 10 %} shallow{% endif %}">
                <td>{{ h.index|default(loop.index) }}</td>
                <td>{{ h.time or '-' }}</td>
                <td class="{% if h.is_tenjou is defined and h.is_tenjou %}tenjou{% elif h.is_deep is defined and h.is_deep %}deep{% endif %}{% if h.is_shallow is defined and h.is_shallow %} shallow{% endif %}">{{ h.start }}G{% if h.is_tenjou is defined and h.is_tenjou and h.accumulated_games is defined and h.accumulated_games != h.start %}<br><small class="acc-games">ç´¯è¨ˆ{{ h.accumulated_games }}G</small>{% endif %}</td>
                <td class="{{ h.type|lower }}">{{ h.type }}</td>
                <td class="{% if h.is_hot_chain is defined and h.is_hot_chain %}hot{% endif %}">{% if h.chain_pos is defined and h.chain_pos > 1 %}{{ h.chain_pos }}é€£{% else %}-{% endif %}</td>
                <td>{% if h.medals is defined and h.medals > 0 %}{{ '{:,}'.format(h.medals) }}{% else %}-{% endif %}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>
{% endif %}
{% endmacro %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
    <meta name="googlebot" content="noindex, nofollow">
    <title>æœ¬æ—¥ã®ãŠã™ã™ã‚å°</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{ cache_bust }}">
</head>
<body data-page-type="index">
    <div class="container">
        {# === ãƒˆãƒƒãƒ—ãƒãƒ¼ï¼ˆå…±é€šï¼‰ === #}
        {% include '_topbar.html' %}
        {# === ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ === #}
        <nav id="hamburger-menu" class="hamburger-menu hidden">
            <a href="#" onclick="window.scrollTo({top:0,behavior:'smooth'});document.getElementById('hamburger-menu').classList.add('hidden');return false;">ğŸ  ãƒˆãƒƒãƒ—</a>
            <a href="#top3-section">ğŸ“Š ãŠã™ã™ã‚å°</a>
            <a href="#explosion-section">ğŸ’¥ çˆ†ç™ºå°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
            <a href="{{ url_for('verify') }}">ğŸ† çš„ä¸­çµæœ</a>
            <div class="hm-divider"></div>
            <div class="hm-label">ğŸª åº—èˆ—åˆ¥</div>
            {% for store in store_nav_links %}
            <div class="hm-store">
                <span class="hm-store-name">{{ store.name }}</span>
                {% for ml in store.machine_links %}
                <a href="{{ url_for('recommend', store_key=ml.store_key) }}" class="hm-machine">{{ ml.icon }} {{ ml.machine_name }}</a>
                {% endfor %}
            </div>
            {% endfor %}
        </nav>
        <header>
            <h1><span class="title-main">{{ next_day_prefix }} {{ next_day_str }}ã®ãŠã™ã™ã‚å°</span></h1>
            <div class="mode-line">
                {% if display_mode == 'before_open' %}
                <div class="mode-badge before-open">ğŸŒ™ å–¶æ¥­å‰</div>
                {% elif display_mode == 'after_close' %}
                <div class="mode-badge after-close">ğŸ”’ é–‰åº—å¾Œ</div>
                {% else %}
                <div class="mode-badge realtime">ğŸŸ¢ å–¶æ¥­ä¸­</div>
                {% endif %}
                <span class="current-time" id="current-time"></span>
            </div>
            <div class="realtime-bar">
                <span id="realtime-status" class="realtime-status">èª­è¾¼ä¸­...</span>
                <button onclick="refreshData()" class="refresh-btn">ğŸ”„ æ›´æ–°</button>
            </div>
        </header>

        <main>
            {# === çµæœãƒãƒŠãƒ¼ === #}
            <a href="{{ url_for('verify') }}" class="verify-banner-lg">
                <div class="vb-circles-row">
                    {% if verify_categories %}
                    {% for cat in verify_categories %}
                    <div class="vb-circle-item">
                        <div class="vb-circle {% if cat.rate >= 100 %}rainbow{% elif cat.rate >= 85 %}hot{% elif cat.rate >= 70 %}good{% elif cat.rate >= 55 %}warm{% elif cat.rate >= 40 %}ok{% elif cat.rate >= 25 %}cool{% elif cat.rate >= 10 %}cold{% else %}ice{% endif %}">
                            <span class="vb-circle-num">{{ cat.rate }}%</span>
                        </div>
                        <span class="vb-circle-label"><span class="vb-mk">{{ cat.mk_name }}</span><br>{{ cat.store_name }}</span>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
                <div class="vb-lg-info">
                    <span class="vb-title-lg">{% if verify_date_str %}{{ verify_date_str }}{% else %}æ˜¨æ—¥{% endif %}ã®çš„ä¸­ç‡</span>
                    {% if verify_highlights %}
                    <div class="vb-highlights-row">
                        {% for h in verify_highlights %}
                        <span class="vb-highlight">{{ h }}</span>
                        {% endfor %}
                        <span class="vb-detail-lg">è©³ã—ãè¦‹ã‚‹ â†’</span>
                    </div>
                    {% else %}
                    <span class="vb-detail-lg">è©³ã—ãè¦‹ã‚‹ â†’</span>
                    {% endif %}
                </div>
            </a>

            {# === ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰ === #}
            <div class="nav-dropdowns">
                <a href="#top3-section" class="nav-pill">ğŸ“Š ãŠã™ã™ã‚å°</a>
                <a href="#explosion-section" class="nav-pill">ğŸ’¥ çˆ†ç™ºå°</a>
                <div class="nav-dropdown">
                    <button class="nav-pill dropdown-toggle" onclick="this.parentElement.classList.toggle('open')">ğŸª åº—èˆ—åˆ¥ â–¾</button>
                    <div class="dropdown-content">
                        {% for store in store_nav_links %}
                        <div class="dd-store">
                            <span class="dd-store-name">{{ store.name }}</span>
                            <div class="dd-machines">
                                {% for ml in store.machine_links %}
                                <a href="{{ url_for('recommend', store_key=ml.store_key) }}">{{ ml.icon }} {{ ml.machine_name }}</a>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            {# === é–‰åº—å¾Œ: ãŠã™ã™ã‚å°ã‚’æœ€ä¸Šéƒ¨ã« === #}
            {% if display_mode in ('before_open', 'after_close') and top3 %}
            <section class="recommendations top" id="top3-section">
                <h2>{{ next_day_prefix }} {{ next_day_str }}ã®ãŠã™ã™ã‚å° TOP{{ [top3|length, 10]|min }}</h2>
                <div class="top5-note">{{ date_prefix }}ã®çµæœï¼‹éå»å‚¾å‘ã‹ã‚‰åˆ†æ</div>
                {% for rec in top3[:10] %}
                <a href="{{ url_for('recommend', store_key=rec.store_key) }}" class="unit-card rank-{{ rec.final_rank|lower }}" style="text-decoration: none; color: inherit;">
                    <div class="unit-header">
                        <span class="ranking-num">#{{ loop.index }}</span>
                        <span class="machine-icon">{{ rec.machine_icon }}</span>
                        <span class="machine-name-top">{{ rec.machine_name }}</span>
                        <span class="rank-badge" style="background-color: {{ rank_color(rec.final_rank) }}">{{ rec.final_rank }}</span>
                    </div>
                    <div class="unit-store">
                        <span class="unit-id-sub"><span class="unit-id-num-lg">{{ rec.unit_id|pad_id }}</span><span class="unit-id-ban">ç•ª</span></span>
                        <span class="store-link-right">{{ rec.store_name }}</span>
                    </div>
                    {# === 1. æ¨å¥¨ç†ç”±ï¼ˆæœ€é‡è¦ï¼‰ === #}
                    <div class="reasons-full">
                        {% if rec.reasons %}
                        {% for reason in rec.reasons %}
                        {% if 'ğŸ“Š' in reason %}
                        <div class="reason-line-top reason-rank">{{ reason }}</div>
                        {% elif 'ğŸ“ˆ' in reason %}
                        <div class="reason-line-top reason-stats">{{ reason }}</div>
                        {% elif 'ğŸ”' in reason %}
                        <div class="reason-line-top reason-cycle">{{ reason }}</div>
                        {% elif 'ğŸ”„' in reason %}
                        <div class="reason-line-top reason-pattern">{{ reason }}</div>
                        {% elif 'ğŸ’¡' in reason %}
                        <div class="reason-line-top reason-today">{{ reason }}</div>
                        {% elif 'ğŸ“…' in reason %}
                        <div class="reason-line-top reason-weekday">{{ reason }}</div>
                        {% elif 'âš ' in reason %}
                        <div class="reason-line-top reason-warn">{{ reason }}</div>
                        {% else %}
                        <div class="reason-line-top">{{ reason }}</div>
                        {% endif %}
                        {% endfor %}
                        {% else %}
                        <div class="reason-line-top">ğŸ’¡ éå»ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ããŠã™ã™ã‚å°</div>
                        {% endif %}
                    </div>
                    {# === 2. ç›´è¿‘3æ—¥é–“ãƒ‡ãƒ¼ã‚¿ === #}
                    <div class="recent-days">
                        <div class="recent-header">ç›´è¿‘ãƒ‡ãƒ¼ã‚¿</div>
                        {% set y_art = rec.yesterday_art or 0 %}
                        {% set y_games = rec.yesterday_games or 0 %}
                        {% set y_prob = (y_games / y_art)|int if y_art > 0 and y_games > 0 else 0 %}
                        {% set db_art = rec.day_before_art or 0 %}
                        {% set db_games = rec.day_before_games or 0 %}
                        {% set db_prob = (db_games / db_art)|int if db_art > 0 and db_games > 0 else 0 %}
                        {{ recent_day_expandable(y_art, y_prob, rec.yesterday_date, 'å‰æ—¥', rec.yesterday_diff_medals|default(0), rec.yesterday_max_rensa|default(0), rec.yesterday_max_medals|default(0), rec.yesterday_history_processed|default(rec.yesterday_history|default([]))) }}
                        {{ recent_day_expandable(db_art, db_prob, rec.day_before_date, 'å‰ã€…æ—¥', rec.day_before_diff_medals|default(0), rec.day_before_max_rensa|default(0), rec.day_before_max_medals|default(0), rec.day_before_history_processed|default(rec.day_before_history|default([]))) }}
                        {% set _td_art = rec.three_days_ago_art|default(0) %}
                        {% set _td_prob = ((rec.three_days_ago_games|default(0)) / _td_art)|int if _td_art > 0 else 0 %}
                        {{ recent_day_expandable(_td_art, _td_prob, rec.three_days_ago_date|default(''), '3æ—¥å‰', rec.three_days_ago_diff_medals|default(0), rec.three_days_ago_max_rensa|default(0), rec.three_days_ago_max_medals|default(0), rec.three_days_ago_history_processed|default(rec.three_days_ago_history|default([]))) }}
                    </div>
                    {# === å·®æšæ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆyesterday_history=æœ€æ–°å‰æ—¥ã‚’å„ªå…ˆã€‚today_historyã¯å½“æ—¥ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ™‚ã®ã¿ï¼‰ === #}
                    {# yesterday_history=å‰æ—¥(æœ€æ–°ç¢ºå®šãƒ‡ãƒ¼ã‚¿)ã€today_history=å½“æ—¥orå¤ã„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®å¯èƒ½æ€§ã‚ã‚Š #}
                    {% set _yh = rec.yesterday_history if rec.yesterday_history and rec.yesterday_history|length >= 2 else none %}
                    {% set _th = rec.today_history if rec.today_history and rec.today_history|length >= 2 else none %}
                    {# å½“æ—¥ãƒ‡ãƒ¼ã‚¿ãŒæœ¬å½“ã«ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚’åˆ¤å®šï¼ˆhistory_dateãŒã‚ã‚Œã°ãã‚Œã§åˆ¤æ–­ï¼‰ #}
                    {% set graph_hist = _yh if _yh else _th %}
                    {% set graph_date = rec.yesterday_date|default('') if _yh else rec.history_date|default('') %}
                    {% if graph_hist %}
                    <div class="sparkline-section">
                        <div class="sparkline-label">{% if graph_date %}{{ graph_date }}{% endif %} å·®æšæ¨ç§»</div>
                        {{ sparkline(graph_hist, width=220, height=45, diff_medals=rec.yesterday_diff_medals|default(rec.diff_medals|default(none)))|safe }}
                    </div>
                    {% endif %}
                </a>
                {% endfor %}
                {# === ã‚‚ã£ã¨è¦‹ã‚‹ï¼ˆTOP11ã€œ30ï¼‰ === #}
                {% if top3|length > 10 %}
                <div class="more-recs-toggle" onclick="document.getElementById('more-recs').classList.toggle('hidden'); this.querySelector('.toggle-text').textContent = document.getElementById('more-recs').classList.contains('hidden') ? 'ã‚‚ã£ã¨è¦‹ã‚‹ï¼ˆ{{ top3|length - 10 }}å°ï¼‰' : 'é–‰ã˜ã‚‹'">
                    <span class="toggle-text">ã‚‚ã£ã¨è¦‹ã‚‹ï¼ˆ{{ top3|length - 10 }}å°ï¼‰</span>
                </div>
                <div id="more-recs" class="hidden">
                {% for rec in top3[10:] %}
                <a href="{{ url_for('recommend', store_key=rec.store_key) }}" class="unit-card rank-{{ rec.final_rank|lower }}" style="text-decoration: none; color: inherit;">
                    <div class="unit-header">
                        <span class="ranking-num">#{{ loop.index + 10 }}</span>
                        <span class="machine-icon">{{ rec.machine_icon }}</span>
                        <span class="machine-name-top">{{ rec.machine_name }}</span>
                        <span class="rank-badge" style="background-color: {{ rank_color(rec.final_rank) }}">{{ rec.final_rank }}</span>
                    </div>
                    <div class="unit-store">
                        <span class="unit-id-sub"><span class="unit-id-num-lg">{{ rec.unit_id|pad_id }}</span><span class="unit-id-ban">ç•ª</span></span>
                        <span class="store-link-right">{{ rec.store_name }}</span>
                    </div>
                    <div class="reasons-full">
                        {% if rec.reasons %}
                        {% for reason in rec.reasons %}
                        {% if 'ğŸ“Š' in reason %}
                        <div class="reason-line-top reason-rank">{{ reason }}</div>
                        {% elif 'ğŸ“ˆ' in reason %}
                        <div class="reason-line-top reason-stats">{{ reason }}</div>
                        {% elif 'ğŸ”' in reason %}
                        <div class="reason-line-top reason-cycle">{{ reason }}</div>
                        {% elif 'ğŸ”„' in reason %}
                        <div class="reason-line-top reason-pattern">{{ reason }}</div>
                        {% elif 'ğŸ’¡' in reason %}
                        <div class="reason-line-top reason-today">{{ reason }}</div>
                        {% elif 'ğŸ“…' in reason %}
                        <div class="reason-line-top reason-weekday">{{ reason }}</div>
                        {% elif 'âš ' in reason %}
                        <div class="reason-line-top reason-warn">{{ reason }}</div>
                        {% else %}
                        <div class="reason-line-top">{{ reason }}</div>
                        {% endif %}
                        {% endfor %}
                        {% endif %}
                    </div>
                    <div class="recent-days">
                        <div class="recent-header">ç›´è¿‘ãƒ‡ãƒ¼ã‚¿</div>
                        {% set y_art = rec.yesterday_art or 0 %}
                        {% set y_games = rec.yesterday_games or 0 %}
                        {% set y_prob = (y_games / y_art)|int if y_art > 0 and y_games > 0 else 0 %}
                        {% set db_art = rec.day_before_art or 0 %}
                        {% set db_games = rec.day_before_games or 0 %}
                        {% set db_prob = (db_games / db_art)|int if db_art > 0 and db_games > 0 else 0 %}
                        {{ recent_day_expandable(y_art, y_prob, rec.yesterday_date, 'å‰æ—¥', rec.yesterday_diff_medals|default(0), rec.yesterday_max_rensa|default(0), rec.yesterday_max_medals|default(0), rec.yesterday_history_processed|default(rec.yesterday_history|default([]))) }}
                        {{ recent_day_expandable(db_art, db_prob, rec.day_before_date, 'å‰ã€…æ—¥', rec.day_before_diff_medals|default(0), rec.day_before_max_rensa|default(0), rec.day_before_max_medals|default(0), rec.day_before_history_processed|default(rec.day_before_history|default([]))) }}
                        {% set _td_art = rec.three_days_ago_art|default(0) %}
                        {% set _td_prob = ((rec.three_days_ago_games|default(0)) / _td_art)|int if _td_art > 0 else 0 %}
                        {{ recent_day_expandable(_td_art, _td_prob, rec.three_days_ago_date|default(''), '3æ—¥å‰', rec.three_days_ago_diff_medals|default(0), rec.three_days_ago_max_rensa|default(0), rec.three_days_ago_max_medals|default(0), rec.three_days_ago_history_processed|default(rec.three_days_ago_history|default([]))) }}
                    </div>
                    {% set _gh = rec.yesterday_history if rec.yesterday_history and rec.yesterday_history|length >= 2 else (rec.today_history if rec.today_history and rec.today_history|length >= 2 else none) %}
                    {% if _gh %}
                    <div class="sparkline-section">
                        <div class="sparkline-label">{% if rec.yesterday_date %}{{ rec.yesterday_date }}{% elif rec.history_date %}{{ rec.history_date }}{% endif %} å·®æšæ¨ç§»</div>
                        {{ sparkline(_gh, width=220, height=45, diff_medals=rec.diff_medals|default(none))|safe }}
                    </div>
                    {% endif %}
                </a>
                {% endfor %}
                </div>
                {% endif %}
            </section>
            {% endif %}

            {# === é–‰åº—å¾Œ/é›†è¨ˆä¸­: çš„ä¸­ç‡ãƒ’ãƒ¼ãƒ­ãƒ¼è¡¨ç¤º === #}
            {% if display_mode in ('before_open', 'after_close') and accuracy_hero and accuracy_hero[0].rate > 0 %}
            <a href="{{ url_for('verify') }}" class="accuracy-hero-link">
            <section class="accuracy-hero">
                <div class="hero-title">{{ date_prefix }} {{ data_date_str }}ã®çš„ä¸­ç‡</div>
                <div class="hero-rates">
                    {% for hero in accuracy_hero %}
                    <div class="hero-rate-card">
                        <span class="hero-icon">{{ hero.icon }}</span>
                        <span class="hero-name">{{ hero.name }}</span>
                        <span class="hero-pct {% if hero.rate >= 80 %}excellent{% elif hero.rate >= 60 %}good{% else %}normal{% endif %}">{{ hero.rate|int }}%</span>
                        <span class="hero-detail">{{ hero.hit }}/{{ hero.total }}çš„ä¸­</span>
                        {% if hero.top_stores %}
                        <span class="hero-stores">{{ hero.top_stores }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                <div class="hero-footer">çš„ä¸­çµæœã‚’è¦‹ã‚‹ â†’</div>
            </section>
            </a>
            {% endif %}

            {# === é–‰åº—å¾Œ: å½“æ—¥ã®çˆ†ç™ºå° === #}
            {% if display_mode in ('before_open', 'after_close') and yesterday_top10 %}
            <section class="today-hot-section" id="explosion-section">
                <h2>{{ date_prefix }} {{ data_date_str }}ã®çˆ†ç™ºå° TOP{{ yesterday_top10|length }}</h2>
                {% for rec in yesterday_top10 %}
                <a href="{{ url_for('recommend', store_key=rec.store_key) }}" class="yesterday-card">
                    <div class="yesterday-card-inner">
                    <div class="yesterday-card-left">
                    <div class="yesterday-header">
                        <span class="ranking-num-sm">#{{ loop.index }}</span>
                        <span class="machine-icon-sm">{{ rec.machine_icon }}</span>
                        <span class="machine-name-sm">{{ rec.machine_name }}</span>
                    </div>
                    <div class="yesterday-sub-header">
                        <span class="store-name-sm">{{ rec.store_name }}</span>
                        <span class="unit-id-sm">{{ rec.unit_id|pad_id }}ç•ª</span>
                        {% set pred_good = rec.predicted_rank in ('S', 'A') %}
                        {% set result_good = rec.prediction_result in ('hit', 'missed') %}
                        {% if pred_good and result_good %}
                        <span class="prediction-badge hit">å‰æ—¥äºˆæ¸¬çš„ä¸­</span>
                        {% elif pred_good and not result_good %}
                        <span class="prediction-badge miss">å‰æ—¥äºˆæ¸¬ãƒã‚ºãƒ¬</span>
                        {% elif not pred_good and result_good %}
                        <span class="prediction-badge miss">å‰æ—¥äºˆæ¸¬ãƒã‚ºãƒ¬</span>
                        {% else %}
                        <span class="prediction-badge hit">å‰æ—¥äºˆæ¸¬çš„ä¸­</span>
                        {% endif %}
                    </div>
                    {# === å·®æšï¼ˆç›®ç«‹ãŸã›ã‚‹ï¼‰ === #}
                    {% if rec.diff_medals is defined and rec.diff_medals != 0 %}
                    <div class="yesterday-diff-line">
                        <span class="diff-medals-lg {% if rec.diff_medals > 0 %}plus{% else %}minus{% endif %}">
                            {{ '{:+,}'.format(rec.diff_medals) }}æš
                        </span>
                        {% if rec.estimated_setting %}
                        <span class="setting-badge-sm setting-{{ rec.setting_num|default(0) }}">è¨­å®š{{ rec.setting_num }}</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    {# === ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿: ART / RB / ç¢ºç‡ / åˆå½“ãŸã‚Š === #}
                    <div class="yesterday-stats">
                        {% if rec.yesterday_art and rec.yesterday_art > 0 %}
                        <span class="art-badge">ART <span class="art-num">{{ rec.yesterday_art }}</span></span>
                        {% endif %}
                        {% if rec.first_hit_count is defined and rec.first_hit_count > 0 %}
                        <span class="first-hit-count">åˆå½“ãŸã‚Š<span class="num">{{ rec.first_hit_count }}</span>å›</span>
                        {% endif %}
                        {% if rec.yesterday_rb and rec.yesterday_rb > 0 %}
                        <span class="rb-badge">RB <span class="rb-num">{{ rec.yesterday_rb }}</span></span>
                        {% endif %}
                        {% if rec.yesterday_prob and rec.yesterday_prob > 0 %}
                        <span class="art-prob-sm {% if rec.yesterday_prob <= 100 %}excellent{% elif rec.yesterday_prob <= 130 %}good{% elif rec.yesterday_prob >= 200 %}bad{% endif %}">1/{{ rec.yesterday_prob|int }}</span>
                        {% endif %}
                        {% if rec.yesterday_games and rec.yesterday_games > 0 %}
                        <span class="total-games-label">{{ '{:,}'.format(rec.yesterday_games) }}G</span>
                        {% endif %}
                    </div>
                    {# === ã‚µãƒ–ãƒ‡ãƒ¼ã‚¿: é€£ãƒãƒ£ãƒ³ / æœ€å¤§æšæ•° / å¤©äº• === #}
                    {% if (rec.yesterday_max_rensa and rec.yesterday_max_rensa >= 3) or (rec.yesterday_max_medals and rec.yesterday_max_medals > 0) or (rec.yesterday_ceilings and rec.yesterday_ceilings > 0) %}
                    <div class="yesterday-sub-stats">
                        {% if rec.yesterday_max_rensa and rec.yesterday_max_rensa >= 3 %}
                        <span class="rensa-badge">æœ€å¤§<span class="num">{{ rec.yesterday_max_rensa }}</span>é€£</span>
                        {% endif %}
                        {% if rec.yesterday_max_medals and rec.yesterday_max_medals > 0 %}
                        <span class="max-medals">æœ€å¤§<span class="num">{{ '{:,}'.format(rec.yesterday_max_medals) }}</span>æš</span>
                        {% endif %}
                        {% if rec.yesterday_ceilings and rec.yesterday_ceilings > 0 %}
                        <span class="ceiling-badge">å¤©äº•<span class="num">{{ rec.yesterday_ceilings }}</span>å›</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    </div>{# /yesterday-card-left #}
                    {% if rec.yesterday_history and rec.yesterday_history|length >= 3 %}
                    <div class="yesterday-card-right">
                        {{ sparkline(rec.yesterday_history, diff_medals=rec.diff_medals|default(none))|safe }}
                    </div>
                    {% elif rec.today_history and rec.today_history|length >= 3 %}
                    <div class="yesterday-card-right">
                        {% set _gh2 = rec.yesterday_history if rec.yesterday_history and rec.yesterday_history|length >= 2 else (rec.today_history if rec.today_history and rec.today_history|length >= 2 else []) %}{{ sparkline(_gh2, diff_medals=rec.yesterday_diff_medals|default(rec.diff_medals|default(none)))|safe }}
                    </div>
                    {% endif %}
                    </div>{# /yesterday-card-inner #}
                    {% set hit_history = rec.yesterday_history if rec.yesterday_history and rec.yesterday_history|length > 0 else rec.today_history if rec.today_history and rec.today_history|length > 0 else [] %}
                    {% if hit_history|length > 0 %}
                    <div class="yh-toggle" onclick="toggleYesterdayHistory(event, this)">
                        å½“ãŸã‚Šå±¥æ­´ ({{ hit_history|length }}ä»¶) <span class="yh-toggle-arrow">â–¼</span>
                    </div>
                    <div class="yh-panel hidden" onclick="event.preventDefault(); event.stopPropagation();">
                        <div class="yh-list">
                            {% for hit in hit_history|sort(attribute='time', reverse=true) %}
                            {% set is_art = hit.type in ['ART', 'AT', 'BIG'] %}
                            {% set is_first_hit = hit.is_first_hit is defined and hit.is_first_hit %}
                            {% set is_chain = hit.start is defined and hit.start <= 70 and not is_first_hit %}
                            <div class="yh-row {% if is_art %}yh-art{% else %}yh-rb{% endif %}{% if is_chain %} yh-chain{% endif %}{% if is_first_hit %} yh-first-hit{% endif %}">
                                <span class="yh-chain-marker">{% if is_first_hit %}â­{% elif is_chain %}ğŸ”—{% endif %}</span>
                                <span class="yh-time">{{ hit.time or '-' }}</span>
                                <span class="yh-start {% if hit.start is defined and hit.start >= 500 %}deep{% elif hit.start is defined and hit.start <= 10 and not loop.first %}shallow{% endif %}">{{ hit.start|default(0) }}G</span>
                                <span class="yh-type">{{ hit.type|default('?') }}{% if is_first_hit %}<span class="yh-first-hit-badge">åˆ</span>{% endif %}</span>
                                <span class="yh-medals">{% if hit.medals is defined and hit.medals > 0 %}{{ '{:,}'.format(hit.medals) }}æš{% else %}-{% endif %}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    {# === ç›´è¿‘ãƒ‡ãƒ¼ã‚¿ï¼ˆè“„ç©DBï¼‰ === #}
                    {% if rec.recent_days and rec.recent_days|length > 0 %}
                    <div class="yh-toggle" onclick="toggleYesterdayHistory(event, this)">
                        ç›´è¿‘ãƒ‡ãƒ¼ã‚¿ <span class="yh-toggle-arrow">â–¼</span>
                    </div>
                    <div class="yh-panel hidden" onclick="event.preventDefault(); event.stopPropagation();">
                        <div class="recent-days compact">
                        {% for day in rec.recent_days[:7] %}
                        {% if day.art > 0 %}
                        {% set _dhist = day.history_processed|default(day.history|default([])) %}
                        <div class="recent-day-block">
                            <div class="recent-day-row {% if _dhist and _dhist|length > 0 %}has-detail{% endif %}" onclick="{% if _dhist and _dhist|length > 0 %}toggleRecentDayDetail(event, this){% endif %}">
                                <span class="recent-label">{{ short_date(day.date) }}</span>
                                <span class="recent-art">ART {{ day.art }}</span>
                                {% if day.prob > 0 %}<span class="recent-prob {% if day.prob <= 100 %}excellent{% elif day.prob <= 130 %}good{% elif day.prob >= 200 %}bad{% endif %}">1/{{ day.prob|int }}</span>{% endif %}
                                {% if day.diff_medals is defined and day.diff_medals != 0 %}<span class="diff-medals-sm {% if day.diff_medals > 0 %}plus{% else %}minus{% endif %}">{{ '{:+,}'.format(day.diff_medals) }}æš</span>{% endif %}
                                {% if day.max_rensa is defined and day.max_rensa >= 3 %}<span class="rensa-sm">{{ day.max_rensa }}é€£</span>{% endif %}
                                {% if day.max_medals is defined and day.max_medals > 0 %}<span class="max-medals-sm">æœ€å¤§{{ '{:,}'.format(day.max_medals) }}æš</span>{% endif %}
                                {% if _dhist and _dhist|length > 0 %}<span class="expand-icon small">â–¼</span>{% endif %}
                            </div>
                            {% if _dhist and _dhist|length > 0 %}
                            <div class="recent-day-detail hidden">
                                <table class="hit-detail-table compact">
                                    <thead><tr><th>#</th><th>æ™‚åˆ»</th><th>Gæ•°</th><th>ç¨®é¡</th><th>é€£</th><th>æšæ•°</th></tr></thead>
                                    <tbody>
                                    {% for h in _dhist %}
                                    <tr class="{% if h.is_tenjou is defined and h.is_tenjou %}tenjou{% elif h.is_hot_chain is defined and h.is_hot_chain %}hot-chain{% elif h.is_deep is defined and h.is_deep %}deep{% elif h.start >= 500 %}deep{% endif %}{% if h.is_shallow is defined and h.is_shallow %} shallow{% elif h.start <= 10 %} shallow{% endif %}">
                                        <td>{{ h.index|default(loop.index) }}</td>
                                        <td>{{ h.time or '-' }}</td>
                                        <td class="{% if h.is_deep is defined and h.is_deep %}deep{% elif h.start >= 500 %}deep{% endif %}">{{ h.start }}G</td>
                                        <td class="{{ h.type|lower }}">{{ h.type }}</td>
                                        <td class="{% if h.is_hot_chain is defined and h.is_hot_chain %}hot{% endif %}">{% if h.chain_pos is defined and h.chain_pos > 1 %}{{ h.chain_pos }}é€£{% else %}-{% endif %}</td>
                                        <td>{% if h.medals is defined and h.medals > 0 %}{{ '{:,}'.format(h.medals) }}{% else %}-{% endif %}</td>
                                    </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </a>
                {% endfor %}
            </section>
            {% endif %}

            <!-- ç‹™ã„ç›® / çµæœ TOP10 (å–¶æ¥­ä¸­ã®ã¿ â€” é–‰åº—å¾Œã¯ä¸Šã§è¡¨ç¤ºæ¸ˆã¿) -->
            {% if top3 and display_mode not in ('before_open', 'after_close') %}
            <section class="recommendations top" id="top3-section">
                {% if night_mode %}
                <h2>ğŸŒ™ {{ tomorrow_str }}ã®ãŠã™ã™ã‚äºˆæƒ³å° TOP{{ [top3|length, 10]|min }}</h2>
                <div class="top5-note">{{ tomorrow_str }}ã®ç‹™ã„ç›®äºˆæƒ³ â€»ä»Šæ—¥ã®çµæœï¼‹éå»å‚¾å‘ã‹ã‚‰åˆ†æ</div>
                {% else %}
                <h2>ã„ã¾ç‹™ã„ç›®ã®å° TOP{{ [top3|length, 10]|min }}</h2>
                <div class="top5-note">â€»æ©Ÿç¨® / åº—å / å°ç•ªå·</div>
                {% endif %}
                {% for rec in top3[:10] %}
                <a href="{{ url_for('recommend', store_key=rec.store_key) }}" class="unit-card rank-{{ rec.final_rank|lower }}" style="text-decoration: none; color: inherit;">
                    <div class="unit-header">
                        <span class="ranking-num">#{{ loop.index }}</span>
                        <span class="machine-icon">{{ rec.machine_icon }}</span>
                        <span class="machine-name-top">{{ rec.machine_name }}</span>
                        <span class="rank-badge" style="background-color: {{ rank_color(rec.final_rank) }}">{{ rec.final_rank }}</span>
                    </div>
                    <div class="unit-store">
                        <span class="store-link">{{ rec.store_name }}</span> / <span class="unit-id-sub"><span class="unit-id-num">{{ rec.unit_id|pad_id }}</span><span class="unit-id-ban">ç•ª</span></span>
                        {% if is_open %}
                            {% if rec.availability == 'ç©ºã' %}
                            <span class="top3-avail empty">ç©ºã</span>
                            {% elif rec.availability == 'éŠæŠ€ä¸­' %}
                            <span class="top3-avail playing">ç¨¼åƒä¸­</span>
                            {% endif %}
                        {% else %}
                            
                        {% endif %}
                    </div>
                    {% if is_open %}
                    {# === å–¶æ¥­ä¸­: å½“æ—¥ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ === #}
                    <div class="top3-stats-main">
                        <span class="art-main"><span class="art-num-big">{{ rec.art_count }}</span><span class="art-label">ART</span></span>
                        {% if rec.rb_count > 0 %}<span class="rb-badge-top">RB {{ rec.rb_count }}</span>{% endif %}
                        {% if rec.art_prob > 0 %}<span class="art-prob {% if rec.art_prob <= 100 %}excellent{% elif rec.art_prob <= 130 %}good{% elif rec.art_prob >= 200 %}bad{% endif %}" title="åˆæˆç¢ºç‡"><span class="prob-label">ART</span>1/{{ rec.art_prob|int }}</span>{% endif %}
                    </div>
                    <div class="top3-stats-sub">
                        <span class="current-hama">ç¾åœ¨: <span class="num">{{ rec.current_hama or 0 }}</span>G</span>
                        {% if rec.total_games > 0 %}<span class="total-games">ç´¯è¨ˆ<span class="num">{{ '{:,}'.format(rec.total_games) }}</span>G</span>{% endif %}
                        {% if rec.max_medals and rec.max_medals > 0 %}{% set badge = medals_badge(rec.max_medals) %}<span class="max-medals-top {% if badge %}{{ badge.class }}{% endif %}">{% if badge %}<span class="medals-icon">{{ badge.icon }}</span>{% endif %}æœ€å¤§<span class="num">{{ '{:,}'.format(rec.max_medals) }}</span>æš</span>{% endif %}
                        {% if rec.today_max_rensa and rec.today_max_rensa >= 3 %}
                        <span class="rensa-badge">æœ€å¤§<span class="num">{{ rec.today_max_rensa }}</span>é€£</span>
                        {% endif %}
                    </div>
                    {# === è¨­å®šæ¨å®š === #}
                    {% if rec.total_games >= 2000 and rec.estimated_setting %}
                    <div class="top3-setting">
                        <span class="setting-estimate setting-{{ rec.setting_num|default(0) }}">
                            {{ rec.estimated_setting }} <span class="payout">({{ rec.payout_estimate }}%)</span>
                        </span>
                    </div>
                    {% elif rec.total_games >= 1000 and rec.estimated_setting %}
                    <div class="top3-setting">
                        <span class="setting-estimate setting-{{ rec.setting_num|default(0) }} tentative">
                            {{ rec.estimated_setting }}? <span class="payout">(è¦æ§˜å­è¦‹)</span>
                        </span>
                    </div>
                    {% endif %}
                    {% else %}
                    {# === é–‰åº—å¾Œ: å‰æ—¥ãƒ‡ãƒ¼ã‚¿ã‚’å½“æ—¥ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦è¡¨ç¤º === #}
                    {% set y_art = rec.yesterday_art or 0 %}
                    {% set y_games = rec.yesterday_games or 0 %}
                    {% set y_prob = (y_games / y_art)|int if y_art > 0 and y_games > 0 else 0 %}
                    <div class="top3-stats-main">
                        <span class="art-main"><span class="art-num-big">{{ y_art }}</span><span class="art-label">ART</span></span>
                        {% if rec.yesterday_rb and rec.yesterday_rb > 0 %}<span class="rb-badge-top">RB {{ rec.yesterday_rb }}</span>{% endif %}
                        {% if y_prob > 0 %}<span class="art-prob {% if y_prob <= 100 %}excellent{% elif y_prob <= 130 %}good{% elif y_prob >= 200 %}bad{% endif %}"><span class="prob-label">ART</span>1/{{ y_prob }}</span>{% endif %}
                    </div>
                    <div class="top3-stats-sub">
                        {% if y_games > 0 %}<span class="total-games">{{ '{:,}'.format(y_games) }}G</span>{% endif %}
                        {% if rec.yesterday_max_rensa and rec.yesterday_max_rensa >= 3 %}
                        <span class="rensa-badge">æœ€å¤§<span class="num">{{ rec.yesterday_max_rensa }}</span>é€£</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    {# === å‰æ—¥ãƒ»å‰ã€…æ—¥ãƒ»3æ—¥å‰ãƒ‡ãƒ¼ã‚¿ï¼ˆå–¶æ¥­ä¸­ã®ã¿ï¼‰ === #}
                    {% if is_open and (rec.yesterday_art or rec.day_before_art or rec.three_days_ago_art) %}
                    <div class="top3-prev-days">
                        {% if rec.yesterday_art %}
                        <div class="prev-day-row{% if rec.yesterday_history_processed %} has-detail{% endif %}" onclick="toggleHitDetail(event, this)">
                            <span class="prev-day-label">{{ short_date(rec.yesterday_date) or 'å‰æ—¥' }}:</span>
                            <span class="prev-art">ART {{ rec.yesterday_art }}</span>
                            {% if rec.yesterday_rb %} / RB {{ rec.yesterday_rb }}{% endif %}
                            {% if rec.yesterday_games %} / {{ '{:,}'.format(rec.yesterday_games) }}G{% endif %}
                            {% if rec.yesterday_diff_medals is defined and rec.yesterday_diff_medals != 0 %}
                            <span class="diff-medals-sm {% if rec.yesterday_diff_medals > 0 %}plus{% else %}minus{% endif %}">{{ '{:+,}'.format(rec.yesterday_diff_medals) }}æš</span>
                            {% endif %}
                            {% if rec.yesterday_max_rensa and rec.yesterday_max_rensa >= 3 %}<span class="rensa-sm">{{ rec.yesterday_max_rensa }}é€£</span>{% endif %}
                            {% if rec.yesterday_history_processed %}<span class="expand-icon small">â–¼</span>{% endif %}
                        </div>
                        {% if rec.yesterday_history_processed %}
                        <div class="hit-detail-panel" style="display:none;">
                            {% if rec.yesterday_history_summary %}
                            <div class="hit-summary-row"><span>{{ rec.yesterday_history_summary.total_hits or 0 }}å½“ãŸã‚Š</span><span>æœ€å¤§{{ rec.yesterday_history_summary.max_chain or 0 }}é€£</span><span>å¹³å‡{{ rec.yesterday_history_summary.avg_valley or 0 }}G</span></div>
                            {% endif %}
                            <table class="hit-detail-table"><thead><tr><th>#</th><th>æ™‚åˆ»</th><th>Gæ•°</th><th>ç¨®é¡</th><th>é€£</th><th>æšæ•°</th></tr></thead><tbody>
                            {% for hit in rec.yesterday_history_processed %}<tr class="{% if hit.is_tenjou %}tenjou{% elif hit.is_hot_chain %}hot-chain{% elif hit.is_deep %}deep{% endif %}"><td>{{ hit.index }}</td><td>{{ hit.time or '-' }}</td><td class="{% if hit.is_deep %}deep{% elif hit.is_shallow %}shallow{% endif %}">{{ hit.start }}G</td><td class="{{ hit.type|lower }}">{{ hit.type }}</td><td class="{% if hit.is_hot_chain %}hot{% endif %}">{% if hit.chain_pos is defined and hit.chain_pos > 1 %}{{ hit.chain_pos }}é€£{% else %}-{% endif %}</td><td>{% if hit.medals > 0 %}{{ '{:,}'.format(hit.medals) }}{% else %}-{% endif %}</td></tr>{% endfor %}
                            </tbody></table>
                        </div>
                        {% endif %}
                        {% endif %}
                        {% if rec.day_before_art %}
                        <div class="prev-day-row{% if rec.day_before_history_processed %} has-detail{% endif %}" onclick="toggleHitDetail(event, this)">
                            <span class="prev-day-label">{{ short_date(rec.day_before_date) or 'å‰ã€…æ—¥' }}:</span>
                            <span class="prev-art">ART {{ rec.day_before_art }}</span>
                            {% if rec.day_before_rb %} / RB {{ rec.day_before_rb }}{% endif %}
                            {% if rec.day_before_games %} / {{ '{:,}'.format(rec.day_before_games) }}G{% endif %}
                            {% if rec.day_before_diff_medals is defined and rec.day_before_diff_medals != 0 %}
                            <span class="diff-medals-sm {% if rec.day_before_diff_medals > 0 %}plus{% else %}minus{% endif %}">{{ '{:+,}'.format(rec.day_before_diff_medals) }}æš</span>
                            {% endif %}
                            {% if rec.day_before_max_rensa and rec.day_before_max_rensa >= 3 %}<span class="rensa-sm">{{ rec.day_before_max_rensa }}é€£</span>{% endif %}
                            {% if rec.day_before_history_processed %}<span class="expand-icon small">â–¼</span>{% endif %}
                        </div>
                        {% if rec.day_before_history_processed %}
                        <div class="hit-detail-panel" style="display:none;">
                            {% if rec.day_before_history_summary %}
                            <div class="hit-summary-row"><span>{{ rec.day_before_history_summary.total_hits or 0 }}å½“ãŸã‚Š</span><span>æœ€å¤§{{ rec.day_before_history_summary.max_chain or 0 }}é€£</span><span>å¹³å‡{{ rec.day_before_history_summary.avg_valley or 0 }}G</span></div>
                            {% endif %}
                            <table class="hit-detail-table"><thead><tr><th>#</th><th>æ™‚åˆ»</th><th>Gæ•°</th><th>ç¨®é¡</th><th>é€£</th><th>æšæ•°</th></tr></thead><tbody>
                            {% for hit in rec.day_before_history_processed %}<tr class="{% if hit.is_tenjou %}tenjou{% elif hit.is_hot_chain %}hot-chain{% elif hit.is_deep %}deep{% endif %}"><td>{{ hit.index }}</td><td>{{ hit.time or '-' }}</td><td class="{% if hit.is_deep %}deep{% elif hit.is_shallow %}shallow{% endif %}">{{ hit.start }}G</td><td class="{{ hit.type|lower }}">{{ hit.type }}</td><td class="{% if hit.is_hot_chain %}hot{% endif %}">{% if hit.chain_pos is defined and hit.chain_pos > 1 %}{{ hit.chain_pos }}é€£{% else %}-{% endif %}</td><td>{% if hit.medals > 0 %}{{ '{:,}'.format(hit.medals) }}{% else %}-{% endif %}</td></tr>{% endfor %}
                            </tbody></table>
                        </div>
                        {% endif %}
                        {% endif %}
                        {% if rec.three_days_ago_art %}
                        <div class="prev-day-row{% if rec.three_days_ago_history_processed %} has-detail{% endif %}" onclick="toggleHitDetail(event, this)">
                            <span class="prev-day-label">{{ short_date(rec.three_days_ago_date) or '3æ—¥å‰' }}:</span>
                            <span class="prev-art">ART {{ rec.three_days_ago_art }}</span>
                            {% if rec.three_days_ago_rb %} / RB {{ rec.three_days_ago_rb }}{% endif %}
                            {% if rec.three_days_ago_games %} / {{ '{:,}'.format(rec.three_days_ago_games) }}G{% endif %}
                            {% if rec.three_days_ago_diff_medals is defined and rec.three_days_ago_diff_medals != 0 %}
                            <span class="diff-medals-sm {% if rec.three_days_ago_diff_medals > 0 %}plus{% else %}minus{% endif %}">{{ '{:+,}'.format(rec.three_days_ago_diff_medals) }}æš</span>
                            {% endif %}
                            {% if rec.three_days_ago_max_rensa and rec.three_days_ago_max_rensa >= 3 %}<span class="rensa-sm">{{ rec.three_days_ago_max_rensa }}é€£</span>{% endif %}
                            {% if rec.three_days_ago_history_processed %}<span class="expand-icon small">â–¼</span>{% endif %}
                        </div>
                        {% if rec.three_days_ago_history_processed %}
                        <div class="hit-detail-panel" style="display:none;">
                            {% if rec.three_days_ago_history_summary %}
                            <div class="hit-summary-row"><span>{{ rec.three_days_ago_history_summary.total_hits or 0 }}å½“ãŸã‚Š</span><span>æœ€å¤§{{ rec.three_days_ago_history_summary.max_chain or 0 }}é€£</span><span>å¹³å‡{{ rec.three_days_ago_history_summary.avg_valley or 0 }}G</span></div>
                            {% endif %}
                            <table class="hit-detail-table"><thead><tr><th>#</th><th>æ™‚åˆ»</th><th>Gæ•°</th><th>ç¨®é¡</th><th>é€£</th><th>æšæ•°</th></tr></thead><tbody>
                            {% for hit in rec.three_days_ago_history_processed %}<tr class="{% if hit.is_tenjou %}tenjou{% elif hit.is_hot_chain %}hot-chain{% elif hit.is_deep %}deep{% endif %}"><td>{{ hit.index }}</td><td>{{ hit.time or '-' }}</td><td class="{% if hit.is_deep %}deep{% elif hit.is_shallow %}shallow{% endif %}">{{ hit.start }}G</td><td class="{{ hit.type|lower }}">{{ hit.type }}</td><td class="{% if hit.is_hot_chain %}hot{% endif %}">{% if hit.chain_pos is defined and hit.chain_pos > 1 %}{{ hit.chain_pos }}é€£{% else %}-{% endif %}</td><td>{% if hit.medals > 0 %}{{ '{:,}'.format(hit.medals) }}{% else %}-{% endif %}</td></tr>{% endfor %}
                            </tbody></table>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                    {% endif %}
                    {# === æ¨å¥¨ç†ç”±ï¼ˆå…¨ä»¶è¡¨ç¤ºãƒ»ã‚«ãƒ†ã‚´ãƒªè‰²åˆ†ã‘ï¼‰ === #}
                    <div class="reasons-full">
                        {% if rec.reasons %}
                        {% for reason in rec.reasons %}
                        {% if 'ğŸ“Š' in reason %}
                        <div class="reason-line-top reason-rank">{{ reason }}</div>
                        {% elif 'ğŸ“ˆ' in reason %}
                        <div class="reason-line-top reason-stats">{{ reason }}</div>
                        {% elif 'ğŸ”' in reason %}
                        <div class="reason-line-top reason-cycle">{{ reason }}</div>
                        {% elif 'ğŸ”„' in reason %}
                        <div class="reason-line-top reason-pattern">{{ reason }}</div>
                        {% elif 'ğŸ’¡' in reason %}
                        <div class="reason-line-top reason-today">{{ reason }}</div>
                        {% elif 'ğŸ“…' in reason %}
                        <div class="reason-line-top reason-weekday">{{ reason }}</div>
                        {% elif 'ğŸ”¥' in reason %}
                        <div class="reason-line-top reason-today">{{ reason }}</div>
                        {% elif 'âš ' in reason %}
                        <div class="reason-line-top reason-warn">{{ reason }}</div>
                        {% else %}
                        <div class="reason-line-top">{{ reason }}</div>
                        {% endif %}
                        {% endfor %}
                        {% else %}
                        <div class="reason-line-top"><span class="reason-icon">ğŸ’¡</span> éå»ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ããŠã™ã™ã‚å°</div>
                        {% endif %}
                    </div>
                </a>
                {% endfor %}

                {# === ã‚‚ã£ã¨è¦‹ã‚‹ï¼ˆTOP11ã€œ30ï¼‰=== #}
                {% if top3|length > 10 %}
                <div class="more-recs-toggle" onclick="document.getElementById('more-recs-rt').classList.toggle('hidden'); this.querySelector('.toggle-text').textContent = document.getElementById('more-recs-rt').classList.contains('hidden') ? 'ã‚‚ã£ã¨è¦‹ã‚‹ï¼ˆ{{ top3|length - 10 }}å°ï¼‰' : 'é–‰ã˜ã‚‹'">
                    <span class="toggle-text">ã‚‚ã£ã¨è¦‹ã‚‹ï¼ˆ{{ top3|length - 10 }}å°ï¼‰</span>
                </div>
                <div id="more-recs-rt" class="hidden">
                {% for rec in top3[10:] %}
                <a href="{{ url_for('recommend', store_key=rec.store_key) }}" class="unit-card rank-{{ rec.final_rank|lower }}" style="text-decoration: none; color: inherit;">
                    <div class="unit-header">
                        <span class="ranking-num">#{{ loop.index + 10 }}</span>
                        <span class="machine-icon">{{ rec.machine_icon }}</span>
                        <span class="machine-name-top">{{ rec.machine_name }}</span>
                        <span class="rank-badge" style="background-color: {{ rank_color(rec.final_rank) }}">{{ rec.final_rank }}</span>
                    </div>
                    <div class="unit-store">
                        <span class="unit-id-sub"><span class="unit-id-num-lg">{{ rec.unit_id|pad_id }}</span><span class="unit-id-ban">ç•ª</span></span>
                        <span class="store-link-right">{{ rec.store_name }}</span>
                    </div>
                    <div class="reasons-full">
                        {% if rec.reasons %}
                        {% for reason in rec.reasons %}
                        {% if 'ğŸ“Š' in reason %}
                        <div class="reason-line-top reason-rank">{{ reason }}</div>
                        {% elif 'ğŸ“ˆ' in reason %}
                        <div class="reason-line-top reason-stats">{{ reason }}</div>
                        {% elif 'ğŸ”' in reason %}
                        <div class="reason-line-top reason-cycle">{{ reason }}</div>
                        {% elif 'ğŸ”„' in reason %}
                        <div class="reason-line-top reason-pattern">{{ reason }}</div>
                        {% elif 'ğŸ’¡' in reason %}
                        <div class="reason-line-top reason-today">{{ reason }}</div>
                        {% elif 'ğŸ“…' in reason %}
                        <div class="reason-line-top reason-weekday">{{ reason }}</div>
                        {% elif 'âš ' in reason %}
                        <div class="reason-line-top reason-warn">{{ reason }}</div>
                        {% else %}
                        <div class="reason-line-top">{{ reason }}</div>
                        {% endif %}
                        {% endfor %}
                        {% endif %}
                    </div>
                    <div class="recent-days">
                        <div class="recent-header">ç›´è¿‘ãƒ‡ãƒ¼ã‚¿</div>
                        {% set y_art = rec.yesterday_art or 0 %}
                        {% set y_games = rec.yesterday_games or 0 %}
                        {% set y_prob = (y_games / y_art)|int if y_art > 0 and y_games > 0 else 0 %}
                        {% set db_art = rec.day_before_art or 0 %}
                        {% set db_games = rec.day_before_games or 0 %}
                        {% set db_prob = (db_games / db_art)|int if db_art > 0 and db_games > 0 else 0 %}
                        {{ recent_day_expandable(y_art, y_prob, rec.yesterday_date, 'å‰æ—¥', rec.yesterday_diff_medals|default(0), rec.yesterday_max_rensa|default(0), rec.yesterday_max_medals|default(0), rec.yesterday_history_processed|default(rec.yesterday_history|default([]))) }}
                        {{ recent_day_expandable(db_art, db_prob, rec.day_before_date, 'å‰ã€…æ—¥', rec.day_before_diff_medals|default(0), rec.day_before_max_rensa|default(0), rec.day_before_max_medals|default(0), rec.day_before_history_processed|default(rec.day_before_history|default([]))) }}
                        {% set _td_art = rec.three_days_ago_art|default(0) %}
                        {% set _td_prob = ((rec.three_days_ago_games|default(0)) / _td_art)|int if _td_art > 0 else 0 %}
                        {{ recent_day_expandable(_td_art, _td_prob, rec.three_days_ago_date|default(''), '3æ—¥å‰', rec.three_days_ago_diff_medals|default(0), rec.three_days_ago_max_rensa|default(0), rec.three_days_ago_max_medals|default(0), rec.three_days_ago_history_processed|default(rec.three_days_ago_history|default([]))) }}
                    </div>
                    {% set _gh = rec.yesterday_history if rec.yesterday_history and rec.yesterday_history|length >= 2 else (rec.today_history if rec.today_history and rec.today_history|length >= 2 else none) %}
                    {% if _gh %}
                    <div class="sparkline-section">
                        <div class="sparkline-label">{% if rec.yesterday_date %}{{ rec.yesterday_date }}{% elif rec.history_date %}{{ rec.history_date }}{% endif %} å·®æšæ¨ç§»</div>
                        {{ sparkline(_gh, width=220, height=45, diff_medals=rec.diff_medals|default(none))|safe }}
                    </div>
                    {% endif %}
                </a>
                {% endfor %}
                </div>
                {% endif %}

                {# === åº—åˆ¥ãƒ»æ©Ÿç¨®åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ + ãã®ä»–ã®S/Aå° === #}
                {% if all_sa_recs %}
                <div class="sa-filter-section">
                    <h3>ãã®ä»–ã®ç‹™ã„ç›®å°</h3>
                    <div class="sa-filters">
                        <button class="sa-filter-btn active" onclick="filterSA('all')">å…¨ã¦</button>
                        {% for m in filter_machines %}
                        <button class="sa-filter-btn" onclick="filterSA('machine', '{{ m.key }}')">{{ m.icon }} {{ m.name }}</button>
                        {% endfor %}
                        {% for s in filter_stores %}
                        <button class="sa-filter-btn" onclick="filterSA('store', '{{ s.store_keys|join(',') }}')">{{ s.name }}</button>
                        {% endfor %}
                    </div>
                    <div class="sa-recs-list">
                        {% for rec in all_sa_recs %}
                        <a href="{{ url_for('recommend', store_key=rec.store_key) }}" class="sa-rec-card rank-{{ rec.final_rank|lower }}" data-machine="{{ rec.machine_key }}" data-store="{{ rec.store_key }}" style="text-decoration: none; color: inherit;">
                            <div class="sa-rec-header">
                                <span class="machine-icon-sm">{{ rec.machine_icon }}</span>
                                <span class="sa-rec-store">{{ rec.store_name }}</span>
                                <span class="sa-rec-unit">{{ rec.unit_id|pad_id }}ç•ª</span>
                                <span class="rank-badge-xs" style="background-color: {{ rank_color(rec.final_rank) }}">{{ rec.final_rank }}</span>
                            </div>
                            <div class="sa-rec-data">
                                {% if is_open and rec.art_count > 0 %}
                                <span class="sa-art">ART {{ rec.art_count }}</span>
                                {% if rec.art_prob > 0 %}<span class="sa-prob {% if rec.art_prob <= 100 %}excellent{% elif rec.art_prob <= 130 %}good{% elif rec.art_prob >= 200 %}bad{% endif %}">1/{{ rec.art_prob|int }}</span>{% endif %}
                                {% endif %}
                                {% if rec.yesterday_art %}
                                <span class="sa-prev">{{ short_date(rec.yesterday_date) or 'å‰æ—¥' }}: ART {{ rec.yesterday_art }}{% if rec.yesterday_diff_medals is defined and rec.yesterday_diff_medals != 0 %} <span class="{% if rec.yesterday_diff_medals > 0 %}plus{% else %}minus{% endif %}">{{ '{:+,}'.format(rec.yesterday_diff_medals) }}æš</span>{% endif %}</span>
                                {% endif %}
                            </div>
                            {% if rec.reasons %}
                            <div class="sa-rec-reason">{{ rec.reasons[0] }}</div>
                            {% endif %}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </section>
            {% endif %}

            {# === å–¶æ¥­ä¸­: æœ¬æ—¥ã®çˆ†ç™ºå°ï¼ˆTOP3ã®ç›´å¾Œï¼‰ === #}
            {% if is_open and today_top10 %}
            <section class="today-hot-section" id="explosion-section">
                <h2>{{ data_date_str }}ã®çˆ†ç™ºå° TOP{{ today_top10|length }}</h2>
                <div class="today-hot-note">å‡ºç‰ä¸Šä½</div>
                {% for rec in today_top10 %}
                <a href="{{ url_for('recommend', store_key=rec.store_key) }}" class="yesterday-card">
                    <div class="yesterday-header">
                        <span class="ranking-num-sm">#{{ loop.index }}</span>
                        <span class="machine-icon-sm">{{ rec.machine_icon }}</span>
                        <span class="machine-name-sm">{{ rec.machine_name }}</span>
                    </div>
                    <div class="yesterday-sub-header">
                        <span class="store-name-sm">{{ rec.store_name }}</span>
                        <span class="unit-id-sm">{{ rec.unit_id|pad_id }}ç•ª</span>
                        {% if rec.availability == 'ç©ºã' %}
                        <span class="avail-sm empty">ç©º</span>
                        {% elif rec.availability == 'éŠæŠ€ä¸­' %}
                        <span class="avail-sm playing">ç¨¼</span>
                        {% endif %}
                    </div>
                    <div class="yesterday-stats">
                        {% if rec.diff_medals is defined and rec.diff_medals != 0 %}
                        <span class="diff-medals {% if rec.diff_medals > 0 %}plus{% else %}minus{% endif %}">
                            {{ '{:+,}'.format(rec.diff_medals) }}æš
                        </span>
                        {% endif %}
                        {% if rec.art_count > 0 %}
                        <span class="art-badge">ART <span class="art-num">{{ rec.art_count }}</span></span>
                        {% endif %}
                        {% if rec.today_max_rensa and rec.today_max_rensa >= 3 %}
                        <span class="rensa-badge">æœ€å¤§<span class="num">{{ rec.today_max_rensa }}</span>é€£</span>
                        {% endif %}
                        {% if rec.total_games and rec.total_games > 0 %}
                        <span class="total-games-label">{{ '{:,}'.format(rec.total_games) }}G</span>
                        {% endif %}
                        {% if rec.total_games and rec.total_games >= 1000 and rec.estimated_setting %}
                        <span class="setting-badge-sm setting-{{ rec.setting_num|default(0) }}">è¨­å®š{{ rec.setting_num }}{% if rec.total_games < 2000 %}?{% endif %}</span>
                        {% endif %}
                    </div>
                </a>
                {% endfor %}
            </section>
            {% endif %}

            <!-- æ©Ÿç¨®ã‹ã‚‰æ¢ã™ -->
            <section class="machine-list">
                <h2>æ©Ÿç¨®ã‹ã‚‰æ¢ã™</h2>
                {% for machine in machines %}
                <a href="{{ url_for('machine_stores', machine_key=machine.key) }}" class="machine-card">
                    <span class="machine-icon">{{ machine.icon }}</span>
                    <div class="machine-info">
                        <span class="machine-name">{{ machine.short_name }}</span>
                        <span class="machine-detail">{{ machine.store_count }}åº—èˆ— / {{ machine.unit_count }}å°</span>
                    </div>
                    <span class="arrow">â€º</span>
                </a>
                {% endfor %}
            </section>

            <!-- åº—èˆ—ä¸€è¦§ -->
            {% if all_stores %}
            <section class="store-directory">
                <h2>ğŸ¢ {{ today_weekday }}æ›œæ—¥ã®åº—èˆ—ãŠã™ã™ã‚åº¦</h2>
                <div class="store-directory-note">åº—èˆ—ã®æ›œæ—¥å‚¾å‘ï¼ˆéå»ã®å‡ºç‰ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰åˆ†æã€‚å°å€‹åˆ¥ã§ã¯ãªãåº—èˆ—å…¨ä½“ã®å‚¾å‘ï¼‰</div>
                {% for store in all_stores %}
                <div class="store-directory-card {% if store.today_rating >= 4 %}store-dir-good{% elif store.today_rating <= 2 %}store-dir-weak{% endif %}">
                    <div class="store-dir-header">
                        <span class="store-dir-name">{{ store.short_name }}</span>
                        <span class="store-dir-rating {% if store.today_rating >= 4 %}good{% elif store.today_rating <= 2 %}weak{% endif %}">{{ today_weekday }}æ›œ {{ 'â˜…' * store.today_rating }}</span>
                    </div>
                    <div class="store-dir-machines">
                        {% for link in store.machine_links %}
                        <a href="{{ url_for('recommend', store_key=link.store_key) }}" class="store-dir-machine-link">
                            <span class="store-dir-icon">{{ link.icon }}</span>
                            <span class="store-dir-machine-name">{{ link.short_name }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </section>
            {% endif %}

            {# === å–¶æ¥­ä¸­: å‰æ—¥ã®çˆ†ç™ºå°ã‚’æœ€ä¸‹éƒ¨ã«è¡¨ç¤º === #}
            {% if is_open and yesterday_top10 %}
            <section class="today-hot-section" id="explosion-section">
                <h2>{{ prev_date_str }}ã®çˆ†ç™ºå° TOP{{ yesterday_top10|length }}</h2>
                <div class="today-hot-note">æ®ãˆç½®ãç‹™ã„ã®å‚è€ƒã«</div>
                {% for rec in yesterday_top10 %}
                <a href="{{ url_for('recommend', store_key=rec.store_key) }}" class="yesterday-card">
                    <div class="yesterday-card-inner">
                    <div class="yesterday-card-left">
                    <div class="yesterday-header">
                        <span class="ranking-num-sm">#{{ loop.index }}</span>
                        <span class="machine-icon-sm">{{ rec.machine_icon }}</span>
                        <span class="machine-name-sm">{{ rec.machine_name }}</span>
                    </div>
                    <div class="yesterday-sub-header">
                        <span class="store-name-sm">{{ rec.store_name }}</span>
                        <span class="unit-id-sm">{{ rec.unit_id|pad_id }}ç•ª</span>
                        {% set pred_good = rec.predicted_rank in ('S', 'A') %}
                        {% set result_good = rec.prediction_result in ('hit', 'missed') %}
                        {% if pred_good and result_good %}
                        <span class="prediction-badge hit">å‰æ—¥äºˆæ¸¬çš„ä¸­</span>
                        {% elif pred_good and not result_good %}
                        <span class="prediction-badge miss">å‰æ—¥äºˆæ¸¬ãƒã‚ºãƒ¬</span>
                        {% elif not pred_good and result_good %}
                        <span class="prediction-badge miss">å‰æ—¥äºˆæ¸¬ãƒã‚ºãƒ¬</span>
                        {% else %}
                        <span class="prediction-badge hit">å‰æ—¥äºˆæ¸¬çš„ä¸­</span>
                        {% endif %}
                        {% if rec.availability == 'ç©ºã' %}
                        <span class="avail-sm empty">ç©º</span>
                        {% elif rec.availability == 'éŠæŠ€ä¸­' %}
                        <span class="avail-sm playing">ç¨¼</span>
                        {% endif %}
                    </div>
                    {# === å·®æšï¼ˆç›®ç«‹ãŸã›ã‚‹ï¼‰ === #}
                    {% if rec.diff_medals is defined and rec.diff_medals != 0 %}
                    <div class="yesterday-diff-line">
                        <span class="diff-medals-lg {% if rec.diff_medals > 0 %}plus{% else %}minus{% endif %}">
                            {{ '{:+,}'.format(rec.diff_medals) }}æš
                        </span>
                        {% if rec.estimated_setting %}
                        <span class="setting-badge-sm setting-{{ rec.setting_num|default(0) }}">è¨­å®š{{ rec.setting_num }}</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    {# === ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ === #}
                    <div class="yesterday-stats">
                        {% if rec.yesterday_art and rec.yesterday_art > 0 %}
                        <span class="art-badge">ART <span class="art-num">{{ rec.yesterday_art }}</span></span>
                        {% endif %}
                        {% if rec.first_hit_count is defined and rec.first_hit_count > 0 %}
                        <span class="first-hit-count">åˆå½“ãŸã‚Š<span class="num">{{ rec.first_hit_count }}</span>å›</span>
                        {% endif %}
                        {% if rec.yesterday_rb and rec.yesterday_rb > 0 %}
                        <span class="rb-badge">RB <span class="rb-num">{{ rec.yesterday_rb }}</span></span>
                        {% endif %}
                        {% if rec.yesterday_prob and rec.yesterday_prob > 0 %}
                        <span class="art-prob-sm {% if rec.yesterday_prob <= 100 %}excellent{% elif rec.yesterday_prob <= 130 %}good{% elif rec.yesterday_prob >= 200 %}bad{% endif %}">1/{{ rec.yesterday_prob|int }}</span>
                        {% endif %}
                        {% if rec.yesterday_games and rec.yesterday_games > 0 %}
                        <span class="total-games-label">{{ '{:,}'.format(rec.yesterday_games) }}G</span>
                        {% endif %}
                    </div>
                    {# === ã‚µãƒ–ãƒ‡ãƒ¼ã‚¿ === #}
                    {% if (rec.yesterday_max_rensa and rec.yesterday_max_rensa >= 3) or (rec.yesterday_max_medals and rec.yesterday_max_medals > 0) %}
                    <div class="yesterday-sub-stats">
                        {% if rec.yesterday_max_rensa and rec.yesterday_max_rensa >= 3 %}
                        <span class="rensa-badge">æœ€å¤§<span class="num">{{ rec.yesterday_max_rensa }}</span>é€£</span>
                        {% endif %}
                        {% if rec.yesterday_max_medals and rec.yesterday_max_medals > 0 %}
                        <span class="max-medals">æœ€å¤§<span class="num">{{ '{:,}'.format(rec.yesterday_max_medals) }}</span>æš</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if rec.day_before_art %}
                    <div class="prev-day-sub">å‰ã€…æ—¥: ART {{ rec.day_before_art }}{% if rec.day_before_rb %} / RB {{ rec.day_before_rb }}{% endif %}{% if rec.day_before_games %} ({{ '{:,}'.format(rec.day_before_games) }}G){% endif %}</div>
                    {% endif %}
                    </div>{# /yesterday-card-left #}
                    {% if rec.yesterday_history and rec.yesterday_history|length >= 3 %}
                    <div class="yesterday-card-right">
                        {{ sparkline(rec.yesterday_history, diff_medals=rec.diff_medals|default(none))|safe }}
                    </div>
                    {% elif rec.today_history and rec.today_history|length >= 3 %}
                    <div class="yesterday-card-right">
                        {% set _gh2 = rec.yesterday_history if rec.yesterday_history and rec.yesterday_history|length >= 2 else (rec.today_history if rec.today_history and rec.today_history|length >= 2 else []) %}{{ sparkline(_gh2, diff_medals=rec.yesterday_diff_medals|default(rec.diff_medals|default(none)))|safe }}
                    </div>
                    {% endif %}
                    </div>{# /yesterday-card-inner #}
                    {% set hit_history2 = rec.yesterday_history if rec.yesterday_history and rec.yesterday_history|length > 0 else rec.today_history if rec.today_history and rec.today_history|length > 0 else [] %}
                    {% if hit_history2|length > 0 %}
                    <div class="yh-toggle" onclick="toggleYesterdayHistory(event, this)">
                        å½“ãŸã‚Šå±¥æ­´ ({{ hit_history2|length }}ä»¶) <span class="yh-toggle-arrow">â–¼</span>
                    </div>
                    <div class="yh-panel hidden" onclick="event.preventDefault(); event.stopPropagation();">
                        <div class="yh-list">
                            {% for hit in hit_history2|sort(attribute='time', reverse=true) %}
                            {% set is_art = hit.type in ['ART', 'AT', 'BIG'] %}
                            {% set is_first_hit = hit.is_first_hit is defined and hit.is_first_hit %}
                            {% set is_chain = hit.start is defined and hit.start <= 70 and not is_first_hit %}
                            <div class="yh-row {% if is_art %}yh-art{% else %}yh-rb{% endif %}{% if is_chain %} yh-chain{% endif %}{% if is_first_hit %} yh-first-hit{% endif %}">
                                <span class="yh-chain-marker">{% if is_first_hit %}â­{% elif is_chain %}ğŸ”—{% endif %}</span>
                                <span class="yh-time">{{ hit.time or '-' }}</span>
                                <span class="yh-start {% if hit.start is defined and hit.start >= 500 %}deep{% elif hit.start is defined and hit.start <= 10 and not loop.first %}shallow{% endif %}">{{ hit.start|default(0) }}G</span>
                                <span class="yh-type">{{ hit.type|default('?') }}{% if is_first_hit %}<span class="yh-first-hit-badge">åˆ</span>{% endif %}</span>
                                <span class="yh-medals">{% if hit.medals is defined and hit.medals > 0 %}{{ '{:,}'.format(hit.medals) }}æš{% else %}-{% endif %}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </a>
                {% endfor %}
            </section>
            {% endif %}

            <!-- åº—èˆ—åˆ¥æ›œæ—¥å‚¾å‘ï¼ˆéå»ãƒ‡ãƒ¼ã‚¿åˆ†æï¼‰ -->
            <section class="store-schedule">
                <h2>ğŸ“… {{ today_weekday }}æ›œæ—¥ã®åº—èˆ—å‚¾å‘</h2>
                <div class="schedule-legend">
                    <span class="legend-item best">â˜…5=æœ€å¼·</span>
                    <span class="legend-item good">â˜…4=ç‹™ã„ç›®</span>
                    <span class="legend-item normal">â˜…3=æ™®é€š</span>
                    <span class="legend-item weak">â˜…2ä»¥ä¸‹=é¿ã‘ã‚‹</span>
                </div>
                {% for store in today_store_ranking %}
                <div class="schedule-card-full {% if store.today_rating >= 4 %}schedule-recommended{% elif store.today_rating <= 2 %}schedule-avoid{% endif %}">
                    <div class="schedule-store-header">
                        <a href="{{ url_for('recommend', store_key=store.machine_links[0].store_key) }}" class="schedule-store-link">{{ store.short_name }}</a>
                        <span class="schedule-today-rating {% if store.today_rating >= 4 %}good{% elif store.today_rating <= 2 %}weak{% endif %}">ä»Šæ—¥ {{ 'â˜…' * store.today_rating }}</span>
                    </div>
                    <div class="schedule-week">
                        {% for day in ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'] %}
                        {% set rating = store.day_ratings[day] %}
                        <span class="day-cell {% if rating >= 5 %}best{% elif rating >= 4 %}good{% elif rating <= 2 %}weak{% else %}normal{% endif %} {% if day == today_weekday %}today{% endif %}">
                            <span class="day-name">{{ day }}</span>
                            <span class="day-stars">{{ 'â˜…' * rating }}</span>
                        </span>
                        {% endfor %}
                    </div>
                    <div class="schedule-notes">
                        <span class="note-best">{{ store.best_note }}</span>
                    </div>
                    <div class="schedule-links">
                        {% for link in store.machine_links %}
                        <a href="{{ url_for('recommend', store_key=link.store_key) }}" class="schedule-machine-link">{{ link.icon }} {{ link.short_name }}</a>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </section>

        </main>

        <!-- ã€Œæ›œæ—¥ã®å‚¾å‘ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€Œåº—èˆ—åˆ¥æ›œæ—¥å‚¾å‘ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã«çµ±åˆæ¸ˆã¿ -->

        <footer>
            <p><a href="{{ url_for('verify') }}" class="footer-link">çš„ä¸­çµæœ</a></p>
            <p class="build-time">ãƒ“ãƒ«ãƒ‰: {{ build_time }}</p>
        </footer>
    </div>
    <script src="{{ url_for('static', filename='realtime.js') }}"></script>
    <script>
    function filterSA(type, value) {
        var cards = document.querySelectorAll('.sa-rec-card');
        var btns = document.querySelectorAll('.sa-filter-btn');
        btns.forEach(function(b) { b.classList.remove('active'); });
        event.target.classList.add('active');
        var storeKeys = value ? value.split(',') : [];
        cards.forEach(function(c) {
            if (type === 'all') {
                c.style.display = '';
            } else if (type === 'machine') {
                c.style.display = c.dataset.machine === value ? '' : 'none';
            } else if (type === 'store') {
                c.style.display = storeKeys.indexOf(c.dataset.store) >= 0 ? '' : 'none';
            }
        });
    }
    function toggleHitDetail(e, el) {
        e.preventDefault();
        e.stopPropagation();
        var panel = el.nextElementSibling;
        if (panel && panel.classList.contains('hit-detail-panel')) {
            var isHidden = panel.style.display === 'none' || !panel.style.display;
            panel.style.display = isHidden ? 'block' : 'none';
            var icon = el.querySelector('.expand-icon');
            if (icon) icon.textContent = isHidden ? 'â–²' : 'â–¼';
        }
    }
    function toggleRecentDayDetail(e, el) {
        e.preventDefault();
        e.stopPropagation();
        var detail = el.nextElementSibling;
        if (!detail || !detail.classList.contains('recent-day-detail')) return;
        var icon = el.querySelector('.expand-icon');
        var isHidden = detail.classList.contains('hidden');
        if (isHidden) {
            detail.classList.remove('hidden');
            if (icon) icon.textContent = 'â–²';
        } else {
            detail.classList.add('hidden');
            if (icon) icon.textContent = 'â–¼';
        }
    }
    function toggleYesterdayHistory(e, el) {
        e.preventDefault();
        e.stopPropagation();
        var panel = el.nextElementSibling;
        if (!panel) return;
        var arrow = el.querySelector('.yh-toggle-arrow');
        var isHidden = panel.classList.contains('hidden');
        if (isHidden) {
            panel.classList.remove('hidden');
            if (arrow) arrow.textContent = 'â–²';
            el.classList.add('active');
        } else {
            panel.classList.add('hidden');
            if (arrow) arrow.textContent = 'â–¼';
            el.classList.remove('active');
        }
    }

    {% include '_common_js.html' %}
    </script>
</body>
</html>
