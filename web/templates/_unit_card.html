{# === å°ã‚«ãƒ¼ãƒ‰å…±é€šãƒã‚¯ãƒ­ === #}

{% macro unit_compact(rec, loop_index, show_store=true, store_key='') %}
{# ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªå°ã‚«ãƒ¼ãƒ‰ï¼ˆ3æ—¥é–“ãƒ‡ãƒ¼ã‚¿ + æ ¹æ‹ ï¼‰ #}
<div class="unit-card-v2 rank-{{ rec.final_rank|lower }}" onclick="toggleDetails(this)">
    {# ãƒ˜ãƒƒãƒ€ãƒ¼: å°ç•ªå· + åº—èˆ— + ãƒ©ãƒ³ã‚¯ #}
    <div class="v2-header">
        <span class="v2-rank-num">#{{ loop_index }}</span>
        <a href="{{ url_for('unit_history', store_key=(rec.store_key or store_key), unit_id=rec.unit_id) }}" class="v2-unit-id" onclick="event.stopPropagation()">{{ rec.unit_id|pad_id }}ç•ªå°</a>
        {% if rec.machine_name %}<span class="v2-machine">{{ rec.machine_name }}</span>{% endif %}
        {% if show_store %}
        <a href="{{ url_for('recommend', store_key=(rec.store_key or store_key)) }}" class="v2-store" onclick="event.stopPropagation()">{{ rec.store_name }}</a>
        {% endif %}
        <span class="v2-rank" style="background-color: {{ rank_color(rec.final_rank) }}">{{ rec.final_rank }}</span>
        <span class="expand-icon small">â–¼</span>
    </div>

    {# æ ¹æ‹ ï¼ˆä¸€ç•ªç›®ç«‹ã¤ä½ç½®ï¼‰ #}
    {% if rec.reasons %}
    <div class="v2-reason">{{ rec.reasons[0]|safe }}</div>
    {% endif %}

    {# ç›´è¿‘3æ—¥é–“ãƒ‡ãƒ¼ã‚¿ #}
    <div class="v2-days">
        {% if rec.yesterday_art %}
        <div class="v2-day">
            <span class="v2-day-label">{{ short_date(rec.yesterday_date) or 'å‰æ—¥' }}</span>
            <span class="v2-day-art">ART {{ rec.yesterday_art }}</span>
            {% if rec.yesterday_rb %}<span class="v2-day-rb">RB {{ rec.yesterday_rb }}</span>{% endif %}
            {% if rec.yesterday_prob %}<span class="v2-day-prob {% if rec.yesterday_prob <= 100 %}excellent{% elif rec.yesterday_prob <= 130 %}good{% elif rec.yesterday_prob >= 200 %}bad{% endif %}">1/{{ rec.yesterday_prob|int }}</span>{% endif %}
            {% if rec.yesterday_diff_medals is defined and rec.yesterday_diff_medals and rec.yesterday_diff_medals != 0 %}<span class="diff-medals-sm {% if rec.yesterday_diff_medals > 0 %}plus{% else %}minus{% endif %}">{{ '{:+,}'.format(rec.yesterday_diff_medals) }}æš</span>{% endif %}
            {% if rec.yesterday_max_medals and rec.yesterday_max_medals >= 500 %}<span class="max-medals-sm">æœ€å¤§{{ '{:,}'.format(rec.yesterday_max_medals) }}æš</span>{% endif %}
            {% if rec.yesterday_max_rensa and rec.yesterday_max_rensa >= 3 %}<span class="rensa-sm">{{ rec.yesterday_max_rensa }}é€£</span>{% endif %}
            {% if rec.yesterday_low_activity %}<span class="low-activity">â€»ä½ç¨¼åƒ</span>{% endif %}
        </div>
        {% else %}
        <div class="v2-day no-data"><span class="v2-day-label">å‰æ—¥</span> ãƒ‡ãƒ¼ã‚¿ãªã—</div>
        {% endif %}

        {% if rec.day_before_art %}
        <div class="v2-day">
            <span class="v2-day-label">{{ short_date(rec.day_before_date) or 'å‰ã€…æ—¥' }}</span>
            <span class="v2-day-art">ART {{ rec.day_before_art }}</span>
            {% if rec.day_before_rb %}<span class="v2-day-rb">RB {{ rec.day_before_rb }}</span>{% endif %}
            {% if rec.day_before_prob %}<span class="prev-prob {% if rec.day_before_prob <= 100 %}excellent{% elif rec.day_before_prob <= 130 %}good{% elif rec.day_before_prob >= 200 %}bad{% endif %}">1/{{ rec.day_before_prob|int }}</span>{% endif %}
            {% if rec.day_before_diff_medals is defined and rec.day_before_diff_medals and rec.day_before_diff_medals != 0 %}<span class="diff-medals-sm {% if rec.day_before_diff_medals > 0 %}plus{% else %}minus{% endif %}">{{ '{:+,}'.format(rec.day_before_diff_medals) }}æš</span>{% endif %}
            {% if rec.day_before_max_medals and rec.day_before_max_medals >= 500 %}<span class="max-medals-sm">æœ€å¤§{{ '{:,}'.format(rec.day_before_max_medals) }}æš</span>{% endif %}
            {% if rec.day_before_max_rensa and rec.day_before_max_rensa >= 3 %}<span class="rensa-sm">{{ rec.day_before_max_rensa }}é€£</span>{% endif %}
            {% if rec.day_before_low_activity %}<span class="low-activity">â€»ä½ç¨¼åƒ</span>{% endif %}
        </div>
        {% else %}
        <div class="v2-day no-data"><span class="v2-day-label">å‰ã€…æ—¥</span> ãƒ‡ãƒ¼ã‚¿ãªã—</div>
        {% endif %}

        {% if rec.three_days_ago_art %}
        <div class="v2-day">
            <span class="v2-day-label">{{ short_date(rec.three_days_ago_date) or '3æ—¥å‰' }}</span>
            <span class="v2-day-art">ART {{ rec.three_days_ago_art }}</span>
            {% if rec.three_days_ago_rb %}<span class="v2-day-rb">RB {{ rec.three_days_ago_rb }}</span>{% endif %}
            {% if rec.three_days_ago_prob %}<span class="prev-prob {% if rec.three_days_ago_prob <= 100 %}excellent{% elif rec.three_days_ago_prob <= 130 %}good{% elif rec.three_days_ago_prob >= 200 %}bad{% endif %}">1/{{ rec.three_days_ago_prob|int }}</span>{% endif %}
            {% if rec.three_days_ago_diff_medals is defined and rec.three_days_ago_diff_medals and rec.three_days_ago_diff_medals != 0 %}<span class="diff-medals-sm {% if rec.three_days_ago_diff_medals > 0 %}plus{% else %}minus{% endif %}">{{ '{:+,}'.format(rec.three_days_ago_diff_medals) }}æš</span>{% endif %}
            {% if rec.three_days_ago_max_medals and rec.three_days_ago_max_medals >= 500 %}<span class="max-medals-sm">æœ€å¤§{{ '{:,}'.format(rec.three_days_ago_max_medals) }}æš</span>{% endif %}
            {% if rec.three_days_ago_max_rensa and rec.three_days_ago_max_rensa >= 3 %}<span class="rensa-sm">{{ rec.three_days_ago_max_rensa }}é€£</span>{% endif %}
            {% if rec.three_days_ago_low_activity %}<span class="low-activity">â€»ä½ç¨¼åƒ</span>{% endif %}
        </div>
        {% else %}
        <div class="v2-day no-data"><span class="v2-day-label">3æ—¥å‰</span> ãƒ‡ãƒ¼ã‚¿ãªã—</div>
        {% endif %}
    </div>

    {# è¨­å®šæ¨å®šï¼ˆã‚ã‚Œã°ï¼‰ #}
    {% if rec.total_games >= 1000 and rec.estimated_setting %}
    <div class="v2-setting">
        <span class="setting-badge-sm setting-{{ rec.setting_num|default(0) }}">{{ rec.estimated_setting }}{% if rec.total_games < 3000 %}ï¼Ÿ{% endif %}</span>
    </div>
    {% endif %}

    {# å±•é–‹æ™‚ã®è©³ç´° #}
    <div class="unit-details hidden">
        <div class="v2-detail-reasons">
            {% for reason in rec.reasons %}
            <div class="reason-item">{{ reason }}</div>
            {% endfor %}
        </div>
        {% if rec.total_games > 0 %}
        <div class="v2-detail-today">
            æœ¬æ—¥: ART {{ rec.art_count }} / RB {{ rec.rb_count }} / {{ '{:,}'.format(rec.total_games) }}G
            {% if rec.art_prob > 0 %} / 1/{{ rec.art_prob|int }}{% endif %}
            {% if rec.max_medals and rec.max_medals > 0 %} / æœ€å¤§{{ '{:,}'.format(rec.max_medals) }}æš{% endif %}
        </div>
        {% endif %}
        {# æœ¬æ—¥ã®å½“ãŸã‚Šå±¥æ­´ï¼ˆå–¶æ¥­ä¸­ï¼‰ #}
        {% if rec.today_history and rec.today_history|length > 0 %}
        <div class="v2-today-history">
            <div class="history-header">ğŸ“Š æœ¬æ—¥ã®å½“ãŸã‚Šå±¥æ­´</div>
            <div class="history-list">
                {% for h in rec.today_history[:20] %}
                <div class="history-item {% if h.medals >= 1000 %}big-hit{% elif h.medals >= 500 %}medium-hit{% endif %}">
                    <span class="hit-num">#{{ h.hit_num }}</span>
                    <span class="hit-time">{{ h.time }}</span>
                    <span class="hit-start">{{ h.start }}G</span>
                    <span class="hit-medals {% if h.medals >= 1000 %}big{% elif h.medals >= 500 %}medium{% endif %}">{{ h.medals }}æš</span>
                    {% if h.rensa %}<span class="hit-rensa">{{ h.rensa }}é€£</span>{% endif %}
                </div>
                {% endfor %}
                {% if rec.today_history|length > 20 %}
                <div class="history-more">...ä»–{{ rec.today_history|length - 20 }}ä»¶</div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        <div class="v2-detail-trend">
            {% if rec.consecutive_minus >= 2 %}
            {{ rec.consecutive_minus }}æ—¥é€£ç¶šä¸èª¿ â†’ è¨­å®šä¸Šã’ã®å¯èƒ½æ€§ã‚ã‚Š
            {% elif rec.consecutive_plus >= 3 %}
            {{ rec.consecutive_plus }}æ—¥é€£ç¶šå¥½èª¿ â†’ æ®ãˆç½®ã or è»¢è½è­¦æˆ’
            {% elif rec.consecutive_plus >= 2 %}
            2æ—¥é€£ç¶šå¥½èª¿ â†’ æ®ãˆç½®ãæœŸå¾…
            {% else %}
            è“„ç©å‚¾å‘: {{ rec.base_rank }}ãƒ©ãƒ³ã‚¯
            {% endif %}
        </div>
    </div>
</div>
{% endmacro %}
